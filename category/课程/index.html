
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/category/%E8%AF%BE%E7%A8%8B/">
      
      
        <link rel="prev" href="../%E8%AE%BE%E5%A4%87/">
      
      
        <link rel="next" href="../%E9%98%85%E8%AF%BB/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>课程 - Rain的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#课程" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Rain的随笔" class="md-header__button md-logo" aria-label="Rain的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              课程
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../archive/2024/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../homelab/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Rain的随笔" class="md-nav__button md-logo" aria-label="Rain的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Rain的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../homelab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    homelab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何实现网络自由
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    学习
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E6%8A%98%E8%85%BE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    折腾
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E6%9D%82%E6%96%87/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    杂文
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E8%99%9A%E6%8B%9F%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚拟化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E8%AE%BE%E5%A4%87/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    设备
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    课程
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    课程
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#具体数学" class="md-nav__link">
    <span class="md-ellipsis">
      具体数学
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ucore-mips-代码分析" class="md-nav__link">
    <span class="md-ellipsis">
      ucore-mips 代码分析
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ucore-lab3-总结" class="md-nav__link">
    <span class="md-ellipsis">
      ucore lab3 总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ucore-lab2总结" class="md-nav__link">
    <span class="md-ellipsis">
      ucore lab2总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#编译原理总结" class="md-nav__link">
    <span class="md-ellipsis">
      编译原理总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第7章-作业-死锁" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第7章 作业 死锁
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第六章作业-进程同步" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第六章作业 进程同步
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第五章作业-cpu调度" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第五章作业 CPU调度
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第三章-作业" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第三章 作业
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第三章-作业" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第三章 作业
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第二章-作业" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第二章 作业
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#操作系统第一章-作业" class="md-nav__link">
    <span class="md-ellipsis">
      操作系统第一章 作业
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#计算机组成原理-第一章作业" class="md-nav__link">
    <span class="md-ellipsis">
      计算机组成原理 第一章作业
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    阅读
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="课程">课程<a class="headerlink" href="#课程" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2023-04-20 16:22:00">2023年4月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 31 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="具体数学"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2023/04/20/2023-04-20-%E5%85%B7%E4%BD%93%E6%95%B0%E5%AD%A6/">具体数学</a></h2>
<h3 id="具体数学公式小册子"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2023/04/20/2023-04-20-%E5%85%B7%E4%BD%93%E6%95%B0%E5%AD%A6/#具体数学公式小册子">具体数学公式小册子</a></h3>
<p>推广一个自己的github仓库，期望共同完善。
阅读具体数学电子书籍时，由于经常需要查看某个编号的公式因此产生了这个项目，用于阅读时查阅公式
https://github.com/TheRainstorm/concrete_math_formulas</p>
<h3 id="成套方法"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2023/04/20/2023-04-20-%E5%85%B7%E4%BD%93%E6%95%B0%E5%AD%A6/#成套方法">成套方法</a></h3>
<p>在具体数学(Concrete Mathematics)课本中，在解约瑟夫递推方程时，第一次介绍了成套方法(repertoire method)。之后也使用这种方式求解各种递推方程。相信很多人第一次看到这种方法时都会感觉到不可思议——还能这样？虽然每一步都能看懂，但是就是不知道这种方法是怎么想到的。在查阅了一点资料后，我对该方法有了更多的认识。先说明一点，该方法并不是一种万能方法，实际上要求问题要有线性结构。</p>
<p>参考：<a href="https://math.stackexchange.com/questions/1017498/mathematical-explanation-for-the-repertoire-method">linear algebra - Mathematical explanation for the Repertoire Method - Mathematics Stack Exchange</a></p>

    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2023/04/20/2023-04-20-%E5%85%B7%E4%BD%93%E6%95%B0%E5%AD%A6/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-04-06 22:51:13">2021年4月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 15 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-mips-代码分析"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">ucore-mips 代码分析</a></h2>
<div class="toc">
<ul>
<li><a href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#ucore-mips-代码分析">ucore-mips 代码分析</a></li>
</ul>
</div>
<h4 id="1-makefile"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#1-makefile">1. Makefile</a></h4>
<ol>
<li><code>boot/loader.bin</code>基本就是一个读取elf的函数，我们上板使用pmon加载ucore，因此用不到。</li>
<li><code>obj/ucore-kernel-initrd</code>是一个elf文件，特殊之处在于，它的data段包含<code>user/_archive</code>目录下的文件（包含一个test.txt）和<code>$(USER_APP_BINS)</code>（如sh, ls等用户程序）的内容。<strong>将内核和文件系统打包到了一起</strong>。</li>
</ol>
<h4 id="2-kernel_entry"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#2-kernel_entry">2. kernel_entry</a></h4>
<p>kern/init/entry.S</p>
<ol>
<li>设置了$gp</li>
</ol>
<p>定义在链接脚本里，可以通过<code>readelf obj/ucore-kernel-initrd -a|grep _gp</code>来查看其值。参考值（修改了代码编译出的值可能不一样）<code>0x800c7f40</code></p>
<ol>
<li>设置了$sp，启动时用的栈，栈大小为<code>KSTACKSIZE</code>，8KB</li>
</ol>
<p>参考值：<code>bootstacktop(0x80068730)</code>，<code>bootstack(0x80066730)</code></p>
<ol>
<li>设置了Ebase为<code>__exception_vector</code>。参考值：<code>0x8002b000</code>。__exception_vector包含了各异常向量地址的入口。</li>
</ol>
<h4 id="3-kern_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#3-kern_init">3. kern_init</a></h4>
<p>kern/int/init.c</p>
<h5 id="杂项"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#杂项">杂项</a></h5>
<h6 id="tlb_invalidate_all"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#tlb_invalidate_all">tlb_invalidate_all</a></h6>
<p>定义于kern/include/thumips_tlb.h和kern/mm/thumips_tlb.c</p>
<p>tlb_invalidata_all循环调用write_one_tlb清空tlb表项
<strong>默认tlb有128项</strong>，虽然不会导致错误，但是可以优化</p>
<h6 id="pic_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pic_init">pic_init</a></h6>
<p>定义于kern/driver/picirq.c
pic_init -&gt; write_c0_status
将Statu中的IM域全置0，关闭所有中断。
之后可以通过pic_enable(int irq)或pic_disable(int irq)开关中断</p>
<h6 id="cons_init--clock_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#cons_init--clock_init">cons_init &amp; clock_init</a></h6>
<p>一个初始化串口，一个初始化时钟中断。</p>
<p>相关宏定义于/kern/include/thumips.h</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#__codelineno-76-1"></a><span class="cp">#define COM1_IRQ        3</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#__codelineno-76-2"></a><span class="cp">#define TIMER0_IRQ       7</span>
</span></code></pre></div>
<p>clock需要用到<code>cp0_count</code>和<code>cp0_compare</code>
设置clock中断后，每<code>clock.c::TIMER0_INTERVAL</code>=1000000后会产生一个时钟中断</p>
<h6 id="check_initrd"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_initrd">check_initrd</a></h6>
<p>检查内核是否有initrd，通过判断是否_initrd_begin == _initrd_end)</p>
<h5 id="kprintf"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kprintf">kprintf</a></h5>
<p>内核第一次输出信息</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#__codelineno-77-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;(THU.CST) os is loading ...</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2" href="#__codelineno-77-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span></code></pre></div>
<p>kprintf函数最后调用串口的cons_putc输出字符。串口输出字符采用忙等待方式。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#__codelineno-78-1"></a><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">kprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vkprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">printfmt</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vprintfmt</span><span class="p">(</span><span class="n">cputch</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2" href="#__codelineno-78-2"></a>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3" href="#__codelineno-78-3"></a><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cputch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">driver</span><span class="o">/</span><span class="n">console</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cons_putc</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#__codelineno-79-1"></a><span class="cp">#!kern/driver/console.c</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2" href="#__codelineno-79-2"></a>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3" href="#__codelineno-79-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4" href="#__codelineno-79-4"></a><span class="nf">serial_putc_sub</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5" href="#__codelineno-79-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COM_LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">COM_LSR_TXRDY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6" href="#__codelineno-79-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7" href="#__codelineno-79-7"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COM_TX</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8" href="#__codelineno-79-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>作为对比，用户程序cprintf</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#__codelineno-80-1"></a><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vcprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vprintfmt</span><span class="p">(</span><span class="n">cputch</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2" href="#__codelineno-80-2"></a><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cputch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">sys_putc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">syscall</span><span class="p">(</span><span class="n">SYS_putc</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3" href="#__codelineno-80-3"></a><span class="n">系统调用</span><span class="err">，</span><span class="n">进入内核</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4" href="#__codelineno-80-4"></a><span class="n">异常处理程序调用kern</span><span class="o">/</span><span class="n">syscall</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">sys_putc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">kputchar</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons_putc</span>
</span></code></pre></div>
<p><strong>用户程序输出每一个字符都会触发一次系统调用</strong></p>
<h5 id="pmm_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pmm_init">pmm_init</a></h5>
<h6 id="page结构体"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page结构体">page结构体</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#__codelineno-81-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#__codelineno-81-2"></a><span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">ref</span><span class="p">;</span><span class="w">                   </span><span class="c1">// page frame&#39;s reference counter</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3" href="#__codelineno-81-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                 </span><span class="c1">// array of flags that describe the status of the page frame</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4" href="#__codelineno-81-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">property</span><span class="p">;</span><span class="w">          </span><span class="c1">// used in buddy system, stores the order (the X in 2^X) of the continuous memory block</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5" href="#__codelineno-81-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">zone_num</span><span class="p">;</span><span class="w">                   </span><span class="c1">// used in buddy system, the No. of zone which the page belongs to</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6" href="#__codelineno-81-6"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">page_link</span><span class="p">;</span><span class="w">         </span><span class="c1">// free list link</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7" href="#__codelineno-81-7"></a><span class="c1">//    swap_entry_t index;             // stores a swapped-out page identifier</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8" href="#__codelineno-81-8"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">swap_link</span><span class="p">;</span><span class="w">         </span><span class="c1">// swap hash link</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9" href="#__codelineno-81-9"></a><span class="p">};</span>
</span></code></pre></div>
<p>ucore将物理内存划分成一个一个的页，并使用Page结构体数组来管理。一个Page项对应一个物理页。</p>
<p>参考pmm.c::page_init代码</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#__codelineno-82-1"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;memory map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#__codelineno-82-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;    [&quot;</span><span class="p">);</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#__codelineno-82-3"></a><span class="n">printhex</span><span class="p">(</span><span class="n">KERNBASE</span><span class="p">);</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#__codelineno-82-4"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#__codelineno-82-5"></a><span class="n">printhex</span><span class="p">(</span><span class="n">KERNTOP</span><span class="p">);</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#__codelineno-82-6"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#__codelineno-82-7"></a>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#__codelineno-82-8"></a><span class="n">maxpa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNTOP</span><span class="p">;</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#__codelineno-82-9"></a><span class="n">npage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KMEMSIZE</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">;</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#__codelineno-82-10"></a>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#__codelineno-82-11"></a><span class="c1">// end address of kernel</span>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#__codelineno-82-12"></a><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">end</span><span class="p">[];</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#__codelineno-82-13"></a><span class="c1">// put page structure table at the end of kernel</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#__codelineno-82-14"></a><span class="n">pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ROUNDUP_2N</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div>
<p><code>KMEMSIZE</code>代表内核管理的物理内存的大小，npage计算出来为物理页的个数。</p>
<p>end在链接脚本中定义，为ucore-kernel-initrd的结尾。即ucore在内核的结尾分配了（直接写）Page数组的空间，pages为数组的起始地址。</p>
<p>此时page项可以和物理页一一对应起来了</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#__codelineno-83-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">ppn_t</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#__codelineno-83-2"></a><span class="nf">page2ppn</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#__codelineno-83-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#__codelineno-83-4"></a><span class="p">}</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#__codelineno-83-5"></a>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#__codelineno-83-6"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uintptr_t</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#__codelineno-83-7"></a><span class="nf">page2pa</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#__codelineno-83-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KERNBASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">page2ppn</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#__codelineno-83-9"></a><span class="p">}</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#__codelineno-83-10"></a>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#__codelineno-83-11"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#__codelineno-83-12"></a><span class="n">pa2page</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#__codelineno-83-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PPN</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">npage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14" href="#__codelineno-83-14"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;pa2page called with invalid pa&quot;</span><span class="p">);</span>
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15" href="#__codelineno-83-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-83-16"><a id="__codelineno-83-16" name="__codelineno-83-16" href="#__codelineno-83-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pages</span><span class="p">[</span><span class="n">PPN</span><span class="p">(</span><span class="n">pa</span><span class="p">)];</span>
</span><span id="__span-83-17"><a id="__codelineno-83-17" name="__codelineno-83-17" href="#__codelineno-83-17"></a><span class="p">}</span>
</span><span id="__span-83-18"><a id="__codelineno-83-18" name="__codelineno-83-18" href="#__codelineno-83-18"></a>
</span><span id="__span-83-19"><a id="__codelineno-83-19" name="__codelineno-83-19" href="#__codelineno-83-19"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-83-20"><a id="__codelineno-83-20" name="__codelineno-83-20" href="#__codelineno-83-20"></a><span class="n">page2kva</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-21"><a id="__codelineno-83-21" name="__codelineno-83-21" href="#__codelineno-83-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KADDR</span><span class="p">(</span><span class="n">page2pa</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
</span><span id="__span-83-22"><a id="__codelineno-83-22" name="__codelineno-83-22" href="#__codelineno-83-22"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里强调一下<code>page2kva</code>中<code>KADDR</code>的作用，事实上如果看其定义的话，KADDR(pa)的值和pa是一样的，如下</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#__codelineno-84-1"></a><span class="cm">/* *</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#__codelineno-84-2"></a><span class="cm"> * PADDR - takes a kernel virtual address (an address that points above KERNBASE),</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#__codelineno-84-3"></a><span class="cm"> * where the machine&#39;s maximum 256MB of physical memory is mapped and returns the</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#__codelineno-84-4"></a><span class="cm"> * corresponding physical address.  It panics if you pass it a non-kernel virtual address.</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#__codelineno-84-5"></a><span class="cm"> * */</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#__codelineno-84-6"></a><span class="cp">#define PADDR(kva) ({                                                   \</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#__codelineno-84-7"></a><span class="cp">            uintptr_t __m_kva = (uintptr_t)(kva);                       \</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8" href="#__codelineno-84-8"></a><span class="cp">            if (__m_kva &lt; KERNBASE) {                                   \</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9" href="#__codelineno-84-9"></a><span class="cp">                panic(&quot;PADDR called with invalid kva %08lx&quot;, __m_kva);  \</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10" href="#__codelineno-84-10"></a><span class="cp">            }                                                           \</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11" href="#__codelineno-84-11"></a><span class="cp">            __m_kva ;                                         \</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12" href="#__codelineno-84-12"></a><span class="cp">        })</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13" href="#__codelineno-84-13"></a>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14" href="#__codelineno-84-14"></a><span class="cm">/* *</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15" href="#__codelineno-84-15"></a><span class="cm"> * KADDR - takes a physical address and returns the corresponding kernel virtual</span>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16" href="#__codelineno-84-16"></a><span class="cm"> * address. It panics if you pass an invalid physical address.</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17" href="#__codelineno-84-17"></a><span class="cm"> * */</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18" href="#__codelineno-84-18"></a><span class="cp">#define KADDR(pa) ({                                                    \</span>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19" href="#__codelineno-84-19"></a><span class="cp">            uintptr_t __m_pa = (pa);                                    \</span>
</span><span id="__span-84-20"><a id="__codelineno-84-20" name="__codelineno-84-20" href="#__codelineno-84-20"></a><span class="cp">            size_t __m_ppn = PPN(__m_pa);                               \</span>
</span><span id="__span-84-21"><a id="__codelineno-84-21" name="__codelineno-84-21" href="#__codelineno-84-21"></a><span class="cp">            if (__m_ppn &gt;= npage) {                                     \</span>
</span><span id="__span-84-22"><a id="__codelineno-84-22" name="__codelineno-84-22" href="#__codelineno-84-22"></a><span class="cp">                panic(&quot;KADDR called with invalid pa %08lx&quot;, __m_pa);    \</span>
</span><span id="__span-84-23"><a id="__codelineno-84-23" name="__codelineno-84-23" href="#__codelineno-84-23"></a><span class="cp">            }                                                           \</span>
</span><span id="__span-84-24"><a id="__codelineno-84-24" name="__codelineno-84-24" href="#__codelineno-84-24"></a><span class="cp">            (void *) (__m_pa);                               \</span>
</span><span id="__span-84-25"><a id="__codelineno-84-25" name="__codelineno-84-25" href="#__codelineno-84-25"></a><span class="cp">        })</span>
</span></code></pre></div>
<p>而之所以需要进行一次转换，主要是保持逻辑上的一致性。因为CPU直接发出的地址都是虚拟地址，会经过MMU进行虚拟地址转换（一般基于TLB，而TLB基于操作系统管理的页表）。整个转换过程是硬件自动完成的，因此软件基本不用和物理地址打交道（操作系统中涉及到和硬件软硬件协同的部分会涉及到物理地址，如页表中存储的地址是物理地址，当MIPS中tlb refill异常时，便会读取页表项加载到TLB表项中）</p>
<p>因而我们在代码中访问数据时都要使用虚拟地址。</p>
<p>因为这里的整个内核虚拟空间（<code>[KERNBASE, KERNBASE+KMEMSIZE]=[0x8000_0000, 0x8200_0000)</code>）都位于MIPS中的kseg0段，而该段采用固定地址映射的方式，而不使用TLB，因此内核访问整个内核虚拟地址空间丝毫不用担心。</p>
<h6 id="这里应该有一个错误"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#这里应该有一个错误">这里应该有一个错误</a></h6>
<p>按照定义来说，page2pa就应该是(page2ppn(page) &lt;&lt; PGSHIFT)，加了KERNBASE后反而是虚拟地址了。</p>
<p>不过因为KADDR也错了，因此当我们分配了一个空闲物理页page后，要获得其虚拟地址</p>
<p><code>KADDR(page2pa(page))</code>反而没错了</p>
<h6 id="空闲页"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#空闲页">空闲页</a></h6>
<p>空闲地址开始于Page数组之后。init_memmap会调用pmm_manager的init_memmap函数，用于记录哪些页是空闲的。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#__codelineno-85-1"></a><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">freemem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PADDR</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">pages</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">npage</span><span class="p">);</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#__codelineno-85-2"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;freemem start at: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">freemem</span><span class="p">);</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#__codelineno-85-3"></a>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#__codelineno-85-4"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">freemem</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#__codelineno-85-5"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">KERNTOP</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#__codelineno-85-6"></a><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">mbegin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mend</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#__codelineno-85-7"></a><span class="n">init_memmap</span><span class="p">(</span><span class="n">pa2page</span><span class="p">(</span><span class="n">mbegin</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">mend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mbegin</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8" href="#__codelineno-85-8"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;free pages: &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mend</span><span class="o">-</span><span class="n">mbegin</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9" href="#__codelineno-85-9"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;## &quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="p">));</span>
</span></code></pre></div>
<h6 id="pmm_manager"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pmm_manager">pmm_manager</a></h6>
<p>物理内存管理其实就是要实现<strong>物理空闲页</strong>的分配和回收，ucore定义了pmm_manager的结构体，可以认为C中实现的类。</p>
<p>关键的两个函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#__codelineno-86-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_pages</span><span class="p">)(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2" href="#__codelineno-86-2"></a><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">free_pages</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div>
<p>alloc_pages从空闲页中分配了一段连续的空闲页</p>
<p>而free_pages则将指定的一段连续的页重新回收为空闲页</p>
<p>ucore代码实现了伙伴分配系统(buddy system)，可以参考其具体实现</p>
<h6 id="页表相关函数"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#页表相关函数">页表相关函数</a></h6>
<p>ucore实现了二级页表</p>
<p>关键函数</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#__codelineno-87-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="nf">get_pte</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">create</span><span class="p">);</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2" href="#__codelineno-87-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">get_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">**</span><span class="n">ptep_store</span><span class="p">);</span><span class="w">  </span><span class="c1">//根据pte的值获得对应的page</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3" href="#__codelineno-87-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">page_remove</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">);</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4" href="#__codelineno-87-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">page_insert</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5" href="#__codelineno-87-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="get_pte"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#get_pte">get_pte</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#__codelineno-88-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_pte</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">create</span><span class="p">)</span>
</span></code></pre></div>
<p>函数作用：给定页目录表的虚拟地址，查找虚拟地址la对应的页表项pte。（只要la在一个页内，返回的pte是相同的）
    注：获得的是pte项的<strong>虚拟地址</strong>
过程：</p>
<ol>
<li>先计算页目录表中对应pde表项的虚拟地址</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1" href="#__codelineno-89-1"></a><span class="n">pdep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PDX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>如果pde项有效，即<code>((*pdep)&amp;PTE_P) == 0</code>。直接访问pde获得la对应二级页表的物理地址。</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1" href="#__codelineno-90-1"></a><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>计算二级页表中对应页表项pte的<strong>物理</strong>地址</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1" href="#__codelineno-91-1"></a><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)(</span><span class="w">    </span><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">)</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PTX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>转换成虚拟地址</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1" href="#__codelineno-92-1"></a><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)</span><span class="n">KADDR</span><span class="p">(</span><span class="w">   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="w">  </span><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)(</span><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">))</span><span class="o">+</span><span class="n">PTX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>如果02中无效，则需要根据create决定是否创建二级页表。（下面代码只考虑了创建情形，并为了突出重点，删减了许多有用的代码）</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1" href="#__codelineno-93-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="o">*</span><span class="w"> </span><span class="n">new_pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2" href="#__codelineno-93-2"></a>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3" href="#__codelineno-93-3"></a><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">page2kva</span><span class="p">(</span><span class="n">new_pte</span><span class="p">);</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4" href="#__codelineno-93-4"></a><span class="o">*</span><span class="n">pdep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PADDR</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
</span></code></pre></div>
<p>最后一行，页表中存储的是物理地址。然而根据之前的分析，我们知道上面代码中的PADDR(pa)实际上是虚拟地址。然而我们发现在这样设置之后，下次调用get_pte时，获得的pte的地址确实是虚拟地址（KADDR不产生作用）。</p>
<h6 id="page_insert"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page_insert">page_insert</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1" href="#__codelineno-94-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">page_insert</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
</span></code></pre></div>
<p>作用：将虚拟地址la映射到page对应的物理页上</p>
<p>步骤：</p>
<ol>
<li>
<p>根据虚拟地址la查找到二级页表项ptep</p>
</li>
<li>
<p>如果原本ptep已经映射到另一个物理页上了，则删除该映射（有可能导致回收物理页）</p>
</li>
<li>
<p>设置ptep映射到新物理页</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1" href="#__codelineno-95-1"></a>*ptep = page2pa(page) | PTE_P | perm;
</span></code></pre></div>
<p>由以上代码，可以看到二级页表项中存储的地址其实是虚拟地址。</p>
<h6 id="page_remove"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page_remove">page_remove</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-96-1"><a id="__codelineno-96-1" name="__codelineno-96-1" href="#__codelineno-96-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">page_remove</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></code></pre></div>
<p>作用：解除pgdir中虚拟地址la的映射</p>
<p>步骤：</p>
<ol>
<li>获得pte</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-97-1"><a id="__codelineno-97-1" name="__codelineno-97-1" href="#__codelineno-97-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>如果<code>ptep != NULL</code>且<code>*ptep &amp; PTE_P</code>，</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-98-1"><a id="__codelineno-98-1" name="__codelineno-98-1" href="#__codelineno-98-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte2page</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
</span><span id="__span-98-2"><a id="__codelineno-98-2" name="__codelineno-98-2" href="#__codelineno-98-2"></a><span class="n">page_ref_dec</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span><span id="__span-98-3"><a id="__codelineno-98-3" name="__codelineno-98-3" href="#__codelineno-98-3"></a><span class="c1">// and free it when reach 0</span>
</span><span id="__span-98-4"><a id="__codelineno-98-4" name="__codelineno-98-4" href="#__codelineno-98-4"></a><span class="k">if</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-98-5"><a id="__codelineno-98-5" name="__codelineno-98-5" href="#__codelineno-98-5"></a><span class="w">    </span><span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span><span id="__span-98-6"><a id="__codelineno-98-6" name="__codelineno-98-6" href="#__codelineno-98-6"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>清除映射</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-99-1"><a id="__codelineno-99-1" name="__codelineno-99-1" href="#__codelineno-99-1"></a><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<h6 id="pgdir_alloc_page"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pgdir_alloc_page">pgdir_alloc_page</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-100-1"><a id="__codelineno-100-1" name="__codelineno-100-1" href="#__codelineno-100-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
</span></code></pre></div>
<p>作用：该函数分配一个物理页，并将la对应的虚拟页，映射到该物理页</p>
<h6 id="check"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check">check</a></h6>
<h6 id="check_pgdir"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_pgdir">check_pgdir</a></h6>
<ol>
<li>将虚拟地址0x0映射到一个物理页(随便分配一个page, p1)上。</li>
<li>将虚拟地址0x1000(PAGESIZE)映射到一个物理页(随便分配一个page, p2)。</li>
<li>将0x1000重新映射到p1.
   ......
   主要是检查了page_insert, page_remove等函数的正确性。</li>
</ol>
<h6 id="check_boot_pgdirtlb-refill处理"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_boot_pgdirtlb-refill处理">check_boot_pgdir（tlb refill处理)</a></h6>
<ol>
<li>分配一个物理页，并写入初始值</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-101-1"><a id="__codelineno-101-1" name="__codelineno-101-1" href="#__codelineno-101-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-101-2"><a id="__codelineno-101-2" name="__codelineno-101-2" href="#__codelineno-101-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-101-3"><a id="__codelineno-101-3" name="__codelineno-101-3" href="#__codelineno-101-3"></a><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x100</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">;</span>
</span></code></pre></div>
<ol>
<li>将两个虚拟页映射到该物理页上</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-102-1"><a id="__codelineno-102-1" name="__codelineno-102-1" href="#__codelineno-102-1"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_insert</span><span class="p">(</span><span class="n">boot_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-102-2"><a id="__codelineno-102-2" name="__codelineno-102-2" href="#__codelineno-102-2"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-102-3"><a id="__codelineno-102-3" name="__codelineno-102-3" href="#__codelineno-102-3"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_insert</span><span class="p">(</span><span class="n">boot_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-102-4"><a id="__codelineno-102-4" name="__codelineno-102-4" href="#__codelineno-102-4"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>直接使用虚拟地址访问该物理页，引发tlb refill异常</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-103-1"><a id="__codelineno-103-1" name="__codelineno-103-1" href="#__codelineno-103-1"></a><span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0x100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>进入对应异常处理程序</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-104-1"><a id="__codelineno-104-1" name="__codelineno-104-1" href="#__codelineno-104-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handle_tlbmiss</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="o">*</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">)</span>
</span><span id="__span-104-2"><a id="__codelineno-104-2" name="__codelineno-104-2" href="#__codelineno-104-2"></a><span class="p">{</span>
</span><span id="__span-104-3"><a id="__codelineno-104-3" name="__codelineno-104-3" href="#__codelineno-104-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">in_kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trap_in_kernel</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-104-4"><a id="__codelineno-104-4" name="__codelineno-104-4" href="#__codelineno-104-4"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">current_pgdir</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-104-5"><a id="__codelineno-104-5" name="__codelineno-104-5" href="#__codelineno-104-5"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">badaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">;</span>
</span><span id="__span-104-6"><a id="__codelineno-104-6" name="__codelineno-104-6" href="#__codelineno-104-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-104-7"><a id="__codelineno-104-7" name="__codelineno-104-7" href="#__codelineno-104-7"></a><span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">current_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-104-8"><a id="__codelineno-104-8" name="__codelineno-104-8" href="#__codelineno-104-8"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="o">==</span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ptep_invalid</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span><span class="w">   </span><span class="c1">//PTE miss, pgfault</span>
</span><span id="__span-104-9"><a id="__codelineno-104-9" name="__codelineno-104-9" href="#__codelineno-104-9"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;## pagefault in kernel, badaddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">);</span>
</span><span id="__span-104-10"><a id="__codelineno-104-10" name="__codelineno-104-10" href="#__codelineno-104-10"></a><span class="w">    </span><span class="c1">//tlb will not be refill in do_pgfault,</span>
</span><span id="__span-104-11"><a id="__codelineno-104-11" name="__codelineno-104-11" href="#__codelineno-104-11"></a><span class="w">    </span><span class="c1">//so a vmm pgfault will trigger 2 exception</span>
</span><span id="__span-104-12"><a id="__codelineno-104-12" name="__codelineno-104-12" href="#__codelineno-104-12"></a><span class="w">    </span><span class="c1">//permission check in tlb miss</span>
</span><span id="__span-104-13"><a id="__codelineno-104-13" name="__codelineno-104-13" href="#__codelineno-104-13"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgfault_handler</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">get_error_code</span><span class="p">(</span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">));</span>
</span><span id="__span-104-14"><a id="__codelineno-104-14" name="__codelineno-104-14" href="#__codelineno-104-14"></a><span class="w">  </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"> </span><span class="c1">//tlb miss only, reload it</span>
</span><span id="__span-104-15"><a id="__codelineno-104-15" name="__codelineno-104-15" href="#__codelineno-104-15"></a><span class="w">    </span><span class="cm">/* refill two slot */</span>
</span><span id="__span-104-16"><a id="__codelineno-104-16" name="__codelineno-104-16" href="#__codelineno-104-16"></a><span class="w">    </span><span class="cm">/* check permission */</span>
</span><span id="__span-104-17"><a id="__codelineno-104-17" name="__codelineno-104-17" href="#__codelineno-104-17"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">in_kernel</span><span class="p">){</span>
</span><span id="__span-104-18"><a id="__codelineno-104-18" name="__codelineno-104-18" href="#__codelineno-104-18"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;## tlb refill in kernel, badaddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">);</span>
</span><span id="__span-104-19"><a id="__codelineno-104-19" name="__codelineno-104-19" href="#__codelineno-104-19"></a><span class="w">      </span><span class="n">tlb_refill</span><span class="p">(</span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-104-20"><a id="__codelineno-104-20" name="__codelineno-104-20" href="#__codelineno-104-20"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-104-21"><a id="__codelineno-104-21" name="__codelineno-104-21" href="#__codelineno-104-21"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-104-22"><a id="__codelineno-104-22" name="__codelineno-104-22" href="#__codelineno-104-22"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptep_u_read</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span>
</span><span id="__span-104-23"><a id="__codelineno-104-23" name="__codelineno-104-23" href="#__codelineno-104-23"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-104-24"><a id="__codelineno-104-24" name="__codelineno-104-24" href="#__codelineno-104-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
</span><span id="__span-104-25"><a id="__codelineno-104-25" name="__codelineno-104-25" href="#__codelineno-104-25"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-104-26"><a id="__codelineno-104-26" name="__codelineno-104-26" href="#__codelineno-104-26"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ptep_u_write</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span>
</span><span id="__span-104-27"><a id="__codelineno-104-27" name="__codelineno-104-27" href="#__codelineno-104-27"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
</span><span id="__span-104-28"><a id="__codelineno-104-28" name="__codelineno-104-28" href="#__codelineno-104-28"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
</span><span id="__span-104-29"><a id="__codelineno-104-29" name="__codelineno-104-29" href="#__codelineno-104-29"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-104-30"><a id="__codelineno-104-30" name="__codelineno-104-30" href="#__codelineno-104-30"></a><span class="w">    </span><span class="c1">//kprintf(&quot;## refill U %d %08x\n&quot;, write, badaddr);</span>
</span><span id="__span-104-31"><a id="__codelineno-104-31" name="__codelineno-104-31" href="#__codelineno-104-31"></a><span class="w">      </span><span class="n">tlb_refill</span><span class="p">(</span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">);</span>
</span><span id="__span-104-32"><a id="__codelineno-104-32" name="__codelineno-104-32" href="#__codelineno-104-32"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-104-33"><a id="__codelineno-104-33" name="__codelineno-104-33" href="#__codelineno-104-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-104-34"><a id="__codelineno-104-34" name="__codelineno-104-34" href="#__codelineno-104-34"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-104-35"><a id="__codelineno-104-35" name="__codelineno-104-35" href="#__codelineno-104-35"></a>
</span><span id="__span-104-36"><a id="__codelineno-104-36" name="__codelineno-104-36" href="#__codelineno-104-36"></a><span class="nl">exit</span><span class="p">:</span>
</span><span id="__span-104-37"><a id="__codelineno-104-37" name="__codelineno-104-37" href="#__codelineno-104-37"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">){</span>
</span><span id="__span-104-38"><a id="__codelineno-104-38" name="__codelineno-104-38" href="#__codelineno-104-38"></a><span class="w">    </span><span class="n">print_trapframe</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-104-39"><a id="__codelineno-104-39" name="__codelineno-104-39" href="#__codelineno-104-39"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">in_kernel</span><span class="p">){</span>
</span><span id="__span-104-40"><a id="__codelineno-104-40" name="__codelineno-104-40" href="#__codelineno-104-40"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled pgfault&quot;</span><span class="p">);</span>
</span><span id="__span-104-41"><a id="__codelineno-104-41" name="__codelineno-104-41" href="#__codelineno-104-41"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-104-42"><a id="__codelineno-104-42" name="__codelineno-104-42" href="#__codelineno-104-42"></a><span class="w">      </span><span class="n">do_exit</span><span class="p">(</span><span class="o">-</span><span class="n">E_KILLED</span><span class="p">);</span>
</span><span id="__span-104-43"><a id="__codelineno-104-43" name="__codelineno-104-43" href="#__codelineno-104-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-104-44"><a id="__codelineno-104-44" name="__codelineno-104-44" href="#__codelineno-104-44"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-104-45"><a id="__codelineno-104-45" name="__codelineno-104-45" href="#__codelineno-104-45"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-104-46"><a id="__codelineno-104-46" name="__codelineno-104-46" href="#__codelineno-104-46"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>
<p>首先判断是否在内核中发生了异常，这里通过Status.KSU位来判断，2'b00表示kernel mode，2'b10表示user mode。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-105-1"><a id="__codelineno-105-1" name="__codelineno-105-1" href="#__codelineno-105-1"></a><span class="kt">bool</span>
</span><span id="__span-105-2"><a id="__codelineno-105-2" name="__codelineno-105-2" href="#__codelineno-105-2"></a><span class="nf">trap_in_kernel</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-105-3"><a id="__codelineno-105-3" name="__codelineno-105-3" href="#__codelineno-105-3"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KSU_USER</span><span class="p">);</span>
</span><span id="__span-105-4"><a id="__codelineno-105-4" name="__codelineno-105-4" href="#__codelineno-105-4"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>然后获得pte</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-106-1"><a id="__codelineno-106-1" name="__codelineno-106-1" href="#__codelineno-106-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">current_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>之后进入tlb_refill函数, tlb_refill执行tlbwr，从pte读取映射的物理页号写入到tlb项中。（一次映射两页）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-107-1"><a id="__codelineno-107-1" name="__codelineno-107-1" href="#__codelineno-107-1"></a><span class="n">tlb_replace_random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">THUMIPS_TLB_ENTRYH_VPN2_MASK</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-107-2"><a id="__codelineno-107-2" name="__codelineno-107-2" href="#__codelineno-107-2"></a><span class="w">      </span><span class="n">pte2tlblow</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">),</span><span class="w"> </span><span class="n">pte2tlblow</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pte</span><span class="o">+</span><span class="mi">1</span><span class="p">)));</span>
</span></code></pre></div>
</li>
</ol>
<p>终端输出</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-108-1"><a id="__codelineno-108-1" name="__codelineno-108-1" href="#__codelineno-108-1"></a>## tlb refill in kernel, badaddr: 0x100
</span><span id="__span-108-2"><a id="__codelineno-108-2" name="__codelineno-108-2" href="#__codelineno-108-2"></a>check_boot_pgdir() succeeded!
</span></code></pre></div>
<h6 id="kmalloc"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kmalloc">kmalloc</a></h6>
<p>pmm_init中还调用了kmalloc_init。</p>
<p>kmalloc中主要实现了以下关键函数</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-109-1"><a id="__codelineno-109-1" name="__codelineno-109-1" href="#__codelineno-109-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-109-2"><a id="__codelineno-109-2" name="__codelineno-109-2" href="#__codelineno-109-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">objp</span><span class="p">);</span>
</span></code></pre></div>
<p>可以看到kmalloc函数的参数为字节数，返回值为分配的物理内存的虚拟起始地址。</p>
<p>kmalloc利用到了slab机制</p>
<blockquote>
<p>slab是Linux操作系统的一种内存分配机制。其工作是针对一些经常分配并释放的对象，如进程描述符等，这些对象的大小一般比较小，如果直接采用伙伴系统来进行分配和释放，不仅会造成大量的内存碎片，而且处理速度也太慢。而slab分配器是基于对象进行管理的，相同类型的对象归为一类(如进程描述符就是一类)，每当要申请这样一个对象，slab分配器就从一个slab列表中分配一个这样大小的单元出去，而当要释放时，将其重新保存在该列表中，而不是直接返回给伙伴系统，从而避免这些内碎片。</p>
</blockquote>
<h5 id="vmm_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#vmm_init">vmm_init</a></h5>
<p>通过内存地址虚拟化，可以使得软件在没有访问某虚拟内存地址时不分配具体的物理理内存，而只有在实际访问某虚拟内存地址时，操作系统再动态地分配物理内存，建立虚拟内存到物理理内存的页映射关系，这种技术称为按需分页（demand paging）。把不不经常访问的数据所占的内存空间临时写到硬盘上，这样可以腾出更更多的空闲内存空间
给经常访问的数据；当CPU访问到不不经常访问的数据时，再把这些数据从硬盘读入到内存中。这种技术称为页换入换出(page in/out)</p>
<h6 id="vma_struct"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#vma_struct">vma_struct</a></h6>
<p>vma用于描述进程对虚拟内存的需求</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-110-1"><a id="__codelineno-110-1" name="__codelineno-110-1" href="#__codelineno-110-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-110-2"><a id="__codelineno-110-2" name="__codelineno-110-2" href="#__codelineno-110-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_mm</span><span class="p">;</span><span class="w"> </span><span class="c1">// the set of vma using the same PDT </span>
</span><span id="__span-110-3"><a id="__codelineno-110-3" name="__codelineno-110-3" href="#__codelineno-110-3"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">;</span><span class="w">      </span><span class="c1">// start addr of vma   </span>
</span><span id="__span-110-4"><a id="__codelineno-110-4" name="__codelineno-110-4" href="#__codelineno-110-4"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">;</span><span class="w">        </span><span class="c1">// end addr of vma</span>
</span><span id="__span-110-5"><a id="__codelineno-110-5" name="__codelineno-110-5" href="#__codelineno-110-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span><span class="w">       </span><span class="c1">// flags of vma</span>
</span><span id="__span-110-6"><a id="__codelineno-110-6" name="__codelineno-110-6" href="#__codelineno-110-6"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">  </span><span class="c1">// linear list link which sorted by start addr of vma</span>
</span><span id="__span-110-7"><a id="__codelineno-110-7" name="__codelineno-110-7" href="#__codelineno-110-7"></a><span class="p">};</span>
</span></code></pre></div>
<p>vma指示了一段连续的虚拟内存空间，不同vma通过list_link相连，共同表示一个进程的虚拟内存空间。</p>
<h6 id="mm_struct"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#mm_struct">mm_struct</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-111-1"><a id="__codelineno-111-1" name="__codelineno-111-1" href="#__codelineno-111-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-111-2"><a id="__codelineno-111-2" name="__codelineno-111-2" href="#__codelineno-111-2"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">mmap_list</span><span class="p">;</span><span class="w">        </span><span class="c1">// linear list link which sorted by start addr of vma</span>
</span><span id="__span-111-3"><a id="__codelineno-111-3" name="__codelineno-111-3" href="#__codelineno-111-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mmap_cache</span><span class="p">;</span><span class="w"> </span><span class="c1">// current accessed vma, used for speed purpose</span>
</span><span id="__span-111-4"><a id="__codelineno-111-4" name="__codelineno-111-4" href="#__codelineno-111-4"></a><span class="w">    </span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">;</span><span class="w">                  </span><span class="c1">// the PDT of these vma</span>
</span><span id="__span-111-5"><a id="__codelineno-111-5" name="__codelineno-111-5" href="#__codelineno-111-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">map_count</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the count of these vma</span>
</span><span id="__span-111-6"><a id="__codelineno-111-6" name="__codelineno-111-6" href="#__codelineno-111-6"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sm_priv</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the private data for swap manager</span>
</span><span id="__span-111-7"><a id="__codelineno-111-7" name="__codelineno-111-7" href="#__codelineno-111-7"></a><span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">mm_count</span><span class="p">;</span>
</span><span id="__span-111-8"><a id="__codelineno-111-8" name="__codelineno-111-8" href="#__codelineno-111-8"></a><span class="w">    </span><span class="n">semaphore_t</span><span class="w"> </span><span class="n">mm_sem</span><span class="p">;</span>
</span><span id="__span-111-9"><a id="__codelineno-111-9" name="__codelineno-111-9" href="#__codelineno-111-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">locked_by</span><span class="p">;</span>
</span><span id="__span-111-10"><a id="__codelineno-111-10" name="__codelineno-111-10" href="#__codelineno-111-10"></a><span class="p">};</span>
</span></code></pre></div>
<p>mm_struct用于管理一系列使用同一个页目录表的vma的集合。</p>
<p>进程控制块中包含一个mm_struct的指针，用于管理该进程的虚拟内存空间</p>
<h6 id="关键函数"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#关键函数">关键函数</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-112-1"><a id="__codelineno-112-1" name="__codelineno-112-1" href="#__codelineno-112-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">find_vma</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-112-2"><a id="__codelineno-112-2" name="__codelineno-112-2" href="#__codelineno-112-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma_create</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">);</span>
</span><span id="__span-112-3"><a id="__codelineno-112-3" name="__codelineno-112-3" href="#__codelineno-112-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">insert_vma_struct</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="check_pgfaultpagefault的处理"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_pgfaultpagefault的处理">check_pgfault（pagefault的处理）</a></h6>
<ol>
<li>
<p>创建mm_struct</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-113-1"><a id="__codelineno-113-1" name="__codelineno-113-1" href="#__codelineno-113-1"></a><span class="n">check_mm_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">();</span>
</span></code></pre></div>
<p>这里的<code>check_mm_struct</code>为全局变量</p>
</li>
<li>
<p>分配[0, PTSIZE]的虚拟内存</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-114-1"><a id="__codelineno-114-1" name="__codelineno-114-1" href="#__codelineno-114-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma_create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PTSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">);</span><span class="w"> </span><span class="c1">//如果该成VM_READ，之后在do_pgfault便会通不过权限检查。</span>
</span><span id="__span-114-2"><a id="__codelineno-114-2" name="__codelineno-114-2" href="#__codelineno-114-2"></a><span class="n">insert_vma_struct</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>访问0x100</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-115-1"><a id="__codelineno-115-1" name="__codelineno-115-1" href="#__codelineno-115-1"></a><span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100</span><span class="p">;</span>
</span><span id="__span-115-2"><a id="__codelineno-115-2" name="__codelineno-115-2" href="#__codelineno-115-2"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
</span><span id="__span-115-3"><a id="__codelineno-115-3" name="__codelineno-115-3" href="#__codelineno-115-3"></a>
</span><span id="__span-115-4"><a id="__codelineno-115-4" name="__codelineno-115-4" href="#__codelineno-115-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-115-5"><a id="__codelineno-115-5" name="__codelineno-115-5" href="#__codelineno-115-5"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-115-6"><a id="__codelineno-115-6" name="__codelineno-115-6" href="#__codelineno-115-6"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">    </span><span class="c1">//page fault</span>
</span><span id="__span-115-7"><a id="__codelineno-115-7" name="__codelineno-115-7" href="#__codelineno-115-7"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-115-8"><a id="__codelineno-115-8" name="__codelineno-115-8" href="#__codelineno-115-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-115-9"><a id="__codelineno-115-9" name="__codelineno-115-9" href="#__codelineno-115-9"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-115-10"><a id="__codelineno-115-10" name="__codelineno-115-10" href="#__codelineno-115-10"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-115-11"><a id="__codelineno-115-11" name="__codelineno-115-11" href="#__codelineno-115-11"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-115-12"><a id="__codelineno-115-12" name="__codelineno-115-12" href="#__codelineno-115-12"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>触发tlb refill异常。（实际为pagefault，此时页表中没有该映射，因此tlb中也没有该项 ）</p>
<p>参考之前tlb refill异常处理的代码，进入pgfault_handler</p>
<ol>
<li>首先通过判断check_mm_struct非空，知道是在执行check_pgfault函数，将mm设置为check_mm_struct</li>
<li>在do_pgfault中首先调用find_vma函数，确定该虚拟地址是有效的</li>
<li>然后检查该地址访问权限是否正确（如果将</li>
<li>都通过了后，调用pgdir_alloc_page，直接分配一个物理页，并在mm-&gt;pgdir中插入映射关系。</li>
<li>异常处理完成并返回</li>
</ol>
</li>
<li>
<p>再次触发tlb refill异常。（现在页表中存在了该映射，因此进入tlb_refill函数）</p>
</li>
</ol>
<p>终端输出</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-116-1"><a id="__codelineno-116-1" name="__codelineno-116-1" href="#__codelineno-116-1"></a>## pagefault in kernel, badaddr: 0x100
</span><span id="__span-116-2"><a id="__codelineno-116-2" name="__codelineno-116-2" href="#__codelineno-116-2"></a>## tlb refill in kernel, badaddr: 0x100
</span><span id="__span-116-3"><a id="__codelineno-116-3" name="__codelineno-116-3" href="#__codelineno-116-3"></a>check_pgfault() succeeded!
</span></code></pre></div>
<p>代码</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-117-1"><a id="__codelineno-117-1" name="__codelineno-117-1" href="#__codelineno-117-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">get_error_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">)</span>
</span><span id="__span-117-2"><a id="__codelineno-117-2" name="__codelineno-117-2" href="#__codelineno-117-2"></a><span class="p">{</span>
</span><span id="__span-117-3"><a id="__codelineno-117-3" name="__codelineno-117-3" href="#__codelineno-117-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-117-4"><a id="__codelineno-117-4" name="__codelineno-117-4" href="#__codelineno-117-4"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="o">!=</span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ptep_present</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span><span class="w">    </span><span class="c1">//因为pagefault的条件(pte==NULL || ptep_invalid(pte))，这里根本不可能为真</span>
</span><span id="__span-117-5"><a id="__codelineno-117-5" name="__codelineno-117-5" href="#__codelineno-117-5"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
</span><span id="__span-117-6"><a id="__codelineno-117-6" name="__codelineno-117-6" href="#__codelineno-117-6"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">)</span>
</span><span id="__span-117-7"><a id="__codelineno-117-7" name="__codelineno-117-7" href="#__codelineno-117-7"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span>
</span><span id="__span-117-8"><a id="__codelineno-117-8" name="__codelineno-117-8" href="#__codelineno-117-8"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-117-9"><a id="__codelineno-117-9" name="__codelineno-117-9" href="#__codelineno-117-9"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-118-1"><a id="__codelineno-118-1" name="__codelineno-118-1" href="#__codelineno-118-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-118-2"><a id="__codelineno-118-2" name="__codelineno-118-2" href="#__codelineno-118-2"></a><span class="nf">pgfault_handler</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">error_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-3"><a id="__codelineno-118-3" name="__codelineno-118-3" href="#__codelineno-118-3"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">check_mm_struct</span><span class="p">;</span>
</span><span id="__span-118-4"><a id="__codelineno-118-4" name="__codelineno-118-4" href="#__codelineno-118-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-118-5"><a id="__codelineno-118-5" name="__codelineno-118-5" href="#__codelineno-118-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_mm_struct</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-6"><a id="__codelineno-118-6" name="__codelineno-118-6" href="#__codelineno-118-6"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-118-7"><a id="__codelineno-118-7" name="__codelineno-118-7" href="#__codelineno-118-7"></a><span class="w">    </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_mm_struct</span><span class="p">;</span>
</span><span id="__span-118-8"><a id="__codelineno-118-8" name="__codelineno-118-8" href="#__codelineno-118-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-118-9"><a id="__codelineno-118-9" name="__codelineno-118-9" href="#__codelineno-118-9"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-10"><a id="__codelineno-118-10" name="__codelineno-118-10" href="#__codelineno-118-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-118-11"><a id="__codelineno-118-11" name="__codelineno-118-11" href="#__codelineno-118-11"></a><span class="w">      </span><span class="n">print_trapframe</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-118-12"><a id="__codelineno-118-12" name="__codelineno-118-12" href="#__codelineno-118-12"></a><span class="w">      </span><span class="c1">//print_pgfault(tf);</span>
</span><span id="__span-118-13"><a id="__codelineno-118-13" name="__codelineno-118-13" href="#__codelineno-118-13"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled page fault.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-118-14"><a id="__codelineno-118-14" name="__codelineno-118-14" href="#__codelineno-118-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-118-15"><a id="__codelineno-118-15" name="__codelineno-118-15" href="#__codelineno-118-15"></a><span class="w">    </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-118-16"><a id="__codelineno-118-16" name="__codelineno-118-16" href="#__codelineno-118-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-118-17"><a id="__codelineno-118-17" name="__codelineno-118-17" href="#__codelineno-118-17"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">do_pgfault</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-118-18"><a id="__codelineno-118-18" name="__codelineno-118-18" href="#__codelineno-118-18"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-119-1"><a id="__codelineno-119-1" name="__codelineno-119-1" href="#__codelineno-119-1"></a><span class="cp">#! vmm.c</span>
</span><span id="__span-119-2"><a id="__codelineno-119-2" name="__codelineno-119-2" href="#__codelineno-119-2"></a>
</span><span id="__span-119-3"><a id="__codelineno-119-3" name="__codelineno-119-3" href="#__codelineno-119-3"></a><span class="c1">//page fault number</span>
</span><span id="__span-119-4"><a id="__codelineno-119-4" name="__codelineno-119-4" href="#__codelineno-119-4"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pgfault_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-119-5"><a id="__codelineno-119-5" name="__codelineno-119-5" href="#__codelineno-119-5"></a><span class="c1">// do_pgfault - interrupt handler to process the page fault execption</span>
</span><span id="__span-119-6"><a id="__codelineno-119-6" name="__codelineno-119-6" href="#__codelineno-119-6"></a><span class="kt">int</span>
</span><span id="__span-119-7"><a id="__codelineno-119-7" name="__codelineno-119-7" href="#__codelineno-119-7"></a><span class="nf">do_pgfault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-8"><a id="__codelineno-119-8" name="__codelineno-119-8" href="#__codelineno-119-8"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_INVAL</span><span class="p">;</span>
</span><span id="__span-119-9"><a id="__codelineno-119-9" name="__codelineno-119-9" href="#__codelineno-119-9"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-119-10"><a id="__codelineno-119-10" name="__codelineno-119-10" href="#__codelineno-119-10"></a><span class="w">  </span><span class="c1">//kprintf(&quot;## %08x %08x\n&quot;, error_code, addr);</span>
</span><span id="__span-119-11"><a id="__codelineno-119-11" name="__codelineno-119-11" href="#__codelineno-119-11"></a>
</span><span id="__span-119-12"><a id="__codelineno-119-12" name="__codelineno-119-12" href="#__codelineno-119-12"></a><span class="w">  </span><span class="n">pgfault_num</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-119-13"><a id="__codelineno-119-13" name="__codelineno-119-13" href="#__codelineno-119-13"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vma</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-14"><a id="__codelineno-119-14" name="__codelineno-119-14" href="#__codelineno-119-14"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;not valid addr %x, and  can not find it in vma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-119-15"><a id="__codelineno-119-15" name="__codelineno-119-15" href="#__codelineno-119-15"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-16"><a id="__codelineno-119-16" name="__codelineno-119-16" href="#__codelineno-119-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-119-17"><a id="__codelineno-119-17" name="__codelineno-119-17" href="#__codelineno-119-17"></a>
</span><span id="__span-119-18"><a id="__codelineno-119-18" name="__codelineno-119-18" href="#__codelineno-119-18"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">error_code</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-19"><a id="__codelineno-119-19" name="__codelineno-119-19" href="#__codelineno-119-19"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-119-20"><a id="__codelineno-119-20" name="__codelineno-119-20" href="#__codelineno-119-20"></a><span class="w">      </span><span class="cm">/* default is 3: write, present */</span>
</span><span id="__span-119-21"><a id="__codelineno-119-21" name="__codelineno-119-21" href="#__codelineno-119-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write, not present */</span>
</span><span id="__span-119-22"><a id="__codelineno-119-22" name="__codelineno-119-22" href="#__codelineno-119-22"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-23"><a id="__codelineno-119-23" name="__codelineno-119-23" href="#__codelineno-119-23"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;write, not present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-119-24"><a id="__codelineno-119-24" name="__codelineno-119-24" href="#__codelineno-119-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-25"><a id="__codelineno-119-25" name="__codelineno-119-25" href="#__codelineno-119-25"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-119-26"><a id="__codelineno-119-26" name="__codelineno-119-26" href="#__codelineno-119-26"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-119-27"><a id="__codelineno-119-27" name="__codelineno-119-27" href="#__codelineno-119-27"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read, present */</span>
</span><span id="__span-119-28"><a id="__codelineno-119-28" name="__codelineno-119-28" href="#__codelineno-119-28"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;read, present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-119-29"><a id="__codelineno-119-29" name="__codelineno-119-29" href="#__codelineno-119-29"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-30"><a id="__codelineno-119-30" name="__codelineno-119-30" href="#__codelineno-119-30"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read, not present */</span>
</span><span id="__span-119-31"><a id="__codelineno-119-31" name="__codelineno-119-31" href="#__codelineno-119-31"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">VM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_EXEC</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-32"><a id="__codelineno-119-32" name="__codelineno-119-32" href="#__codelineno-119-32"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;read, not present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-119-33"><a id="__codelineno-119-33" name="__codelineno-119-33" href="#__codelineno-119-33"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-34"><a id="__codelineno-119-34" name="__codelineno-119-34" href="#__codelineno-119-34"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-119-35"><a id="__codelineno-119-35" name="__codelineno-119-35" href="#__codelineno-119-35"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-119-36"><a id="__codelineno-119-36" name="__codelineno-119-36" href="#__codelineno-119-36"></a>
</span><span id="__span-119-37"><a id="__codelineno-119-37" name="__codelineno-119-37" href="#__codelineno-119-37"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
</span><span id="__span-119-38"><a id="__codelineno-119-38" name="__codelineno-119-38" href="#__codelineno-119-38"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-39"><a id="__codelineno-119-39" name="__codelineno-119-39" href="#__codelineno-119-39"></a><span class="w">    </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">;</span>
</span><span id="__span-119-40"><a id="__codelineno-119-40" name="__codelineno-119-40" href="#__codelineno-119-40"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-119-41"><a id="__codelineno-119-41" name="__codelineno-119-41" href="#__codelineno-119-41"></a><span class="w">  </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-119-42"><a id="__codelineno-119-42" name="__codelineno-119-42" href="#__codelineno-119-42"></a>
</span><span id="__span-119-43"><a id="__codelineno-119-43" name="__codelineno-119-43" href="#__codelineno-119-43"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-119-44"><a id="__codelineno-119-44" name="__codelineno-119-44" href="#__codelineno-119-44"></a>
</span><span id="__span-119-45"><a id="__codelineno-119-45" name="__codelineno-119-45" href="#__codelineno-119-45"></a><span class="w">  </span><span class="c1">// try to find a pte, if pte&#39;s PT(Page Table) isn&#39;t existed, then create a PT.</span>
</span><span id="__span-119-46"><a id="__codelineno-119-46" name="__codelineno-119-46" href="#__codelineno-119-46"></a><span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-119-47"><a id="__codelineno-119-47" name="__codelineno-119-47" href="#__codelineno-119-47"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-48"><a id="__codelineno-119-48" name="__codelineno-119-48" href="#__codelineno-119-48"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-49"><a id="__codelineno-119-49" name="__codelineno-119-49" href="#__codelineno-119-49"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-119-50"><a id="__codelineno-119-50" name="__codelineno-119-50" href="#__codelineno-119-50"></a>
</span><span id="__span-119-51"><a id="__codelineno-119-51" name="__codelineno-119-51" href="#__codelineno-119-51"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// if the phy addr isn&#39;t exist, then alloc a page &amp; map the phy addr with logical addr</span>
</span><span id="__span-119-52"><a id="__codelineno-119-52" name="__codelineno-119-52" href="#__codelineno-119-52"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-53"><a id="__codelineno-119-53" name="__codelineno-119-53" href="#__codelineno-119-53"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-54"><a id="__codelineno-119-54" name="__codelineno-119-54" href="#__codelineno-119-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-119-55"><a id="__codelineno-119-55" name="__codelineno-119-55" href="#__codelineno-119-55"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-119-56"><a id="__codelineno-119-56" name="__codelineno-119-56" href="#__codelineno-119-56"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// if this pte is a swap entry, then load data from disk to a page with phy addr, </span>
</span><span id="__span-119-57"><a id="__codelineno-119-57" name="__codelineno-119-57" href="#__codelineno-119-57"></a><span class="w">    </span><span class="c1">// map the phy addr with logical addr, trig swap manager to record the access situation of this page</span>
</span><span id="__span-119-58"><a id="__codelineno-119-58" name="__codelineno-119-58" href="#__codelineno-119-58"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">swap_init_ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-59"><a id="__codelineno-119-59" name="__codelineno-119-59" href="#__codelineno-119-59"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;No swap!! never reach!!&quot;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-119-60"><a id="__codelineno-119-60" name="__codelineno-119-60" href="#__codelineno-119-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-119-61"><a id="__codelineno-119-61" name="__codelineno-119-61" href="#__codelineno-119-61"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-119-62"><a id="__codelineno-119-62" name="__codelineno-119-62" href="#__codelineno-119-62"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;no swap_init_ok but ptep is %x, failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
</span><span id="__span-119-63"><a id="__codelineno-119-63" name="__codelineno-119-63" href="#__codelineno-119-63"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-119-64"><a id="__codelineno-119-64" name="__codelineno-119-64" href="#__codelineno-119-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-119-65"><a id="__codelineno-119-65" name="__codelineno-119-65" href="#__codelineno-119-65"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-119-66"><a id="__codelineno-119-66" name="__codelineno-119-66" href="#__codelineno-119-66"></a><span class="w">  </span><span class="cm">/* refill TLB for mips, no second exception */</span>
</span><span id="__span-119-67"><a id="__codelineno-119-67" name="__codelineno-119-67" href="#__codelineno-119-67"></a><span class="w">  </span><span class="c1">//tlb_refill(addr, ptep);</span>
</span><span id="__span-119-68"><a id="__codelineno-119-68" name="__codelineno-119-68" href="#__codelineno-119-68"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-119-69"><a id="__codelineno-119-69" name="__codelineno-119-69" href="#__codelineno-119-69"></a><span class="nl">failed</span><span class="p">:</span>
</span><span id="__span-119-70"><a id="__codelineno-119-70" name="__codelineno-119-70" href="#__codelineno-119-70"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-119-71"><a id="__codelineno-119-71" name="__codelineno-119-71" href="#__codelineno-119-71"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="函数调用"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#函数调用">函数调用</a></h5>
<ol>
<li>
<p>使用jal调用函数，使用jr ra返回。使用a0-a3传递参数，使用v0-v1传递返回值。对于更多的参数，使用栈传递。</p>
</li>
<li>
<p>为了防止寄存器的值被覆盖。需要在存储寄存器的值，可以由caller或者callee来完成。但是只有一方完成时，因为caller不知道callee会用哪些寄存器，或者callee不知道caller需要用哪些寄存器。因此就会导致存储不必要的寄存器。MIPS采用了一种折衷的策略，将寄存器分为caller-save（如t0-t7, a0-a3, v0-v1）和callee-save（如s0-s7, ra）</p>
</li>
<li>
<p>fp寄存器（也是s8）用于指向栈帧的第一个元素。因为x86中提供了push和pop指令，sp的位置是变化的，要引用不同变量的值是用fp更方便。而MIPS中则是在函数的开头手动将sp设置，sp之后的值不会变化，因此fp貌似作用不大。</p>
</li>
<li>
<p>gp寄存器，用于程序访问全局变量（比如函数的地址）。</p>
</li>
</ol>
<blockquote>
<p>ps. 使用mipsel-linux-gnu-gcc -S编译一个简单的函数调用测试代码。不知为什么和上面讲的caller-save，callee-save对不上。比如函数开头<code>addiu $sp,$sp,-40</code>，但结果却根本没用上这么大的空间。然后，为什么还会出现<code>sw $a0,40($fp)</code>，即将参数<code>a0</code>写入父函数栈帧的情况。（这个然后fp和sp始终相等，不知道为什么要去存储fp</p>
</blockquote>
<h5 id="sched_init--proc_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#sched_init--proc_init">sched_init &amp; proc_init</a></h5>
<h6 id="proc_struct进程控制块"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#proc_struct进程控制块">proc_struct(进程控制块)</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-120-1"><a id="__codelineno-120-1" name="__codelineno-120-1" href="#__codelineno-120-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-120-2"><a id="__codelineno-120-2" name="__codelineno-120-2" href="#__codelineno-120-2"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">proc_state</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Process state</span>
</span><span id="__span-120-3"><a id="__codelineno-120-3" name="__codelineno-120-3" href="#__codelineno-120-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">                                    </span><span class="c1">// Process ID</span>
</span><span id="__span-120-4"><a id="__codelineno-120-4" name="__codelineno-120-4" href="#__codelineno-120-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">runs</span><span class="p">;</span><span class="w">                                   </span><span class="c1">// the running times of Proces</span>
</span><span id="__span-120-5"><a id="__codelineno-120-5" name="__codelineno-120-5" href="#__codelineno-120-5"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">kstack</span><span class="p">;</span><span class="w">                           </span><span class="c1">// Process kernel stack</span>
</span><span id="__span-120-6"><a id="__codelineno-120-6" name="__codelineno-120-6" href="#__codelineno-120-6"></a><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">need_resched</span><span class="p">;</span><span class="w">                 </span><span class="c1">// bool value: need to be rescheduled to release CPU?</span>
</span><span id="__span-120-7"><a id="__codelineno-120-7" name="__codelineno-120-7" href="#__codelineno-120-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the parent process</span>
</span><span id="__span-120-8"><a id="__codelineno-120-8" name="__codelineno-120-8" href="#__codelineno-120-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Process&#39;s memory management field</span>
</span><span id="__span-120-9"><a id="__codelineno-120-9" name="__codelineno-120-9" href="#__codelineno-120-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Switch here to run process</span>
</span><span id="__span-120-10"><a id="__codelineno-120-10" name="__codelineno-120-10" href="#__codelineno-120-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Trap frame for current interrupt</span>
</span><span id="__span-120-11"><a id="__codelineno-120-11" name="__codelineno-120-11" href="#__codelineno-120-11"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">cr3</span><span class="p">;</span><span class="w">                              </span><span class="c1">// CR3 register: the base addr of Page Directroy Table(PDT)</span>
</span><span id="__span-120-12"><a id="__codelineno-120-12" name="__codelineno-120-12" href="#__codelineno-120-12"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                             </span><span class="c1">// Process flag</span>
</span><span id="__span-120-13"><a id="__codelineno-120-13" name="__codelineno-120-13" href="#__codelineno-120-13"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">PROC_NAME_LEN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">               </span><span class="c1">// Process name</span>
</span><span id="__span-120-14"><a id="__codelineno-120-14" name="__codelineno-120-14" href="#__codelineno-120-14"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Process link list </span>
</span><span id="__span-120-15"><a id="__codelineno-120-15" name="__codelineno-120-15" href="#__codelineno-120-15"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">hash_link</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Process hash list</span>
</span><span id="__span-120-16"><a id="__codelineno-120-16" name="__codelineno-120-16" href="#__codelineno-120-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_code</span><span class="p">;</span><span class="w">                              </span><span class="c1">// exit code (be sent to parent proc)</span>
</span><span id="__span-120-17"><a id="__codelineno-120-17" name="__codelineno-120-17" href="#__codelineno-120-17"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">wait_state</span><span class="p">;</span><span class="w">                        </span><span class="c1">// waiting state</span>
</span><span id="__span-120-18"><a id="__codelineno-120-18" name="__codelineno-120-18" href="#__codelineno-120-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">yptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">optr</span><span class="p">;</span><span class="w">     </span><span class="c1">// relations between processes</span>
</span><span id="__span-120-19"><a id="__codelineno-120-19" name="__codelineno-120-19" href="#__codelineno-120-19"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">run_queue</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">;</span><span class="w">                       </span><span class="c1">// running queue contains Process</span>
</span><span id="__span-120-20"><a id="__codelineno-120-20" name="__codelineno-120-20" href="#__codelineno-120-20"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">run_link</span><span class="p">;</span><span class="w">                      </span><span class="c1">// the entry linked in run queue</span>
</span><span id="__span-120-21"><a id="__codelineno-120-21" name="__codelineno-120-21" href="#__codelineno-120-21"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">time_slice</span><span class="p">;</span><span class="w">                             </span><span class="c1">// time slice for occupying the CPU</span>
</span><span id="__span-120-22"><a id="__codelineno-120-22" name="__codelineno-120-22" href="#__codelineno-120-22"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fs_struct</span><span class="w"> </span><span class="o">*</span><span class="n">fs_struct</span><span class="p">;</span><span class="w">                </span><span class="c1">// the file related info(pwd, files_count, files_array, fs_semaphore) of process</span>
</span><span id="__span-120-23"><a id="__codelineno-120-23" name="__codelineno-120-23" href="#__codelineno-120-23"></a><span class="p">};</span>
</span></code></pre></div>
<h6 id="tf"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#tf">tf</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-121-1"><a id="__codelineno-121-1" name="__codelineno-121-1" href="#__codelineno-121-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-121-2"><a id="__codelineno-121-2" name="__codelineno-121-2" href="#__codelineno-121-2"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_vaddr</span><span class="p">;</span><span class="w">  </span><span class="cm">/* coprocessor 0 vaddr register */</span>
</span><span id="__span-121-3"><a id="__codelineno-121-3" name="__codelineno-121-3" href="#__codelineno-121-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_status</span><span class="p">;</span><span class="w"> </span><span class="cm">/* coprocessor 0 status register */</span>
</span><span id="__span-121-4"><a id="__codelineno-121-4" name="__codelineno-121-4" href="#__codelineno-121-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_cause</span><span class="p">;</span><span class="w">  </span><span class="cm">/* coprocessor 0 cause register */</span>
</span><span id="__span-121-5"><a id="__codelineno-121-5" name="__codelineno-121-5" href="#__codelineno-121-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_lo</span><span class="p">;</span>
</span><span id="__span-121-6"><a id="__codelineno-121-6" name="__codelineno-121-6" href="#__codelineno-121-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_hi</span><span class="p">;</span>
</span><span id="__span-121-7"><a id="__codelineno-121-7" name="__codelineno-121-7" href="#__codelineno-121-7"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_ra</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Saved register 31 */</span>
</span><span id="__span-121-8"><a id="__codelineno-121-8" name="__codelineno-121-8" href="#__codelineno-121-8"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">pushregs</span><span class="w"> </span><span class="n">tf_regs</span><span class="p">;</span>
</span><span id="__span-121-9"><a id="__codelineno-121-9" name="__codelineno-121-9" href="#__codelineno-121-9"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_epc</span><span class="p">;</span><span class="w">    </span><span class="cm">/* coprocessor 0 epc register */</span>
</span><span id="__span-121-10"><a id="__codelineno-121-10" name="__codelineno-121-10" href="#__codelineno-121-10"></a><span class="p">};</span>
</span></code></pre></div>
<p>tf记录了</p>
<ol>
<li>进程的上下文：32个通用寄存器的值</li>
<li>epc, status, cause等CP0寄存器</li>
</ol>
<p>进入异常后，要将sp切换到内核栈。对于内核进程来说，就是当前的sp，而对于用户进程来说，需要从进程控制块中读取kstack的地址。</p>
<p>uCore内核允许嵌套中断。因此为了了保证嵌套中断发⽣生时tf 总是能够指向当前的trapframe，uCore 在内核栈上维护了了 tf 的链。</p>
<blockquote>
<p>发生中断（异常）时，trap.c::mips_trap会改变当前进程current-&gt;tf的值</p>
<p><code>current-&gt;tf = *tf*;</code></p>
<p>要实现嵌套中断，需要在改变current-&gt;tf前使用一个trapframe *otf（局部变量，存储在内核栈中）存下来。之后再将current-&gt;tf恢复为otf。</p>
<p>这里提一下，如果一个用户进程发生了异常，在异常处理程序中又发生了一次异常，那么第二次异常时，已经处于了内核模式（在压入tf后，调用mips_trap之前）。在ramExcHandle_general中就不会计算新的sp</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-122-1"><a id="__codelineno-122-1" name="__codelineno-122-1" href="#__codelineno-122-1"></a>mfc0 k0, CP0_STATUS /* Get status register */
</span><span id="__span-122-2"><a id="__codelineno-122-2" name="__codelineno-122-2" href="#__codelineno-122-2"></a>andi k0, k0, KSU_USER/* Check the we-were-in-user-mode bit */
</span><span id="__span-122-3"><a id="__codelineno-122-3" name="__codelineno-122-3" href="#__codelineno-122-3"></a>beq   k0, $0, 1f      /* If clear, from kernel, already have stack */
</span></code></pre></div>
</blockquote>
<h6 id="kstack"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kstack">kstack</a></h6>
<p>内核栈用于存储中断帧tf以及作为进程在内核中执行使用的sp</p>
<p>对于内核线程，该栈就是运行时的程序使⽤用的栈。而对于普通进程，uCore在创建进程时分配了了 2 个连续的物理理⻚页作为内核栈的空间。</p>
<p>内核栈位于内核地址空间，并且是不不共享的（每个线程都拥有⾃自⼰己的内核栈），因此不不受到 mm 的管理理，当进程退出的时候，内核能够根据 kstack 的值快速定位栈的位置并进⾏行行回收。</p>
<h6 id="mm"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#mm">mm</a></h6>
<p>内存管理理的信息，包括内存映射列列表、⻚页表指针等。mm成员变量量在lab3中⽤用于虚存管理理。但在实际OS中，内核线程常驻内存，不不需要考虑swap page问题，在lab3中涉及到了了⽤用户进程，才考虑进程⽤用户内存空间的swap page问题，mm才会发挥作⽤用。</p>
<blockquote>
<p>还没看到用户进程的swap page代码</p>
</blockquote>
<h6 id="创建内核线程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#创建内核线程">创建内核线程</a></h6>
<h6 id="idle"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#idle">idle</a></h6>
<p>proc_init函数启动了创建内核线程的步骤。首先当前的执行上下文（从kern_init 启动至今）就可以看成是uCore内核中的一个内线程的上下文。为此，uCore调用alloc_proc函数给当前执行的上下文分配一个进程控制块并在proc_init中对它进行相应初始化，将其打造成第0个内核线程 --idleproc。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-123-1"><a id="__codelineno-123-1" name="__codelineno-123-1" href="#__codelineno-123-1"></a><span class="w">   </span><span class="c1">//alloc_proc</span>
</span><span id="__span-123-2"><a id="__codelineno-123-2" name="__codelineno-123-2" href="#__codelineno-123-2"></a><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">             </span><span class="c1">//不需要，所有内核进程公用一个页表</span>
</span><span id="__span-123-3"><a id="__codelineno-123-3" name="__codelineno-123-3" href="#__codelineno-123-3"></a><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boot_cr3</span><span class="p">;</span><span class="w">        </span><span class="c1">//在pmm_init中分配为PADDR(boot_pgdir)</span>
</span><span id="__span-123-4"><a id="__codelineno-123-4" name="__codelineno-123-4" href="#__codelineno-123-4"></a>
</span><span id="__span-123-5"><a id="__codelineno-123-5" name="__codelineno-123-5" href="#__codelineno-123-5"></a><span class="w">   </span><span class="c1">//proc_init</span>
</span><span id="__span-123-6"><a id="__codelineno-123-6" name="__codelineno-123-6" href="#__codelineno-123-6"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-123-7"><a id="__codelineno-123-7" name="__codelineno-123-7" href="#__codelineno-123-7"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PROC_RUNNABLE</span><span class="p">;</span>
</span><span id="__span-123-8"><a id="__codelineno-123-8" name="__codelineno-123-8" href="#__codelineno-123-8"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bootstack</span><span class="p">;</span><span class="w"> </span><span class="c1">//在entry.S中设置的</span>
</span><span id="__span-123-9"><a id="__codelineno-123-9" name="__codelineno-123-9" href="#__codelineno-123-9"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">//表明在kern_init后会切换</span>
</span></code></pre></div>
<h6 id="initkernel_thread--do_fork"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#initkernel_thread--do_fork">init(kernel_thread &amp; do_fork)</a></h6>
<p>idle内核线程主要工作是完成内核中各个子系统的初始化，idle会调用kernel_thread函数创建内核线程init。</p>
<p>kernel_thread简单来说为新进程分配了PCB空间，和kstack空间。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-124-1"><a id="__codelineno-124-1" name="__codelineno-124-1" href="#__codelineno-124-1"></a><span class="w">    </span><span class="c1">//proc_init</span>
</span><span id="__span-124-2"><a id="__codelineno-124-2" name="__codelineno-124-2" href="#__codelineno-124-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">init_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-124-3"><a id="__codelineno-124-3" name="__codelineno-124-3" href="#__codelineno-124-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-124-4"><a id="__codelineno-124-4" name="__codelineno-124-4" href="#__codelineno-124-4"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create init_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-124-5"><a id="__codelineno-124-5" name="__codelineno-124-5" href="#__codelineno-124-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-124-6"><a id="__codelineno-124-6" name="__codelineno-124-6" href="#__codelineno-124-6"></a><span class="w">    </span><span class="n">initproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_proc</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-124-7"><a id="__codelineno-124-7" name="__codelineno-124-7" href="#__codelineno-124-7"></a><span class="w">    </span><span class="n">set_proc_name</span><span class="p">(</span><span class="n">initproc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;init&quot;</span><span class="p">);</span>
</span></code></pre></div>
<p>过程：</p>
<ol>
<li>kernel_thread创建内核线程的中断帧，重点在于将epc设置为了kernel_thread_entry，以及设置a0和a1为arg和fn。<strong>还有一点值得注意，status的KSU为内核模式</strong>。</li>
</ol>
<p>当从eret返回后（forkrets -&gt; exception_return），CPU便会进入kernel_thread_entry，并以tf中指定的寄存器值执行。</p>
<p>kernel_thread函数采用了局部变量tf来放置中断帧，并把中断帧的指针传递给do_fork函数。</p>
<p>kernel_thread调用do_fork的stack参数为0。在do_fork-&gt;copy_thread以此来判断是创建内核线程</p>
<ol>
<li>
<p>do_fork作用是以当前进程为父进程，创建一个子进程，可以根据clone_flags决定是否共享mm。具体主要做了以下一些事情：</p>
</li>
<li>
<p>调用alloc_proc为子进程分配PCB空间</p>
</li>
<li>
<p>调用setup_kstack(proc)<strong>分配了内核栈空间</strong>（注意这里的kstack为空闲页的起始地址，而非栈顶）</p>
</li>
<li>
<p>调用copy_mm，根据clone_flags来确定是复制还是共享mm。（只对用户进程有效，内核线程mm都为NULL）</p>
</li>
<li>
<p>调用copy_thread：将tf拷贝到kstack的栈顶，<strong>设置tf中的sp为proc-&gt;tf - 32</strong>（这里的减32应该和之前提到的MIPS函数调用规则有关，不管怎样，sp是位于kstack中的）</p>
<p><strong>将context中的ra设置为forkret</strong></p>
</li>
<li>
<p>将子进程插入hash_list和proc_list</p>
</li>
<li>
<p>调用wakeup_proc将进程加入调度队列</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-125-1"><a id="__codelineno-125-1" name="__codelineno-125-1" href="#__codelineno-125-1"></a><span class="kt">int</span>
</span><span id="__span-125-2"><a id="__codelineno-125-2" name="__codelineno-125-2" href="#__codelineno-125-2"></a><span class="nf">kernel_thread</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-3"><a id="__codelineno-125-3" name="__codelineno-125-3" href="#__codelineno-125-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-125-4"><a id="__codelineno-125-4" name="__codelineno-125-4" href="#__codelineno-125-4"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="p">));</span>
</span><span id="__span-125-5"><a id="__codelineno-125-5" name="__codelineno-125-5" href="#__codelineno-125-5"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span><span id="__span-125-6"><a id="__codelineno-125-6" name="__codelineno-125-6" href="#__codelineno-125-6"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">fn</span><span class="p">;</span>
</span><span id="__span-125-7"><a id="__codelineno-125-7" name="__codelineno-125-7" href="#__codelineno-125-7"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_V0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-125-8"><a id="__codelineno-125-8" name="__codelineno-125-8" href="#__codelineno-125-8"></a><span class="w">    </span><span class="c1">//TODO</span>
</span><span id="__span-125-9"><a id="__codelineno-125-9" name="__codelineno-125-9" href="#__codelineno-125-9"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_c0_status</span><span class="p">();</span>
</span><span id="__span-125-10"><a id="__codelineno-125-10" name="__codelineno-125-10" href="#__codelineno-125-10"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ST0_KSU</span><span class="p">;</span>
</span><span id="__span-125-11"><a id="__codelineno-125-11" name="__codelineno-125-11" href="#__codelineno-125-11"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_IE</span><span class="p">;</span>
</span><span id="__span-125-12"><a id="__codelineno-125-12" name="__codelineno-125-12" href="#__codelineno-125-12"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_EXL</span><span class="p">;</span>
</span><span id="__span-125-13"><a id="__codelineno-125-13" name="__codelineno-125-13" href="#__codelineno-125-13"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_GP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__read_reg</span><span class="p">(</span><span class="n">$28</span><span class="p">);</span>
</span><span id="__span-125-14"><a id="__codelineno-125-14" name="__codelineno-125-14" href="#__codelineno-125-14"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">kernel_thread_entry</span><span class="p">;</span>
</span><span id="__span-125-15"><a id="__codelineno-125-15" name="__codelineno-125-15" href="#__codelineno-125-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_fork</span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_VM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-125-16"><a id="__codelineno-125-16" name="__codelineno-125-16" href="#__codelineno-125-16"></a><span class="p">}</span>
</span><span id="__span-125-17"><a id="__codelineno-125-17" name="__codelineno-125-17" href="#__codelineno-125-17"></a>
</span><span id="__span-125-18"><a id="__codelineno-125-18" name="__codelineno-125-18" href="#__codelineno-125-18"></a><span class="c1">//kern/proc/entry.S</span>
</span><span id="__span-125-19"><a id="__codelineno-125-19" name="__codelineno-125-19" href="#__codelineno-125-19"></a><span class="nl">kernel_thread_entry</span><span class="p">:</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-125-20"><a id="__codelineno-125-20" name="__codelineno-125-20" href="#__codelineno-125-20"></a><span class="w">  </span><span class="n">addiu</span><span class="w"> </span><span class="n">$sp</span><span class="p">,</span><span class="w"> </span><span class="n">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-125-21"><a id="__codelineno-125-21" name="__codelineno-125-21" href="#__codelineno-125-21"></a><span class="w">  </span><span class="n">jal</span><span class="w"> </span><span class="n">$a1</span>
</span><span id="__span-125-22"><a id="__codelineno-125-22" name="__codelineno-125-22" href="#__codelineno-125-22"></a><span class="w">  </span><span class="n">nop</span>
</span><span id="__span-125-23"><a id="__codelineno-125-23" name="__codelineno-125-23" href="#__codelineno-125-23"></a><span class="w">  </span><span class="n">move</span><span class="w"> </span><span class="n">$a0</span><span class="p">,</span><span class="w"> </span><span class="n">$v0</span>
</span><span id="__span-125-24"><a id="__codelineno-125-24" name="__codelineno-125-24" href="#__codelineno-125-24"></a><span class="w">  </span><span class="n">la</span><span class="w">  </span><span class="n">$t0</span><span class="p">,</span><span class="w"> </span><span class="n">do_exit</span>
</span><span id="__span-125-25"><a id="__codelineno-125-25" name="__codelineno-125-25" href="#__codelineno-125-25"></a><span class="w">  </span><span class="n">jal</span><span class="w"> </span><span class="n">$t0</span><span class="w"> </span>
</span><span id="__span-125-26"><a id="__codelineno-125-26" name="__codelineno-125-26" href="#__codelineno-125-26"></a><span class="w">  </span><span class="n">nop</span>
</span><span id="__span-125-27"><a id="__codelineno-125-27" name="__codelineno-125-27" href="#__codelineno-125-27"></a><span class="w">  </span><span class="cm">/* never here */</span>
</span><span id="__span-125-28"><a id="__codelineno-125-28" name="__codelineno-125-28" href="#__codelineno-125-28"></a>
</span><span id="__span-125-29"><a id="__codelineno-125-29" name="__codelineno-125-29" href="#__codelineno-125-29"></a><span class="c1">//called by do_fork</span>
</span><span id="__span-125-30"><a id="__codelineno-125-30" name="__codelineno-125-30" href="#__codelineno-125-30"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-125-31"><a id="__codelineno-125-31" name="__codelineno-125-31" href="#__codelineno-125-31"></a><span class="n">copy_thread</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-32"><a id="__codelineno-125-32" name="__codelineno-125-32" href="#__codelineno-125-32"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KSTACKSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-125-33"><a id="__codelineno-125-33" name="__codelineno-125-33" href="#__codelineno-125-33"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-125-34"><a id="__codelineno-125-34" name="__codelineno-125-34" href="#__codelineno-125-34"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_V0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-125-35"><a id="__codelineno-125-35" name="__codelineno-125-35" href="#__codelineno-125-35"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">//a kernel thread</span>
</span><span id="__span-125-36"><a id="__codelineno-125-36" name="__codelineno-125-36" href="#__codelineno-125-36"></a><span class="w">      </span><span class="n">esp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-125-37"><a id="__codelineno-125-37" name="__codelineno-125-37" href="#__codelineno-125-37"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_SP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp</span><span class="p">;</span>
</span><span id="__span-125-38"><a id="__codelineno-125-38" name="__codelineno-125-38" href="#__codelineno-125-38"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sf_ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">forkret</span><span class="p">;</span>
</span><span id="__span-125-39"><a id="__codelineno-125-39" name="__codelineno-125-39" href="#__codelineno-125-39"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sf_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-125-40"><a id="__codelineno-125-40" name="__codelineno-125-40" href="#__codelineno-125-40"></a><span class="p">}</span>
</span><span id="__span-125-41"><a id="__codelineno-125-41" name="__codelineno-125-41" href="#__codelineno-125-41"></a>
</span><span id="__span-125-42"><a id="__codelineno-125-42" name="__codelineno-125-42" href="#__codelineno-125-42"></a><span class="c1">// do_fork - parent process for a new child process</span>
</span><span id="__span-125-43"><a id="__codelineno-125-43" name="__codelineno-125-43" href="#__codelineno-125-43"></a><span class="c1">//    1. call alloc_proc to allocate a proc_struct</span>
</span><span id="__span-125-44"><a id="__codelineno-125-44" name="__codelineno-125-44" href="#__codelineno-125-44"></a><span class="c1">//    2. call setup_kstack to allocate a kernel stack for child process</span>
</span><span id="__span-125-45"><a id="__codelineno-125-45" name="__codelineno-125-45" href="#__codelineno-125-45"></a><span class="c1">//    3. call copy_mm to dup OR share mm according clone_flag</span>
</span><span id="__span-125-46"><a id="__codelineno-125-46" name="__codelineno-125-46" href="#__codelineno-125-46"></a><span class="c1">//    4. call copy_thread to setup tf &amp; context in proc_struct</span>
</span><span id="__span-125-47"><a id="__codelineno-125-47" name="__codelineno-125-47" href="#__codelineno-125-47"></a><span class="c1">//    5. insert proc_struct into hash_list &amp;&amp; proc_list</span>
</span><span id="__span-125-48"><a id="__codelineno-125-48" name="__codelineno-125-48" href="#__codelineno-125-48"></a><span class="c1">//    6. call wakup_proc to make the new child process RUNNABLE </span>
</span><span id="__span-125-49"><a id="__codelineno-125-49" name="__codelineno-125-49" href="#__codelineno-125-49"></a><span class="c1">//    7. set the </span>
</span><span id="__span-125-50"><a id="__codelineno-125-50" name="__codelineno-125-50" href="#__codelineno-125-50"></a><span class="kt">int</span>
</span><span id="__span-125-51"><a id="__codelineno-125-51" name="__codelineno-125-51" href="#__codelineno-125-51"></a><span class="n">do_fork</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-52"><a id="__codelineno-125-52" name="__codelineno-125-52" href="#__codelineno-125-52"></a><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_FREE_PROC</span><span class="p">;</span>
</span><span id="__span-125-53"><a id="__codelineno-125-53" name="__codelineno-125-53" href="#__codelineno-125-53"></a><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-125-54"><a id="__codelineno-125-54" name="__codelineno-125-54" href="#__codelineno-125-54"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr_process</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_PROCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-55"><a id="__codelineno-125-55" name="__codelineno-125-55" href="#__codelineno-125-55"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-125-56"><a id="__codelineno-125-56" name="__codelineno-125-56" href="#__codelineno-125-56"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-125-57"><a id="__codelineno-125-57" name="__codelineno-125-57" href="#__codelineno-125-57"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-125-58"><a id="__codelineno-125-58" name="__codelineno-125-58" href="#__codelineno-125-58"></a><span class="w"> </span><span class="c1">//LAB4:EXERCISE2 2009010989</span>
</span><span id="__span-125-59"><a id="__codelineno-125-59" name="__codelineno-125-59" href="#__codelineno-125-59"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_proc</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-60"><a id="__codelineno-125-60" name="__codelineno-125-60" href="#__codelineno-125-60"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-125-61"><a id="__codelineno-125-61" name="__codelineno-125-61" href="#__codelineno-125-61"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-125-62"><a id="__codelineno-125-62" name="__codelineno-125-62" href="#__codelineno-125-62"></a>
</span><span id="__span-125-63"><a id="__codelineno-125-63" name="__codelineno-125-63" href="#__codelineno-125-63"></a><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
</span><span id="__span-125-64"><a id="__codelineno-125-64" name="__codelineno-125-64" href="#__codelineno-125-64"></a>
</span><span id="__span-125-65"><a id="__codelineno-125-65" name="__codelineno-125-65" href="#__codelineno-125-65"></a><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">setup_kstack</span><span class="p">(</span><span class="n">proc</span><span class="p">)){</span>
</span><span id="__span-125-66"><a id="__codelineno-125-66" name="__codelineno-125-66" href="#__codelineno-125-66"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_proc</span><span class="p">;</span>
</span><span id="__span-125-67"><a id="__codelineno-125-67" name="__codelineno-125-67" href="#__codelineno-125-67"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-125-68"><a id="__codelineno-125-68" name="__codelineno-125-68" href="#__codelineno-125-68"></a><span class="w"> </span><span class="c1">//LAB8:EXERCISE2 2009010989 HINT:how to copy the fs in parent&#39;s proc_struct?</span>
</span><span id="__span-125-69"><a id="__codelineno-125-69" name="__codelineno-125-69" href="#__codelineno-125-69"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_fs</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-125-70"><a id="__codelineno-125-70" name="__codelineno-125-70" href="#__codelineno-125-70"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_kstack</span><span class="p">;</span>
</span><span id="__span-125-71"><a id="__codelineno-125-71" name="__codelineno-125-71" href="#__codelineno-125-71"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-125-72"><a id="__codelineno-125-72" name="__codelineno-125-72" href="#__codelineno-125-72"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_mm</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="p">)){</span>
</span><span id="__span-125-73"><a id="__codelineno-125-73" name="__codelineno-125-73" href="#__codelineno-125-73"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_fs</span><span class="p">;</span>
</span><span id="__span-125-74"><a id="__codelineno-125-74" name="__codelineno-125-74" href="#__codelineno-125-74"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-125-75"><a id="__codelineno-125-75" name="__codelineno-125-75" href="#__codelineno-125-75"></a>
</span><span id="__span-125-76"><a id="__codelineno-125-76" name="__codelineno-125-76" href="#__codelineno-125-76"></a><span class="w"> </span><span class="n">copy_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-125-77"><a id="__codelineno-125-77" name="__codelineno-125-77" href="#__codelineno-125-77"></a>
</span><span id="__span-125-78"><a id="__codelineno-125-78" name="__codelineno-125-78" href="#__codelineno-125-78"></a><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pid</span><span class="p">();</span>
</span><span id="__span-125-79"><a id="__codelineno-125-79" name="__codelineno-125-79" href="#__codelineno-125-79"></a><span class="w"> </span><span class="n">hash_proc</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-125-80"><a id="__codelineno-125-80" name="__codelineno-125-80" href="#__codelineno-125-80"></a>
</span><span id="__span-125-81"><a id="__codelineno-125-81" name="__codelineno-125-81" href="#__codelineno-125-81"></a>
</span><span id="__span-125-82"><a id="__codelineno-125-82" name="__codelineno-125-82" href="#__codelineno-125-82"></a><span class="w"> </span><span class="c1">//list_add(&amp;proc_list, &amp;(proc-&gt;list_link));</span>
</span><span id="__span-125-83"><a id="__codelineno-125-83" name="__codelineno-125-83" href="#__codelineno-125-83"></a><span class="w"> </span><span class="n">set_links</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-125-84"><a id="__codelineno-125-84" name="__codelineno-125-84" href="#__codelineno-125-84"></a>
</span><span id="__span-125-85"><a id="__codelineno-125-85" name="__codelineno-125-85" href="#__codelineno-125-85"></a><span class="w"> </span><span class="n">wakeup_proc</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-125-86"><a id="__codelineno-125-86" name="__codelineno-125-86" href="#__codelineno-125-86"></a>
</span><span id="__span-125-87"><a id="__codelineno-125-87" name="__codelineno-125-87" href="#__codelineno-125-87"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
</span><span id="__span-125-88"><a id="__codelineno-125-88" name="__codelineno-125-88" href="#__codelineno-125-88"></a>
</span><span id="__span-125-89"><a id="__codelineno-125-89" name="__codelineno-125-89" href="#__codelineno-125-89"></a><span class="nl">fork_out</span><span class="p">:</span>
</span><span id="__span-125-90"><a id="__codelineno-125-90" name="__codelineno-125-90" href="#__codelineno-125-90"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-125-91"><a id="__codelineno-125-91" name="__codelineno-125-91" href="#__codelineno-125-91"></a>
</span><span id="__span-125-92"><a id="__codelineno-125-92" name="__codelineno-125-92" href="#__codelineno-125-92"></a><span class="nl">bad_fork_cleanup_fs</span><span class="p">:</span>
</span><span id="__span-125-93"><a id="__codelineno-125-93" name="__codelineno-125-93" href="#__codelineno-125-93"></a><span class="w"> </span><span class="n">put_fs</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-125-94"><a id="__codelineno-125-94" name="__codelineno-125-94" href="#__codelineno-125-94"></a><span class="nl">bad_fork_cleanup_kstack</span><span class="p">:</span>
</span><span id="__span-125-95"><a id="__codelineno-125-95" name="__codelineno-125-95" href="#__codelineno-125-95"></a><span class="w"> </span><span class="n">put_kstack</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-125-96"><a id="__codelineno-125-96" name="__codelineno-125-96" href="#__codelineno-125-96"></a><span class="nl">bad_fork_cleanup_proc</span><span class="p">:</span>
</span><span id="__span-125-97"><a id="__codelineno-125-97" name="__codelineno-125-97" href="#__codelineno-125-97"></a><span class="w"> </span><span class="n">kfree</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-125-98"><a id="__codelineno-125-98" name="__codelineno-125-98" href="#__codelineno-125-98"></a><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-125-99"><a id="__codelineno-125-99" name="__codelineno-125-99" href="#__codelineno-125-99"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="user_main"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#user_main">user_main</a></h6>
<p>在init_main中，创建了user_main线程。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-126-1"><a id="__codelineno-126-1" name="__codelineno-126-1" href="#__codelineno-126-1"></a><span class="c1">// init_main - the second kernel thread used to create user_main kernel threads</span>
</span><span id="__span-126-2"><a id="__codelineno-126-2" name="__codelineno-126-2" href="#__codelineno-126-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-126-3"><a id="__codelineno-126-3" name="__codelineno-126-3" href="#__codelineno-126-3"></a><span class="nf">init_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-4"><a id="__codelineno-126-4" name="__codelineno-126-4" href="#__codelineno-126-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-126-5"><a id="__codelineno-126-5" name="__codelineno-126-5" href="#__codelineno-126-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">user_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-126-6"><a id="__codelineno-126-6" name="__codelineno-126-6" href="#__codelineno-126-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-7"><a id="__codelineno-126-7" name="__codelineno-126-7" href="#__codelineno-126-7"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create user_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-126-8"><a id="__codelineno-126-8" name="__codelineno-126-8" href="#__codelineno-126-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-126-9"><a id="__codelineno-126-9" name="__codelineno-126-9" href="#__codelineno-126-9"></a>
</span><span id="__span-126-10"><a id="__codelineno-126-10" name="__codelineno-126-10" href="#__codelineno-126-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">do_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-126-11"><a id="__codelineno-126-11" name="__codelineno-126-11" href="#__codelineno-126-11"></a><span class="w">        </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-126-12"><a id="__codelineno-126-12" name="__codelineno-126-12" href="#__codelineno-126-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-126-13"><a id="__codelineno-126-13" name="__codelineno-126-13" href="#__codelineno-126-13"></a>
</span><span id="__span-126-14"><a id="__codelineno-126-14" name="__codelineno-126-14" href="#__codelineno-126-14"></a><span class="w">    </span><span class="n">fs_cleanup</span><span class="p">();</span>
</span><span id="__span-126-15"><a id="__codelineno-126-15" name="__codelineno-126-15" href="#__codelineno-126-15"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;all user-mode processes have quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-126-16"><a id="__codelineno-126-16" name="__codelineno-126-16" href="#__codelineno-126-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-126-17"><a id="__codelineno-126-17" name="__codelineno-126-17" href="#__codelineno-126-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>kernel_thread之前已经分析过了，我们来看user_main做了什么</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-127-1"><a id="__codelineno-127-1" name="__codelineno-127-1" href="#__codelineno-127-1"></a><span class="c1">// user_main - kernel thread used to exec a user program</span>
</span><span id="__span-127-2"><a id="__codelineno-127-2" name="__codelineno-127-2" href="#__codelineno-127-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-127-3"><a id="__codelineno-127-3" name="__codelineno-127-3" href="#__codelineno-127-3"></a><span class="nf">user_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-127-4"><a id="__codelineno-127-4" name="__codelineno-127-4" href="#__codelineno-127-4"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;in user main, pid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-127-5"><a id="__codelineno-127-5" name="__codelineno-127-5" href="#__codelineno-127-5"></a><span class="w">    </span><span class="n">KERNEL_EXECVE</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
</span><span id="__span-127-6"><a id="__codelineno-127-6" name="__codelineno-127-6" href="#__codelineno-127-6"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;user_main execve failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-127-7"><a id="__codelineno-127-7" name="__codelineno-127-7" href="#__codelineno-127-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>user_main调用了<code>KERNEL_EXECVE</code>来加载执行一个用户程序。<code>KERNEL_EXECVE</code>被展开为对kernel_execve的调用。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-128-1"><a id="__codelineno-128-1" name="__codelineno-128-1" href="#__codelineno-128-1"></a><span class="c1">// kernel_execve - do SYS_exec syscall to exec a user program called by user_main kernel_thread</span>
</span><span id="__span-128-2"><a id="__codelineno-128-2" name="__codelineno-128-2" href="#__codelineno-128-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-128-3"><a id="__codelineno-128-3" name="__codelineno-128-3" href="#__codelineno-128-3"></a><span class="nf">kernel_execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-128-4"><a id="__codelineno-128-4" name="__codelineno-128-4" href="#__codelineno-128-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-128-5"><a id="__codelineno-128-5" name="__codelineno-128-5" href="#__codelineno-128-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-128-6"><a id="__codelineno-128-6" name="__codelineno-128-6" href="#__codelineno-128-6"></a><span class="w">        </span><span class="n">argc</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-128-7"><a id="__codelineno-128-7" name="__codelineno-128-7" href="#__codelineno-128-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-128-8"><a id="__codelineno-128-8" name="__codelineno-128-8" href="#__codelineno-128-8"></a><span class="w">    </span><span class="c1">//panic(&quot;unimpl&quot;);</span>
</span><span id="__span-128-9"><a id="__codelineno-128-9" name="__codelineno-128-9" href="#__codelineno-128-9"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
</span><span id="__span-128-10"><a id="__codelineno-128-10" name="__codelineno-128-10" href="#__codelineno-128-10"></a><span class="w">      </span><span class="s">&quot;la $v0, %1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="cm">/* syscall no. */</span>
</span><span id="__span-128-11"><a id="__codelineno-128-11" name="__codelineno-128-11" href="#__codelineno-128-11"></a><span class="w">      </span><span class="s">&quot;move $a0, %2;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-12"><a id="__codelineno-128-12" name="__codelineno-128-12" href="#__codelineno-128-12"></a><span class="w">      </span><span class="s">&quot;move $a1, %3;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-13"><a id="__codelineno-128-13" name="__codelineno-128-13" href="#__codelineno-128-13"></a><span class="w">      </span><span class="s">&quot;move $a2, %4;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-14"><a id="__codelineno-128-14" name="__codelineno-128-14" href="#__codelineno-128-14"></a><span class="w">      </span><span class="s">&quot;move $a3, %5;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-15"><a id="__codelineno-128-15" name="__codelineno-128-15" href="#__codelineno-128-15"></a><span class="w">      </span><span class="s">&quot;syscall;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-16"><a id="__codelineno-128-16" name="__codelineno-128-16" href="#__codelineno-128-16"></a><span class="w">      </span><span class="s">&quot;nop;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-17"><a id="__codelineno-128-17" name="__codelineno-128-17" href="#__codelineno-128-17"></a><span class="w">      </span><span class="s">&quot;move %0, $v0;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-128-18"><a id="__codelineno-128-18" name="__codelineno-128-18" href="#__codelineno-128-18"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span id="__span-128-19"><a id="__codelineno-128-19" name="__codelineno-128-19" href="#__codelineno-128-19"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">SYSCALL_BASE</span><span class="o">+</span><span class="n">SYS_exec</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argv</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argc</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-128-20"><a id="__codelineno-128-20" name="__codelineno-128-20" href="#__codelineno-128-20"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;a0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;v0&quot;</span>
</span><span id="__span-128-21"><a id="__codelineno-128-21" name="__codelineno-128-21" href="#__codelineno-128-21"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-128-22"><a id="__codelineno-128-22" name="__codelineno-128-22" href="#__codelineno-128-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-128-23"><a id="__codelineno-128-23" name="__codelineno-128-23" href="#__codelineno-128-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>而kernel_execve则是进行了一次系统调用。</p>
<p>kernel_execve -&gt; SYSCALL -&gt; sys_exec -&gt; do_execve</p>
<ol>
<li>
<p>因为kernel_execve就是在内核线程，所以之后进行系统调用，仍然是使用一样的内核栈。</p>
</li>
<li>
<p>do_execve做的事情</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-129-1"><a id="__codelineno-129-1" name="__codelineno-129-1" href="#__codelineno-129-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">do_execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<ol>
<li>
<p>创建局部变量local_name, kargv（位于上下文的内核栈中），将参数name, argv复制过来。</p>
<p>kernel_execve调用时传递了"sh"字符串常量的地址。而该"sh"的地址在gdb调试时显示为0x8002_7ff0，而local_name的地址则为0x81fe_bd20（此时sp为0x81fe_bd00，可以知道local_name位于当前函数的栈帧中，而"sh"位于别处）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-130-1"><a id="__codelineno-130-1" name="__codelineno-130-1" href="#__codelineno-130-1"></a><span class="n">copy_string</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">local_name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">local_name</span><span class="p">))</span>
</span><span id="__span-130-2"><a id="__codelineno-130-2" name="__codelineno-130-2" href="#__codelineno-130-2"></a>
</span><span id="__span-130-3"><a id="__codelineno-130-3" name="__codelineno-130-3" href="#__codelineno-130-3"></a><span class="n">copy_kargv</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">kargv</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
</span></code></pre></div>
<p>copy_string函数，作用是先检查访问src是否合法（通过mm），然后将src复制到dst中。这里的dst位于内核空间</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-131-1"><a id="__codelineno-131-1" name="__codelineno-131-1" href="#__codelineno-131-1"></a><span class="kt">bool</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxn</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<p>copy_string具体代码，if判断有点复杂，且没有注释，没太看懂。</p>
</li>
<li>
<p>读取文件系统，获得文件号，之后传给load_icode使用。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-132-1"><a id="__codelineno-132-1" name="__codelineno-132-1" href="#__codelineno-132-1"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysfile_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>清空原本的mm。vma，分配的Page，页表等等都会被清除。(user此时是内核进程，因此没有mm)</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-133-1"><a id="__codelineno-133-1" name="__codelineno-133-1" href="#__codelineno-133-1"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-133-2"><a id="__codelineno-133-2" name="__codelineno-133-2" href="#__codelineno-133-2"></a><span class="w">        </span><span class="n">lcr3</span><span class="p">(</span><span class="n">boot_cr3</span><span class="p">);</span>
</span><span id="__span-133-3"><a id="__codelineno-133-3" name="__codelineno-133-3" href="#__codelineno-133-3"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm_count_dec</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-133-4"><a id="__codelineno-133-4" name="__codelineno-133-4" href="#__codelineno-133-4"></a><span class="w">            </span><span class="n">exit_mmap</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-133-5"><a id="__codelineno-133-5" name="__codelineno-133-5" href="#__codelineno-133-5"></a><span class="w">            </span><span class="n">put_pgdir</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-133-6"><a id="__codelineno-133-6" name="__codelineno-133-6" href="#__codelineno-133-6"></a><span class="w">            </span><span class="n">mm_destroy</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-133-7"><a id="__codelineno-133-7" name="__codelineno-133-7" href="#__codelineno-133-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-133-8"><a id="__codelineno-133-8" name="__codelineno-133-8" href="#__codelineno-133-8"></a><span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-133-9"><a id="__codelineno-133-9" name="__codelineno-133-9" href="#__codelineno-133-9"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>调用load_icode</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-134-1"><a id="__codelineno-134-1" name="__codelineno-134-1" href="#__codelineno-134-1"></a><span class="n">load_icode</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">kargv</span><span class="p">)</span>
</span></code></pre></div>
<p>调用完load_icode后，elf文件已经被全部加载进内存，并且根据elf文件program header的内容设置好了vma，页表等内容。还分配了USTACK空间。</p>
</li>
<li>
<p>load_icode做的事情</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-135-1"><a id="__codelineno-135-1" name="__codelineno-135-1" href="#__codelineno-135-1"></a><span class="c1">// load_icode -  called by sys_exec--&gt;do_execve</span>
</span><span id="__span-135-2"><a id="__codelineno-135-2" name="__codelineno-135-2" href="#__codelineno-135-2"></a><span class="c1">// 1. create a new mm for current process</span>
</span><span id="__span-135-3"><a id="__codelineno-135-3" name="__codelineno-135-3" href="#__codelineno-135-3"></a><span class="c1">// 2. create a new PDT, and mm-&gt;pgdir= kernel virtual addr of PDT</span>
</span><span id="__span-135-4"><a id="__codelineno-135-4" name="__codelineno-135-4" href="#__codelineno-135-4"></a><span class="c1">// 3. copy TEXT/DATA/BSS parts in binary to memory space of process</span>
</span><span id="__span-135-5"><a id="__codelineno-135-5" name="__codelineno-135-5" href="#__codelineno-135-5"></a><span class="c1">// 4. call mm_map to setup user stack, and put parameters into user stack</span>
</span><span id="__span-135-6"><a id="__codelineno-135-6" name="__codelineno-135-6" href="#__codelineno-135-6"></a><span class="c1">// 5. setup trapframe for user environment   </span>
</span><span id="__span-135-7"><a id="__codelineno-135-7" name="__codelineno-135-7" href="#__codelineno-135-7"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-135-8"><a id="__codelineno-135-8" name="__codelineno-135-8" href="#__codelineno-135-8"></a><span class="n">load_icode</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">kargv</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>
<p>创建新的mm</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-136-1"><a id="__codelineno-136-1" name="__codelineno-136-1" href="#__codelineno-136-1"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-136-2"><a id="__codelineno-136-2" name="__codelineno-136-2" href="#__codelineno-136-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-136-3"><a id="__codelineno-136-3" name="__codelineno-136-3" href="#__codelineno-136-3"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_mm</span><span class="p">;</span>
</span><span id="__span-136-4"><a id="__codelineno-136-4" name="__codelineno-136-4" href="#__codelineno-136-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-136-5"><a id="__codelineno-136-5" name="__codelineno-136-5" href="#__codelineno-136-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setup_pgdir</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-136-6"><a id="__codelineno-136-6" name="__codelineno-136-6" href="#__codelineno-136-6"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_pgdir_cleanup_mm</span><span class="p">;</span>
</span><span id="__span-136-7"><a id="__codelineno-136-7" name="__codelineno-136-7" href="#__codelineno-136-7"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>接下来涉及到对elf文件的解析。首先调用load_icode_read读取elf头(struct elfhdr32)。然后根据elfhdr，获得程序头(struct proghdr)的文件内偏移elf-&gt;e_phoff、程序头的数量elf-&gt;e_phnum。再通过for循环，读取每个程序头ph。程序头显示了每个段的信息。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-137-1"><a id="__codelineno-137-1" name="__codelineno-137-1" href="#__codelineno-137-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">phnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">phnum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span><span class="w"> </span><span class="n">phnum</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-137-2"><a id="__codelineno-137-2" name="__codelineno-137-2" href="#__codelineno-137-2"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">phoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proghdr</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">phnum</span><span class="p">;</span>
</span><span id="__span-137-3"><a id="__codelineno-137-3" name="__codelineno-137-3" href="#__codelineno-137-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_icode_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proghdr</span><span class="p">),</span><span class="w"> </span><span class="n">phoff</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-137-4"><a id="__codelineno-137-4" name="__codelineno-137-4" href="#__codelineno-137-4"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-137-5"><a id="__codelineno-137-5" name="__codelineno-137-5" href="#__codelineno-137-5"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-137-6"><a id="__codelineno-137-6" name="__codelineno-137-6" href="#__codelineno-137-6"></a><span class="w">    </span><span class="p">...</span>
</span></code></pre></div>
<p>readelf -l  obj/user/sh的信息</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-138-1"><a id="__codelineno-138-1" name="__codelineno-138-1" href="#__codelineno-138-1"></a>Elf 文件类型为 EXEC (可执行文件)
</span><span id="__span-138-2"><a id="__codelineno-138-2" name="__codelineno-138-2" href="#__codelineno-138-2"></a>Entry point 0x100033d0
</span><span id="__span-138-3"><a id="__codelineno-138-3" name="__codelineno-138-3" href="#__codelineno-138-3"></a>There are 2 program headers, starting at offset 52
</span><span id="__span-138-4"><a id="__codelineno-138-4" name="__codelineno-138-4" href="#__codelineno-138-4"></a>
</span><span id="__span-138-5"><a id="__codelineno-138-5" name="__codelineno-138-5" href="#__codelineno-138-5"></a>程序头：
</span><span id="__span-138-6"><a id="__codelineno-138-6" name="__codelineno-138-6" href="#__codelineno-138-6"></a>  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
</span><span id="__span-138-7"><a id="__codelineno-138-7" name="__codelineno-138-7" href="#__codelineno-138-7"></a>  ABIFLAGS       0x0141d0 0x100041d0 0x100041d0 0x00018 0x00018 R   0x8
</span><span id="__span-138-8"><a id="__codelineno-138-8" name="__codelineno-138-8" href="#__codelineno-138-8"></a>  LOAD           0x010000 0x10000000 0x10000000 0x05010 0x09010 RWE 0x10000
</span><span id="__span-138-9"><a id="__codelineno-138-9" name="__codelineno-138-9" href="#__codelineno-138-9"></a>
</span><span id="__span-138-10"><a id="__codelineno-138-10" name="__codelineno-138-10" href="#__codelineno-138-10"></a> Section to Segment mapping:
</span><span id="__span-138-11"><a id="__codelineno-138-11" name="__codelineno-138-11" href="#__codelineno-138-11"></a>  段节...
</span><span id="__span-138-12"><a id="__codelineno-138-12" name="__codelineno-138-12" href="#__codelineno-138-12"></a>   00     .MIPS.abiflags 
</span><span id="__span-138-13"><a id="__codelineno-138-13" name="__codelineno-138-13" href="#__codelineno-138-13"></a>   01     .text .MIPS.abiflags .data .bss
</span></code></pre></div>
</li>
<li>
<p>根据每个ph的信息，添加vma。这里用的是ph-&gt;p_memsz。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-139-1"><a id="__codelineno-139-1" name="__codelineno-139-1" href="#__codelineno-139-1"></a><span class="w">  </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-139-2"><a id="__codelineno-139-2" name="__codelineno-139-2" href="#__codelineno-139-2"></a><span class="w">      </span><span class="c1">//ptep_set_u_read(&amp;perm);</span>
</span><span id="__span-139-3"><a id="__codelineno-139-3" name="__codelineno-139-3" href="#__codelineno-139-3"></a><span class="w">    </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
</span><span id="__span-139-4"><a id="__codelineno-139-4" name="__codelineno-139-4" href="#__codelineno-139-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_X</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_EXEC</span><span class="p">;</span>
</span><span id="__span-139-5"><a id="__codelineno-139-5" name="__codelineno-139-5" href="#__codelineno-139-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_W</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">;</span>
</span><span id="__span-139-6"><a id="__codelineno-139-6" name="__codelineno-139-6" href="#__codelineno-139-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_R</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_READ</span><span class="p">;</span>
</span><span id="__span-139-7"><a id="__codelineno-139-7" name="__codelineno-139-7" href="#__codelineno-139-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">)</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-139-8"><a id="__codelineno-139-8" name="__codelineno-139-8" href="#__codelineno-139-8"></a>
</span><span id="__span-139-9"><a id="__codelineno-139-9" name="__codelineno-139-9" href="#__codelineno-139-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_map</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-139-10"><a id="__codelineno-139-10" name="__codelineno-139-10" href="#__codelineno-139-10"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-139-11"><a id="__codelineno-139-11" name="__codelineno-139-11" href="#__codelineno-139-11"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>调用pgdir_alloc_page为每个虚拟地址分配物理页，并添加页表映射。调用load_icode_read将elf文件对应段(segment)读取到对应的物理页中。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-140-1"><a id="__codelineno-140-1" name="__codelineno-140-1" href="#__codelineno-140-1"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">;</span>
</span><span id="__span-140-2"><a id="__codelineno-140-2" name="__codelineno-140-2" href="#__codelineno-140-2"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-140-3"><a id="__codelineno-140-3" name="__codelineno-140-3" href="#__codelineno-140-3"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-140-4"><a id="__codelineno-140-4" name="__codelineno-140-4" href="#__codelineno-140-4"></a>
</span><span id="__span-140-5"><a id="__codelineno-140-5" name="__codelineno-140-5" href="#__codelineno-140-5"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_filesz</span><span class="p">;</span>
</span><span id="__span-140-6"><a id="__codelineno-140-6" name="__codelineno-140-6" href="#__codelineno-140-6"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-7"><a id="__codelineno-140-7" name="__codelineno-140-7" href="#__codelineno-140-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-8"><a id="__codelineno-140-8" name="__codelineno-140-8" href="#__codelineno-140-8"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-140-9"><a id="__codelineno-140-9" name="__codelineno-140-9" href="#__codelineno-140-9"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-140-10"><a id="__codelineno-140-10" name="__codelineno-140-10" href="#__codelineno-140-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-140-11"><a id="__codelineno-140-11" name="__codelineno-140-11" href="#__codelineno-140-11"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-140-12"><a id="__codelineno-140-12" name="__codelineno-140-12" href="#__codelineno-140-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-13"><a id="__codelineno-140-13" name="__codelineno-140-13" href="#__codelineno-140-13"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-140-14"><a id="__codelineno-140-14" name="__codelineno-140-14" href="#__codelineno-140-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-140-15"><a id="__codelineno-140-15" name="__codelineno-140-15" href="#__codelineno-140-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_icode_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-140-16"><a id="__codelineno-140-16" name="__codelineno-140-16" href="#__codelineno-140-16"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-140-17"><a id="__codelineno-140-17" name="__codelineno-140-17" href="#__codelineno-140-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-140-18"><a id="__codelineno-140-18" name="__codelineno-140-18" href="#__codelineno-140-18"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-140-19"><a id="__codelineno-140-19" name="__codelineno-140-19" href="#__codelineno-140-19"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>设置bss段（猜测）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-141-1"><a id="__codelineno-141-1" name="__codelineno-141-1" href="#__codelineno-141-1"></a><span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">;</span>
</span><span id="__span-141-2"><a id="__codelineno-141-2" name="__codelineno-141-2" href="#__codelineno-141-2"></a>
</span><span id="__span-141-3"><a id="__codelineno-141-3" name="__codelineno-141-3" href="#__codelineno-141-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-4"><a id="__codelineno-141-4" name="__codelineno-141-4" href="#__codelineno-141-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-5"><a id="__codelineno-141-5" name="__codelineno-141-5" href="#__codelineno-141-5"></a><span class="w">            </span><span class="k">continue</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-141-6"><a id="__codelineno-141-6" name="__codelineno-141-6" href="#__codelineno-141-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-7"><a id="__codelineno-141-7" name="__codelineno-141-7" href="#__codelineno-141-7"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
</span><span id="__span-141-8"><a id="__codelineno-141-8" name="__codelineno-141-8" href="#__codelineno-141-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-9"><a id="__codelineno-141-9" name="__codelineno-141-9" href="#__codelineno-141-9"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-141-10"><a id="__codelineno-141-10" name="__codelineno-141-10" href="#__codelineno-141-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-11"><a id="__codelineno-141-11" name="__codelineno-141-11" href="#__codelineno-141-11"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-141-12"><a id="__codelineno-141-12" name="__codelineno-141-12" href="#__codelineno-141-12"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-141-13"><a id="__codelineno-141-13" name="__codelineno-141-13" href="#__codelineno-141-13"></a><span class="w">        </span><span class="n">assert</span><span class="p">((</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">la</span><span class="p">));</span>
</span><span id="__span-141-14"><a id="__codelineno-141-14" name="__codelineno-141-14" href="#__codelineno-141-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-141-15"><a id="__codelineno-141-15" name="__codelineno-141-15" href="#__codelineno-141-15"></a>
</span><span id="__span-141-16"><a id="__codelineno-141-16" name="__codelineno-141-16" href="#__codelineno-141-16"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-17"><a id="__codelineno-141-17" name="__codelineno-141-17" href="#__codelineno-141-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-18"><a id="__codelineno-141-18" name="__codelineno-141-18" href="#__codelineno-141-18"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-141-19"><a id="__codelineno-141-19" name="__codelineno-141-19" href="#__codelineno-141-19"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-141-20"><a id="__codelineno-141-20" name="__codelineno-141-20" href="#__codelineno-141-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-21"><a id="__codelineno-141-21" name="__codelineno-141-21" href="#__codelineno-141-21"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-141-22"><a id="__codelineno-141-22" name="__codelineno-141-22" href="#__codelineno-141-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-141-23"><a id="__codelineno-141-23" name="__codelineno-141-23" href="#__codelineno-141-23"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-141-24"><a id="__codelineno-141-24" name="__codelineno-141-24" href="#__codelineno-141-24"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-141-25"><a id="__codelineno-141-25" name="__codelineno-141-25" href="#__codelineno-141-25"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-141-26"><a id="__codelineno-141-26" name="__codelineno-141-26" href="#__codelineno-141-26"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-141-27"><a id="__codelineno-141-27" name="__codelineno-141-27" href="#__codelineno-141-27"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>映射用户栈空间（添加vma，当发生pagefault时，异常处理程序会自动分配物理页）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-142-1"><a id="__codelineno-142-1" name="__codelineno-142-1" href="#__codelineno-142-1"></a><span class="w">  </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_STACK</span><span class="p">;</span>
</span><span id="__span-142-2"><a id="__codelineno-142-2" name="__codelineno-142-2" href="#__codelineno-142-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_map</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">USTACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">USTACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-142-3"><a id="__codelineno-142-3" name="__codelineno-142-3" href="#__codelineno-142-3"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-142-4"><a id="__codelineno-142-4" name="__codelineno-142-4" href="#__codelineno-142-4"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>将函数调用参数压入用户栈中</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-143-1"><a id="__codelineno-143-1" name="__codelineno-143-1" href="#__codelineno-143-1"></a><span class="w">      </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">stacktop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-143-2"><a id="__codelineno-143-2" name="__codelineno-143-2" href="#__codelineno-143-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">uargv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="p">)(</span><span class="n">stacktop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>
</span><span id="__span-143-3"><a id="__codelineno-143-3" name="__codelineno-143-3" href="#__codelineno-143-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-143-4"><a id="__codelineno-143-4" name="__codelineno-143-4" href="#__codelineno-143-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-143-5"><a id="__codelineno-143-5" name="__codelineno-143-5" href="#__codelineno-143-5"></a><span class="w">        </span><span class="n">uargv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">stacktop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">),</span><span class="w"> </span><span class="n">kargv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-143-6"><a id="__codelineno-143-6" name="__codelineno-143-6" href="#__codelineno-143-6"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>上一个步骤已经将USTACKTOP添加到了vma中。因此在第一次访问用户栈时会触发pagefault（页表中没有映射关系），操作系统会动态分配Page。第二次访问会再触发一次tlb refill，tlb添加映射关系，之后便可以正常访问了。</p>
</li>
<li>
<p>设置tf。</p>
<ol>
<li>
<p>将tf-&gt;tf_epc设置为了elf-&gt;e_entry。因此异常返回时便开始执行elf程序。</p>
</li>
<li>
<p>在tf-&gt;tf_status中设置了KSU_USER，因此从SYSCALL返回后，CPU会转变为用户态。</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-144-1"><a id="__codelineno-144-1" name="__codelineno-144-1" href="#__codelineno-144-1"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-144-2"><a id="__codelineno-144-2" name="__codelineno-144-2" href="#__codelineno-144-2"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="p">));</span>
</span><span id="__span-144-3"><a id="__codelineno-144-3" name="__codelineno-144-3" href="#__codelineno-144-3"></a>
</span><span id="__span-144-4"><a id="__codelineno-144-4" name="__codelineno-144-4" href="#__codelineno-144-4"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">;</span>
</span><span id="__span-144-5"><a id="__codelineno-144-5" name="__codelineno-144-5" href="#__codelineno-144-5"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_SP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="p">;</span>
</span><span id="__span-144-6"><a id="__codelineno-144-6" name="__codelineno-144-6" href="#__codelineno-144-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_c0_status</span><span class="p">();</span>
</span><span id="__span-144-7"><a id="__codelineno-144-7" name="__codelineno-144-7" href="#__codelineno-144-7"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ST0_KSU</span><span class="p">;</span>
</span><span id="__span-144-8"><a id="__codelineno-144-8" name="__codelineno-144-8" href="#__codelineno-144-8"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KSU_USER</span><span class="p">;</span><span class="w">     </span><span class="c1">//变成用户进程</span>
</span><span id="__span-144-9"><a id="__codelineno-144-9" name="__codelineno-144-9" href="#__codelineno-144-9"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_EXL</span><span class="p">;</span>
</span><span id="__span-144-10"><a id="__codelineno-144-10" name="__codelineno-144-10" href="#__codelineno-144-10"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-144-11"><a id="__codelineno-144-11" name="__codelineno-144-11" href="#__codelineno-144-11"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span>
</span><span id="__span-144-12"><a id="__codelineno-144-12" name="__codelineno-144-12" href="#__codelineno-144-12"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">uargv</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ol>
<h6 id="调度"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#调度">调度</a></h6>
<p>执行完proc_init后，已经创建好了两个内核线程idle和init，并且当前执行的线程为proc_init。当ucore的所有初始化工作完成后，ucore执行kern_init的最后一个函数cpu_idle函数。cpu_idle会调用schedule让出CPU。</p>
<p>schedule具体的实现我们可以不关心。我们只需要知道sched_class_enqueue(proc)将一个进程放入运行队列run queue。next = sched_class_pick_next()从rq中找到下一个执行的进程。</p>
<p>当选定需要执行的进程后，proc_run函数将该进程载入CPU执行。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-145-1"><a id="__codelineno-145-1" name="__codelineno-145-1" href="#__codelineno-145-1"></a><span class="kt">void</span>
</span><span id="__span-145-2"><a id="__codelineno-145-2" name="__codelineno-145-2" href="#__codelineno-145-2"></a><span class="nf">cpu_idle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-3"><a id="__codelineno-145-3" name="__codelineno-145-3" href="#__codelineno-145-3"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-4"><a id="__codelineno-145-4" name="__codelineno-145-4" href="#__codelineno-145-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-5"><a id="__codelineno-145-5" name="__codelineno-145-5" href="#__codelineno-145-5"></a><span class="w">            </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-145-6"><a id="__codelineno-145-6" name="__codelineno-145-6" href="#__codelineno-145-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-145-7"><a id="__codelineno-145-7" name="__codelineno-145-7" href="#__codelineno-145-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-145-8"><a id="__codelineno-145-8" name="__codelineno-145-8" href="#__codelineno-145-8"></a><span class="p">}</span>
</span><span id="__span-145-9"><a id="__codelineno-145-9" name="__codelineno-145-9" href="#__codelineno-145-9"></a>
</span><span id="__span-145-10"><a id="__codelineno-145-10" name="__codelineno-145-10" href="#__codelineno-145-10"></a><span class="kt">void</span>
</span><span id="__span-145-11"><a id="__codelineno-145-11" name="__codelineno-145-11" href="#__codelineno-145-11"></a><span class="nf">schedule</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-12"><a id="__codelineno-145-12" name="__codelineno-145-12" href="#__codelineno-145-12"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">intr_flag</span><span class="p">;</span>
</span><span id="__span-145-13"><a id="__codelineno-145-13" name="__codelineno-145-13" href="#__codelineno-145-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-145-14"><a id="__codelineno-145-14" name="__codelineno-145-14" href="#__codelineno-145-14"></a><span class="w">    </span><span class="n">local_intr_save</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-145-15"><a id="__codelineno-145-15" name="__codelineno-145-15" href="#__codelineno-145-15"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-145-16"><a id="__codelineno-145-16" name="__codelineno-145-16" href="#__codelineno-145-16"></a><span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-145-17"><a id="__codelineno-145-17" name="__codelineno-145-17" href="#__codelineno-145-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PROC_RUNNABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-18"><a id="__codelineno-145-18" name="__codelineno-145-18" href="#__codelineno-145-18"></a><span class="w">            </span><span class="n">sched_class_enqueue</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-145-19"><a id="__codelineno-145-19" name="__codelineno-145-19" href="#__codelineno-145-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-145-20"><a id="__codelineno-145-20" name="__codelineno-145-20" href="#__codelineno-145-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_class_pick_next</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-21"><a id="__codelineno-145-21" name="__codelineno-145-21" href="#__codelineno-145-21"></a><span class="w">            </span><span class="n">sched_class_dequeue</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-145-22"><a id="__codelineno-145-22" name="__codelineno-145-22" href="#__codelineno-145-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-145-23"><a id="__codelineno-145-23" name="__codelineno-145-23" href="#__codelineno-145-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-24"><a id="__codelineno-145-24" name="__codelineno-145-24" href="#__codelineno-145-24"></a><span class="w">            </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idleproc</span><span class="p">;</span>
</span><span id="__span-145-25"><a id="__codelineno-145-25" name="__codelineno-145-25" href="#__codelineno-145-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-145-26"><a id="__codelineno-145-26" name="__codelineno-145-26" href="#__codelineno-145-26"></a><span class="w">        </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">runs</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-145-27"><a id="__codelineno-145-27" name="__codelineno-145-27" href="#__codelineno-145-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-28"><a id="__codelineno-145-28" name="__codelineno-145-28" href="#__codelineno-145-28"></a><span class="w">            </span><span class="c1">//kprintf(&quot;########################\n&quot;);</span>
</span><span id="__span-145-29"><a id="__codelineno-145-29" name="__codelineno-145-29" href="#__codelineno-145-29"></a><span class="w">            </span><span class="c1">//kprintf(&quot;c %d TO %d\n&quot;, current-&gt;pid, next-&gt;pid);</span>
</span><span id="__span-145-30"><a id="__codelineno-145-30" name="__codelineno-145-30" href="#__codelineno-145-30"></a><span class="w">            </span><span class="c1">//print_trapframe(next-&gt;tf);</span>
</span><span id="__span-145-31"><a id="__codelineno-145-31" name="__codelineno-145-31" href="#__codelineno-145-31"></a><span class="w">            </span><span class="c1">//kprintf(&quot;@@@@@@@@@@@@@@@@@@@@@@@@\n&quot;);</span>
</span><span id="__span-145-32"><a id="__codelineno-145-32" name="__codelineno-145-32" href="#__codelineno-145-32"></a><span class="w">            </span><span class="n">proc_run</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-145-33"><a id="__codelineno-145-33" name="__codelineno-145-33" href="#__codelineno-145-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-145-34"><a id="__codelineno-145-34" name="__codelineno-145-34" href="#__codelineno-145-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-145-35"><a id="__codelineno-145-35" name="__codelineno-145-35" href="#__codelineno-145-35"></a><span class="w">    </span><span class="n">local_intr_restore</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-145-36"><a id="__codelineno-145-36" name="__codelineno-145-36" href="#__codelineno-145-36"></a><span class="p">}</span>
</span><span id="__span-145-37"><a id="__codelineno-145-37" name="__codelineno-145-37" href="#__codelineno-145-37"></a>
</span><span id="__span-145-38"><a id="__codelineno-145-38" name="__codelineno-145-38" href="#__codelineno-145-38"></a><span class="kt">void</span>
</span><span id="__span-145-39"><a id="__codelineno-145-39" name="__codelineno-145-39" href="#__codelineno-145-39"></a><span class="nf">proc_run</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-40"><a id="__codelineno-145-40" name="__codelineno-145-40" href="#__codelineno-145-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-145-41"><a id="__codelineno-145-41" name="__codelineno-145-41" href="#__codelineno-145-41"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">intr_flag</span><span class="p">;</span>
</span><span id="__span-145-42"><a id="__codelineno-145-42" name="__codelineno-145-42" href="#__codelineno-145-42"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-145-43"><a id="__codelineno-145-43" name="__codelineno-145-43" href="#__codelineno-145-43"></a><span class="w">        </span><span class="n">local_intr_save</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-145-44"><a id="__codelineno-145-44" name="__codelineno-145-44" href="#__codelineno-145-44"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-145-45"><a id="__codelineno-145-45" name="__codelineno-145-45" href="#__codelineno-145-45"></a><span class="w">          </span><span class="c1">//panic(&quot;unimpl&quot;);</span>
</span><span id="__span-145-46"><a id="__codelineno-145-46" name="__codelineno-145-46" href="#__codelineno-145-46"></a><span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-145-47"><a id="__codelineno-145-47" name="__codelineno-145-47" href="#__codelineno-145-47"></a><span class="w">            </span><span class="c1">//load_sp(next-&gt;kstack + KSTACKSIZE);</span>
</span><span id="__span-145-48"><a id="__codelineno-145-48" name="__codelineno-145-48" href="#__codelineno-145-48"></a><span class="w">            </span><span class="n">lcr3</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="p">);</span>
</span><span id="__span-145-49"><a id="__codelineno-145-49" name="__codelineno-145-49" href="#__codelineno-145-49"></a><span class="w">            </span><span class="n">tlb_invalidate_all</span><span class="p">();</span><span class="w">       </span><span class="c1">//标注一下这里的tlb清空，待优化</span>
</span><span id="__span-145-50"><a id="__codelineno-145-50" name="__codelineno-145-50" href="#__codelineno-145-50"></a><span class="w">            </span><span class="n">switch_to</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
</span><span id="__span-145-51"><a id="__codelineno-145-51" name="__codelineno-145-51" href="#__codelineno-145-51"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-145-52"><a id="__codelineno-145-52" name="__codelineno-145-52" href="#__codelineno-145-52"></a><span class="w">        </span><span class="n">local_intr_restore</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-145-53"><a id="__codelineno-145-53" name="__codelineno-145-53" href="#__codelineno-145-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-145-54"><a id="__codelineno-145-54" name="__codelineno-145-54" href="#__codelineno-145-54"></a><span class="p">}</span>
</span></code></pre></div>
<p>proc_run会调用switch_to，switch_to会：</p>
<ol>
<li>将当前的context存储在prev-&gt;context中。（注意，context只包含s0-s8, sp, gp, ra）</li>
<li>恢复next-&gt;context</li>
<li>执行<code>j ra</code></li>
</ol>
<h6 id="init进程执行过程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#init进程执行过程">init进程执行过程</a></h6>
<p>通过kernel_thread(init_main, NULL, 0)创建init进程后</p>
<ol>
<li>
<p>cpu_idle中（idle进程中），执行schedule()，此时只有idle和init两个进程，因此调度到init进程执行proc_run。</p>
</li>
<li>
<p>执行switch_to，kernel_thread设置了context中的sp, ra。执行jr ra后，跳转到forkret</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-146-1"><a id="__codelineno-146-1" name="__codelineno-146-1" href="#__codelineno-146-1"></a><span class="c1">// forkret -- the first kernel entry point of a new thread/process</span>
</span><span id="__span-146-2"><a id="__codelineno-146-2" name="__codelineno-146-2" href="#__codelineno-146-2"></a><span class="c1">// NOTE: the addr of forkret is setted in copy_thread function</span>
</span><span id="__span-146-3"><a id="__codelineno-146-3" name="__codelineno-146-3" href="#__codelineno-146-3"></a><span class="c1">//       after switch_to, the current proc will execute here.</span>
</span><span id="__span-146-4"><a id="__codelineno-146-4" name="__codelineno-146-4" href="#__codelineno-146-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-146-5"><a id="__codelineno-146-5" name="__codelineno-146-5" href="#__codelineno-146-5"></a><span class="nf">forkret</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-146-6"><a id="__codelineno-146-6" name="__codelineno-146-6" href="#__codelineno-146-6"></a><span class="w">    </span><span class="n">forkrets</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-146-7"><a id="__codelineno-146-7" name="__codelineno-146-7" href="#__codelineno-146-7"></a><span class="p">}</span>
</span><span id="__span-146-8"><a id="__codelineno-146-8" name="__codelineno-146-8" href="#__codelineno-146-8"></a>
</span><span id="__span-146-9"><a id="__codelineno-146-9" name="__codelineno-146-9" href="#__codelineno-146-9"></a><span class="nl">forkrets</span><span class="p">:</span>
</span><span id="__span-146-10"><a id="__codelineno-146-10" name="__codelineno-146-10" href="#__codelineno-146-10"></a><span class="w">  </span><span class="n">addiu</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-146-11"><a id="__codelineno-146-11" name="__codelineno-146-11" href="#__codelineno-146-11"></a><span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="n">exception_return</span>
</span><span id="__span-146-12"><a id="__codelineno-146-12" name="__codelineno-146-12" href="#__codelineno-146-12"></a><span class="w">  </span><span class="n">nop</span>
</span></code></pre></div>
<ol>
<li>
<p>forkrets-&gt;exception_return从中断返回，弹出中断帧tf。CPU便会进入kernel_thread_entry，并以tf中指定的寄存器值执行</p>
</li>
<li>
<p>kernel_thread_entry跳转执行$a1即init_main</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-147-1"><a id="__codelineno-147-1" name="__codelineno-147-1" href="#__codelineno-147-1"></a>//kern/proc/entry.S
</span><span id="__span-147-2"><a id="__codelineno-147-2" name="__codelineno-147-2" href="#__codelineno-147-2"></a>kernel_thread_entry:        # void kernel_thread(void)
</span><span id="__span-147-3"><a id="__codelineno-147-3" name="__codelineno-147-3" href="#__codelineno-147-3"></a>  addiu $sp, $sp, -16
</span><span id="__span-147-4"><a id="__codelineno-147-4" name="__codelineno-147-4" href="#__codelineno-147-4"></a>  jal $a1
</span><span id="__span-147-5"><a id="__codelineno-147-5" name="__codelineno-147-5" href="#__codelineno-147-5"></a>  nop
</span><span id="__span-147-6"><a id="__codelineno-147-6" name="__codelineno-147-6" href="#__codelineno-147-6"></a>  move $a0, $v0
</span><span id="__span-147-7"><a id="__codelineno-147-7" name="__codelineno-147-7" href="#__codelineno-147-7"></a>  la  $t0, do_exit
</span><span id="__span-147-8"><a id="__codelineno-147-8" name="__codelineno-147-8" href="#__codelineno-147-8"></a>  jal $t0 
</span><span id="__span-147-9"><a id="__codelineno-147-9" name="__codelineno-147-9" href="#__codelineno-147-9"></a>  nop
</span><span id="__span-147-10"><a id="__codelineno-147-10" name="__codelineno-147-10" href="#__codelineno-147-10"></a>  /* never here */
</span></code></pre></div>
<h6 id="user_main的执行过程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#user_main的执行过程">user_main的执行过程</a></h6>
<ol>
<li>在init_main中，创建了user_main线程。然后init_main执行do_wait</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-148-1"><a id="__codelineno-148-1" name="__codelineno-148-1" href="#__codelineno-148-1"></a><span class="c1">// init_main - the second kernel thread used to create user_main kernel threads</span>
</span><span id="__span-148-2"><a id="__codelineno-148-2" name="__codelineno-148-2" href="#__codelineno-148-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-148-3"><a id="__codelineno-148-3" name="__codelineno-148-3" href="#__codelineno-148-3"></a><span class="nf">init_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-4"><a id="__codelineno-148-4" name="__codelineno-148-4" href="#__codelineno-148-4"></a><span class="w"> </span><span class="p">...</span>
</span><span id="__span-148-5"><a id="__codelineno-148-5" name="__codelineno-148-5" href="#__codelineno-148-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">user_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-148-6"><a id="__codelineno-148-6" name="__codelineno-148-6" href="#__codelineno-148-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-7"><a id="__codelineno-148-7" name="__codelineno-148-7" href="#__codelineno-148-7"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create user_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-148-8"><a id="__codelineno-148-8" name="__codelineno-148-8" href="#__codelineno-148-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-148-9"><a id="__codelineno-148-9" name="__codelineno-148-9" href="#__codelineno-148-9"></a>
</span><span id="__span-148-10"><a id="__codelineno-148-10" name="__codelineno-148-10" href="#__codelineno-148-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">do_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-148-11"><a id="__codelineno-148-11" name="__codelineno-148-11" href="#__codelineno-148-11"></a><span class="w">        </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-148-12"><a id="__codelineno-148-12" name="__codelineno-148-12" href="#__codelineno-148-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-148-13"><a id="__codelineno-148-13" name="__codelineno-148-13" href="#__codelineno-148-13"></a>
</span><span id="__span-148-14"><a id="__codelineno-148-14" name="__codelineno-148-14" href="#__codelineno-148-14"></a><span class="w">    </span><span class="n">fs_cleanup</span><span class="p">();</span>
</span><span id="__span-148-15"><a id="__codelineno-148-15" name="__codelineno-148-15" href="#__codelineno-148-15"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;all user-mode processes have quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-148-16"><a id="__codelineno-148-16" name="__codelineno-148-16" href="#__codelineno-148-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-148-17"><a id="__codelineno-148-17" name="__codelineno-148-17" href="#__codelineno-148-17"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>do_wait的作用是等待指定的或者任意一个（传入的pid为0）子线程进入ZOMBIE状态，释放子进程的内核栈空间和PCB空间。否则，自己进入睡眠状态SLEEPING，然后调用schedule()。</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-149-1"><a id="__codelineno-149-1" name="__codelineno-149-1" href="#__codelineno-149-1"></a><span class="c1">// do_wait - wait one OR any children with PROC_ZOMBIE state, and free memory space of kernel stack</span>
</span><span id="__span-149-2"><a id="__codelineno-149-2" name="__codelineno-149-2" href="#__codelineno-149-2"></a><span class="c1">//         - proc struct of this child.</span>
</span><span id="__span-149-3"><a id="__codelineno-149-3" name="__codelineno-149-3" href="#__codelineno-149-3"></a><span class="c1">// NOTE: only after do_wait function, all resources of the child proces are free.</span>
</span><span id="__span-149-4"><a id="__codelineno-149-4" name="__codelineno-149-4" href="#__codelineno-149-4"></a><span class="kt">int</span>
</span><span id="__span-149-5"><a id="__codelineno-149-5" name="__codelineno-149-5" href="#__codelineno-149-5"></a><span class="n">do_wait</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">code_store</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>
<p>schedule调用到user_main线程。和init一样，执行到user_main函数。</p>
</li>
<li>
<p>user_main函数调用了kernel_execv函数，实质为一次SYS_exec系统调用。</p>
</li>
<li>
<p>最后重新分配内核和用户空间，加载了sh用户程序。user_main线程从内核线程变为用户线程。</p>
</li>
<li>
<p>用户进程链接脚本user.ld指定了ENTRY(_start)。_start在user/libs/initcode.S中定义。</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-150-1"><a id="__codelineno-150-1" name="__codelineno-150-1" href="#__codelineno-150-1"></a>_start:
</span><span id="__span-150-2"><a id="__codelineno-150-2" name="__codelineno-150-2" href="#__codelineno-150-2"></a>    nop
</span><span id="__span-150-3"><a id="__codelineno-150-3" name="__codelineno-150-3" href="#__codelineno-150-3"></a>    la $gp, _gp
</span><span id="__span-150-4"><a id="__codelineno-150-4" name="__codelineno-150-4" href="#__codelineno-150-4"></a>    addiu $sp, $sp, -16
</span><span id="__span-150-5"><a id="__codelineno-150-5" name="__codelineno-150-5" href="#__codelineno-150-5"></a>    jal umain
</span><span id="__span-150-6"><a id="__codelineno-150-6" name="__codelineno-150-6" href="#__codelineno-150-6"></a>    nop
</span></code></pre></div>
<p>umain在user/libs/umain.c中定义</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-151-1"><a id="__codelineno-151-1" name="__codelineno-151-1" href="#__codelineno-151-1"></a><span class="kt">void</span>
</span><span id="__span-151-2"><a id="__codelineno-151-2" name="__codelineno-151-2" href="#__codelineno-151-2"></a><span class="nf">umain</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-151-3"><a id="__codelineno-151-3" name="__codelineno-151-3" href="#__codelineno-151-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-151-4"><a id="__codelineno-151-4" name="__codelineno-151-4" href="#__codelineno-151-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initfd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stdin:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-151-5"><a id="__codelineno-151-5" name="__codelineno-151-5" href="#__codelineno-151-5"></a><span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;open &lt;stdin&gt; failed: %e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-151-6"><a id="__codelineno-151-6" name="__codelineno-151-6" href="#__codelineno-151-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-151-7"><a id="__codelineno-151-7" name="__codelineno-151-7" href="#__codelineno-151-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initfd</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stdout:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-151-8"><a id="__codelineno-151-8" name="__codelineno-151-8" href="#__codelineno-151-8"></a><span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;open &lt;stdout&gt; failed: %e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-151-9"><a id="__codelineno-151-9" name="__codelineno-151-9" href="#__codelineno-151-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-151-10"><a id="__codelineno-151-10" name="__codelineno-151-10" href="#__codelineno-151-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</span><span id="__span-151-11"><a id="__codelineno-151-11" name="__codelineno-151-11" href="#__codelineno-151-11"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-151-12"><a id="__codelineno-151-12" name="__codelineno-151-12" href="#__codelineno-151-12"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="ide_init--fs_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#ide_init--fs_init">ide_init &amp; fs_init</a></h5>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-20 23:52:30">2020年9月20日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 6 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-lab3-总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/">ucore lab3 总结</a></h2>
<h4 id="目录"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/#目录">目录</a></h4>
<ol>
<li>x86中断/异常处理(tss和tf作用)</li>
<li>重要函数说明<ol>
<li>创建进程(线程)</li>
<li>调度，运行</li>
<li>do_wait &amp; do_exit</li>
<li>do_execve</li>
<li>其它系统调用</li>
</ol>
</li>
<li>FAQ<ol>
<li>一个进程被创建后如何开始执行？ </li>
<li>一个用户进程如果因为时间片用完而被调度掉后，再次被调度回来时会从哪里继续执行？ </li>
<li>一个进程的完整生命周期？ </li>
<li>fork调用，为什么父进程返回值为pid，子进程返回值为0（<strong>涉及到用户进程的创建</strong>）</li>
</ol>
</li>
</ol>
<h4 id="总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/#总结">总结</a></h4>
<p>实验3涉及到的知识点：</p>
<ol>
<li>x86中断中tss的作用（类似的内核栈，中断帧的概念）</li>
<li>进程如何创建、执行、切换（do_fork, do_wait, do_exit等系统调用的设计与实现）</li>
<li>用户进程的创建、执行过程</li>
<li>用户ulib库fork, wait, exit的实现</li>
</ol>

    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2020/09/20/2020-09-20-ucore-lab3-%E6%80%BB%E7%BB%93/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-09-14 20:59:11">2020年9月14日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-lab2总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/09/14/2020-09-14-ucore-lab2%E6%80%BB%E7%BB%93/">ucore lab2总结</a></h2>
<h3 id="概述"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/09/14/2020-09-14-ucore-lab2%E6%80%BB%E7%BB%93/#概述">概述</a></h3>
<p>回顾实验1，我觉得需要学习的知识有：</p>
<ol>
<li><strong>gdb</strong>工具的使用</li>
<li><strong>ELF</strong>文件的格式，以及readelf, objdump, objcopy工具的使用（查看各个section，查看符号表）</li>
<li>x86汇编基础（通用寄存器，段寄存器，EIP，EFLAG等），GCC<strong>内联汇编</strong>格式（AT&amp;T格式）</li>
<li>x86内存<strong>分段</strong>机制（GDT表，段描述符）</li>
<li>x86<strong>中断</strong>处理机制（IDT表，中断向量 -&gt; 中断处理程序）</li>
<li>操作系统启动过程（BIOS-&gt;bootloader(第一扇区)-&gt;Kernel各阶段做的事情）</li>
</ol>
<p>而做完实验2后，我觉得需要学习的知识有：</p>
<ol>
<li>BIOS探测物理内存，Kernel打开分页时自带一个页表</li>
<li><strong>二级页表</strong>进行虚拟地址转换</li>
<li>物理内存管理 之 <strong>空闲块</strong>(以页为单位)管理（Page数据结构和物理页的对应，空闲块链表free_list，FirstHit分配连续的物理页）</li>
<li>虚拟内存管理 之 <strong>有效虚拟页</strong>（表示一个程序可能使用的虚拟地址段，vma, mm数据结构）</li>
<li>导致<strong>PageFault</strong>的原因（1. pte=0即从来没有被加载过, 2. 被swap out, 3. 访问权限错误）</li>
<li><strong>FIFO页替换</strong>算法实现（page struct增加pra_page_link, pra_vaddr，mm-&gt;sm_priv(<strong>pra_list_header</strong>)记录最近使用的页序列；swap_manager）</li>
</ol>
<p>以下介绍一些难点</p>

    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2020/09/14/2020-09-14-ucore-lab2%E6%80%BB%E7%BB%93/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-05-31 22:50:15">2020年5月31日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="编译原理总结"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/">编译原理总结</a></h2>
<h3 id="目前我眼中的计算机层次"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/#目前我眼中的计算机层次">目前我眼中的计算机层次：</a></h3>
<ul>
<li>计算机体系结构（RTL级设计，流水线，缓存，多发射）</li>
<li>ISA （访存模式，中断/异常）</li>
<li>汇编语言（寄存器+内存空间）</li>
<li>高级语言 （编译器）</li>
<li>操作系统（内核：进程调度，同步与死锁，内存管理：页表，文件系统 
    应用：桌面系统，浏览器）</li>
</ul>
<h3 id="编译器各阶段"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/#编译器各阶段">编译器各阶段</a></h3>
<ol>
<li>
<p><strong>词法分析</strong>：解析源代码文件，输出记号流。
记号即指一个有独立意义的“单词”。空白字符便一般不包含意义，故可以省略。
这些单词一般可分类为：标识符，常数（整数，浮点数），字符常量，字符串，
操作符，界符，关键字。</p>
</li>
<li>
<p><strong>语法分析</strong>：分析记号流，输出程序的逻辑结构，如语法分析树（或AST树）
一种语言的语法规则可以被文法产生式完全定义。
文法一般包括表达式的定义，各种语句的定义（if, while, for），变量声明，
函数定义等。</p>
</li>
</ol>

    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2020/05/31/2020-05-31-%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-10-21 20:42:13">2019年10月21日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第7章-作业-死锁"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/">操作系统第7章 作业 死锁</a></h2>
<hr />
<h3 id="1"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/#1">1、</a></h3>
<p>Consider the traffic deadlock depicted in follow figure.</p>
<p><img alt="deadlock car" src="../../images/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/deadlock_car.png" /> </p>
<p>a. Show that the four necessary conditions for deadlock indeed hold in this example.
b. State a simple rule for avoiding deadlocks in this system.</p>
<ul>
<li>a.<ol>
<li>mutual exclusion: 每条道路都只能让一个方向的车通行，且车之间不可能<strong>穿透而过</strong>。</li>
<li>hold and wait: 四个方向的车辆都占有一条道路，并等待另一方向的车露出空隙。</li>
<li>no preemption: 每个方向的车都必须等待另一个方向的车主动倒车，无法强迫。</li>
<li>circular wait： 每个方向的车互相等待，形成一个环。</li>
</ol>
</li>
<li>b. 安排一位交警选择并指挥一个方向的车让出道路。</li>
</ul>
<h3 id="2"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/#2">2、</a></h3>
<p>Consider a system consisting of four resources of the same type that are shared by three processes, each of which needs at most two resources. Show that the system is deadlock free.</p>
<p>答：反证法，假设形成了死锁。则由每个进程最多需求2个资源实例，和死锁必要条件中的3，4点可知，唯一的情形是：三个进程各自占有一个资源且等待另一个资源，并形成了一个环。而在该情况下，剩余的一个资源导致死锁不会发生。</p>
<h3 id="3"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/#3">3、</a></h3>
<p>Consider a system consisting of m resources of the same type being shared by n processes. Resources can be requested and released by processes only one at a time. Show that the system is deadlock free if the following two conditions hold:</p>
<ul>
<li>a. The maximum need of each process is between 1 and m resources.</li>
<li>b. The sum of all maximum needs is less than m + n.</li>
</ul>
<p>$ a. \sum_{i=1}^n Max_i &lt; m+n $
$ b. Max_i \geq 1 for all i $
$ c. Need_i = Max_i − Allocation_i $</p>
<p>If there exists a deadlock state then:
$ d. \sum_{i=1}^n Allocation_i = m $</p>
<p>$ a,b,c,d \Rightarrow \sum_{i=1}^n Need_i &lt; n $</p>
<p>This implies that there exists a process $ P_i $ such that $ Need_i = 0 $. Since $ Max_i &gt;= 1 $, it follows that $ P_i $ has at least one resource, the deadlock can't maintain. </p>
<h3 id="4"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/#4">4、</a></h3>
<p>Consider the following snapshot of a system:</p>
<table>
<thead>
<tr>
<th>PID</th>
<th>AL.</th>
<th></th>
<th></th>
<th></th>
<th>MAX</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>A</td>
<td>B</td>
<td>C</td>
<td>D</td>
<td>A</td>
<td>B</td>
<td>C</td>
<td>D</td>
</tr>
<tr>
<td>P0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>P1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>7</td>
<td>5</td>
<td>0</td>
</tr>
<tr>
<td>P2</td>
<td>1</td>
<td>3</td>
<td>5</td>
<td>4</td>
<td>2</td>
<td>3</td>
<td>5</td>
<td>6</td>
</tr>
<tr>
<td>P3</td>
<td>0</td>
<td>6</td>
<td>3</td>
<td>2</td>
<td>0</td>
<td>6</td>
<td>5</td>
<td>2</td>
</tr>
<tr>
<td>P4</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>4</td>
<td>0</td>
<td>6</td>
<td>5</td>
<td>6</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>AV.</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>B</td>
<td>C</td>
<td>D</td>
</tr>
<tr>
<td>1</td>
<td>5</td>
<td>2</td>
<td>0</td>
</tr>
</tbody>
</table>
<p><em>(p.s. AL.= Allocated:, AV.= Available)</em></p>
<p>Answer the following questions using the banker's algorithm:
a. What is the content of the matrix Need?
b. Is the system in a safe state?
c. If a request from process $ P_1 $ arrives for (0,4,2,0), can the request be granted immediately?</p>
<ul>
<li>a
    | PID | need |   |   |   |
    | --- | --- | - | - | - |
    |     | A   | B | C | D |
    | P0  | 0   | 0 | 0 | 0 |
    | P1  | 0   | 7 | 5 | 0 |
    | P2  | 1   | 0 | 0 | 2 |
    | P3  | 0   | 0 | 2 | 0 |
    | P4  | 0   | 6 | 4 | 2 |</li>
<li>b 由银行家算法可知是安全的，序列<span class="arithmatex">\(&lt;0,2,1,3,4&gt;\)</span>为安全序列。</li>
<li>c 假设满足，则$ Need_{P_1} =(0,11,7,0) <span class="arithmatex">\(，序列\)</span> &lt;0,2,3,4,1&gt; $为安全序列，故可立即满足。</li>
</ul>
<h3 id="5"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/#5">5、</a></h3>
<p>Consider a system with four processes$ P_1, P_2, P_3$ and $ P_4 $, and two resources, $ R_1, R_2 $ respectively. Each resource has two instances. Furthermore:</p>
<p>$ P_1 $ allocates an instance of $ R_2 $  , and requests an instance of $ R_1 $ ;
$ P_2 $  allocates an instance of $ R_1 $ , and doesn’t need any other resource;
$ P_3 $  allocates an instance of $ R_1 $ and requires an instance of $ R_2 $ ;
$ P_4 $  allocates an instance of $ R_2 $ , and doesn’t need any other resource.
Answer the following questions:</p>
<p>a. Draw the resource allocation graph.
b. Is there a cycle in the graph? If yes name it. 
c. Is the system in deadlock? If yes, explain why. If not, give a possible sequence of executions after which every process completes.</p>
<ul>
<li>a. 略</li>
<li>b. 存在</li>
<li>c. 不是，$ <P_1, P_4, P_2, P_3,> $ </li>
</ul>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/10/21/2019-10-21-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E4%B8%83%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E6%AD%BB%E9%94%81/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-10-16 15:19:21">2019年10月16日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第六章作业-进程同步"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/">操作系统第六章作业 进程同步</a></h2>
<h4 id="1-what-is-the-meaning-of-the-term-busy-waiting"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#1-what-is-the-meaning-of-the-term-busy-waiting">1. What is the meaning of the term busy waiting?</a></h4>
<p>当一个进程位于临界区时，任何其它试图进入临界区的进程都必须在代码中不断地循环。</p>
<h4 id="2-what-is-the-meaning-of-the-term-spinlocks"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#2-what-is-the-meaning-of-the-term-spinlocks">2. What is the meaning of the term spinlocks?</a></h4>
<p>自旋锁是一种会造成忙等的信号量，在进程等待锁时还需不断运行，占用cpu资源。</p>
<h4 id="3-explain-the-deadlock-and-give-an-example"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#3-explain-the-deadlock-and-give-an-example">3. Explain the deadlock and give an example.</a></h4>
<p>若干个进程竞争系统资源，最后每个进程都必须得在其它进程释放资源时才能改变状态，因而无法改变状态，造成死锁。
如以下程序在A，B同时运行时造成死锁。
A:
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">wait</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="p">...</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="n">signal</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="n">signal</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
</span></code></pre></div>
B:
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="n">wait</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="p">...</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="n">signal</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="n">signal</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="4"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#4">4.</a></h4>
<p>Servers can be designed to limit the number of open connections. For example, a server may wish to have only N socket connections at any point in time. As soon as N connections are made, the server will not accept another incoming connection until an existing connection is released. Explain how semaphores can be used by a server to limit the number of concurrent connections. (6.8)</p>
<p>初始化计数型信号量connection=N
<div class="language-C highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">wait</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="c1">//do something</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="n">signal</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
</span></code></pre></div></p>
<h4 id="5-what-operations-can-be-performed-on-a-semaphore-list-them-and-explain-the-means-of-semaphore-values"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#5-what-operations-can-be-performed-on-a-semaphore-list-them-and-explain-the-means-of-semaphore-values">5. What operations can be performed on a semaphore? List them and explain the means of semaphore values.</a></h4>
<p>wait()和signal()操作。
信号量可分为计数信号量与二进制信号量。计数信号量值域不受限制，代表系统受限资源的数量。
二进制信号量的值只能为0或1，可表示对临界区的访问权（只能有一个进程位于临界区）。</p>
<h4 id="6-how-does-the-signal-operation-associated-with-monitors-differ-from-the-corresponding-operation-defined-for-semaphores-616"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#6-how-does-the-signal-operation-associated-with-monitors-differ-from-the-corresponding-operation-defined-for-semaphores-616">6. How does the signal() operation associated with monitors differ from the corresponding operation defined for semaphores? (6.16)</a></h4>
<p>当没有进程等待时，信号量的signal()会对信号量的值加一，而管程里的signal()则不会进行任何操作。</p>
<h4 id="7"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#7">7.</a></h4>
<p>A uniprocessor system concurrently executes 2 processes ($ P_A, P_B $). Two Semaphores $ Mutex_R_a $ and $ Mutex_R_b $ are added in mutual accessing the critical section and synchronizing between $ P_A $ and $ P_B $ . Please read following program segment carefully and answer the questions:</p>
<p>(1) What are initial values for $ Mutex_R_a $ and $ Mutex_R_b $ .
(2) Is it possible to cause deadlock? Please state your reason.
Semaphore $ Mutex_R_a $, $ Mutex_R_b $ ;
<div class="language-C highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">Void</span><span class="w"> </span><span class="nf">P_A</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">        </span><span class="n">Wait</span><span class="p">(</span><span class="n">Mutex_Ra</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">        </span><span class="p">......</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">        </span><span class="n">Wait</span><span class="p">(</span><span class="n">Mutex_Rb</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">        </span><span class="p">......</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">        </span><span class="n">Signal</span><span class="p">(</span><span class="n">Mutex_Ra</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">        </span><span class="p">......</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">        </span><span class="n">Signal</span><span class="p">(</span><span class="n">Mutex_Rb</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-C highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">Void</span><span class="w"> </span><span class="nf">P_B</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">){</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">        </span><span class="n">Wait</span><span class="p">(</span><span class="n">Mutex_Rb</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="p">......</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">        </span><span class="n">Wait</span><span class="p">(</span><span class="n">Mutex_Ra</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">        </span><span class="p">......</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">        </span><span class="n">Signal</span><span class="p">(</span><span class="n">Mutex_Rb</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">        </span><span class="p">......</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">        </span><span class="n">Signal</span><span class="p">(</span><span class="n">Mutex_Ra</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="p">}</span>
</span></code></pre></div>
答：
(1) $ Mutex_R_a = Mutex_R_b = 1$
(2) 当P_A和P_B同时到达时，两个进程都会执行第一句，接着便会由于$ Mutex_R_a = Mutex_R_b = 0$而陷入死锁。</p>
<h4 id="8"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/#8">8.</a></h4>
<p>设有一个可以装 A、B 两种物品的仓库,其容量有限(为 N),但要求仓库中 A、B 两 种物品的数量满足下述不等式:
$$
   -M≤A 物品数量-B 物品数量≤N 
$$
其中 M 和 N 为正整数。另外,还有一个进程消费 A 和 B,一次取一个 A 与 B 组装成 C。
试用信号量和 P、V 操作描述 A、B 两种物品的入库和出库(组装成 C)过程。</p>
<p>答：
设nA, nB分别为A物品，B物品数量，二进制信号量mutex，<strong>初始值</strong>为1。</p>
<p>A入库进程：
<div class="language-C highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="n">nA</span><span class="o">++</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">if</span><span class="p">(</span><span class="n">nA</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nA</span><span class="o">-</span><span class="n">nB</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="n">A入库</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="k">else</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="n">nA</span><span class="o">--</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span></code></pre></div></p>
<p>B入库进程：
<div class="language-C highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">nB</span><span class="o">++</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">if</span><span class="p">(</span><span class="n">nB</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">-</span><span class="n">M</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">nA</span><span class="o">-</span><span class="n">nB</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">N</span><span class="p">)</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="n">B入库</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="k">else</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">    </span><span class="n">nB</span><span class="o">--</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span></code></pre></div></p>
<p>C出库进程：
<div class="language-C highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="n">wait</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">if</span><span class="p">(</span><span class="n">nA</span><span class="o">&gt;</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">nB</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">nA</span><span class="o">--</span><span class="p">;</span><span class="n">nB</span><span class="o">--</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="n">C出库</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">signal</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span></code></pre></div></p>
<p>changed:
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="n">semaphore</span><span class="w"> </span><span class="n">initiation</span><span class="o">:</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="n">muxtex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="n">empty</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">N</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="n">delta</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">M</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">    </span><span class="n">nA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="n">progress</span><span class="w"> </span><span class="n">A</span><span class="o">:</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="k">do</span><span class="p">{</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="n">A</span><span class="w"> </span><span class="n">in</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">nA</span><span class="p">)</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="n">progress</span><span class="w"> </span><span class="n">B</span><span class="o">:</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="k">do</span><span class="p">{</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a><span class="w">        </span><span class="n">B</span><span class="w"> </span><span class="n">in</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">nB</span><span class="p">)</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="n">progress</span><span class="w"> </span><span class="n">C</span><span class="o">:</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="k">do</span><span class="p">{</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">nA</span><span class="p">)</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">nB</span><span class="p">)</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">    </span><span class="n">P</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">        </span><span class="n">C</span><span class="w"> </span><span class="n">out</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">mutex</span><span class="p">)</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="w">    </span><span class="n">V</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a><span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
</span></code></pre></div></p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/10/16/2019-10-16-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%AC%AC%E5%85%AD%E7%AB%A0%E4%BD%9C%E4%B8%9A-%E8%BF%9B%E7%A8%8B%E5%90%8C%E6%AD%A5/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-10-08 09:53:42">2019年10月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 2 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第五章作业-cpu调度"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/">操作系统第五章作业 CPU调度</a></h2>
<hr />
<h4 id="51-why-is-it-important-for-the-scheduler-to-distinguish-io-bound-programs-from-cpu-bound-programs"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/#51-why-is-it-important-for-the-scheduler-to-distinguish-io-bound-programs-from-cpu-bound-programs">5.1. Why is it important for the scheduler to distinguish I/O-bound programs from CPU-bound programs?</a></h4>
<p>对于长期调度程序，知道进程是IO约束的还是CPU约束的之后，便可以按照一定比例组合被调度的进程，使得CPU和IO设备都会一直处于负载状态，从而提高资源的使用率。
对于短期调度（CPU调度），IO约束的进程CPU区间都比较短，而CPU越苏进程则比较长，因而根据最短作业优先准则，可以优先调度IO约束进程。</p>
<h4 id="52-discuss-how-the-following-pairs-of-scheduling-criteria-conflict-in-certain-settings"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/#52-discuss-how-the-following-pairs-of-scheduling-criteria-conflict-in-certain-settings">5.2. Discuss how the following pairs of scheduling criteria conflict in certain settings.</a></h4>
<ul>
<li>
<p>a. CPU utilization and response time
CPU利用率与上下文交换频率成负相关，而响应时间与之成正相关，故冲突。</p>
</li>
<li>
<p>b. Average turnaround time and maximum waiting time
为了减小平均周转时间，通常会采用短作业优先算法，而这会令长作业的等待时间增大。</p>
</li>
<li>
<p>c. I/O device utilization and CPU utilization
为了提高I/O设备的利用率，需要优先执行IO bound进程，因为IO约束的进程CPU区间短，因而导致频繁的上下文交换，因而降低CPU效率。</p>
</li>
</ul>
<h4 id="54-consider-the-following-set-of-processes-with-the-length-of-the-cpu-burst-time-given-in-milliseconds"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/#54-consider-the-following-set-of-processes-with-the-length-of-the-cpu-burst-time-given-in-milliseconds">5.4 Consider the following set of processes, with the length of the CPU-burst time given in milliseconds:</a></h4>
<table>
<thead>
<tr>
<th>Process</th>
<th>Burst Time</th>
<th>Priority</th>
</tr>
</thead>
<tbody>
<tr>
<td>$ P_1 $</td>
<td>10</td>
<td>3</td>
</tr>
<tr>
<td>$ P_2 $</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>$ P_3 $</td>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>$ P_4 $</td>
<td>1</td>
<td>4</td>
</tr>
<tr>
<td>$ P_5 $</td>
<td>5</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>The processes are assumed to have arrived in the order $ P_1,P_2,P_3,P_4,P_5 $, all at time 0.
- a. Draw four Gantt charts illustrating the execution of these processes using FCFS , SJF , a nonpreemptive priority (a smaller priority number implies a higher priority), and RR (quantum = 1) scheduling.
    1. FCFS
        $ P_1 $ (10) &emsp;&emsp;&emsp;&emsp;&emsp; | $ P_2 $(1) &ensp; | $ P_3 $(2) &emsp; | $ P_4 <span class="arithmatex">\((1) &ensp; |\)</span> P_5 $  (5) &emsp;&emsp;&ensp;
        --- | --- | --- | --- | ---
    2. SJF
        $ P_2 $(1) &ensp;  | $ P_4 $(1) &ensp; | $ P_3 $(2) &emsp; | $ P_5 $  (5) &emsp;&emsp;&ensp; | $ P_1 $ (10) &emsp;&emsp;&emsp;&emsp;&emsp;
        --- | --- | --- | --- | ---
    3. nopreemptive priority
        $ P_2 $(1) &ensp;  | $ P_5 $  (5) &emsp;&emsp;&ensp; | $ P_1 $ (10) &emsp;&emsp;&emsp;&emsp;&emsp; | $ P_3 $(2) &emsp; | $ P_4 $(1) &ensp;
        --- | --- | --- | --- | ---
    4. Round Robin
        $ P_1 $| $ P_2 $ | $ P_3 $ | $ P_4 $ |$ P_5 $ | $ P_1 $| $ P_3 $ | $ P_5 $ | $ P_1 $ |$ P_5 $ | $ P_1 $ | $ P_5 $ | $ P_1 $ | $ P_5 $ | $ P_1 $ | $ P_1 $ | $ P_1 $ | $ P_1 $ | $ P_1 $ |
        --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
- b. What is the turnaround time of each process for each of the scheduling algorithms in part a?</p>
<div class="language-text highlight"><pre><span></span><code>&amp;ensp;  | FCFS  | SJF   | nopreemptive priority     | RR
---     | ---   | ---   | ---                       | --- 
$ P_1 $ | 10    | 19    | 16                        | 19
$ P_2 $ | 11    | 1     | 1                         | 2
$ P_3 $ | 13    | 4     | 18                        | 7
$ P_4 $ | 14    | 2     | 19                        | 4
$ P_5 $ | 19    | 9     | 6                         | 14
</code></pre></div>
<ul>
<li>
<p>c. What is the waiting time of each process for each of the scheduling algorithms in part a?</p>
<table>
<thead>
<tr>
<th>&ensp;</th>
<th>FCFS</th>
<th>SJF</th>
<th>nopreemptive priority</th>
<th>RR</th>
</tr>
</thead>
<tbody>
<tr>
<td>$ P_1 $</td>
<td>0</td>
<td>9</td>
<td>6</td>
<td>9</td>
</tr>
<tr>
<td>$ P_2 $</td>
<td>10</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td>$ P_3 $</td>
<td>11</td>
<td>2</td>
<td>16</td>
<td>5</td>
</tr>
<tr>
<td>$ P_4 $</td>
<td>13</td>
<td>1</td>
<td>18</td>
<td>3</td>
</tr>
<tr>
<td>$ P_5 $</td>
<td>14</td>
<td>4</td>
<td>1</td>
<td>9</td>
</tr>
<tr>
<td>sum</td>
<td>48</td>
<td>16</td>
<td>41</td>
<td>27</td>
</tr>
<tr>
<td>- d. Which of the schedules in part a results in the minimal average waiting time (over all processes)?</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>答： SJF with 3.2 ms</p>
<h4 id="510-explain-the-differences-in-the-degree-to-which-the-following-scheduling-algorithms-discriminate-in-favor-of-short-processes"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/#510-explain-the-differences-in-the-degree-to-which-the-following-scheduling-algorithms-discriminate-in-favor-of-short-processes">5.10 Explain the differences in the degree to which the following scheduling algorithms discriminate in favor of short processes:</a></h4>
</li>
<li>
<p>a. FCFS</p>
</li>
<li>b. RR</li>
<li>c. Multilevel feedback queues</li>
</ul>
<p>答：
- FCFS哪个先到哪个优先，因此对待短进程和长进程是平等的。
- RR给每个进程分配相同的时间片，因此也是平等的。
- 对于一种典型的多级反馈队列算法（有三个队列，前两个使用RR算法，时间片分别为8ms，16ms，第三个使用FCFS算法，队列间使用抢占式优先级算法），短作业都会处于前面的队列，以此短作业的优先级更高。</p>
<h4 id="5-please-prove-sjf-gives-the-minimum-average-waiting-time-for-a-given-set-of-processes-to-arrive-at-the-same-time"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/#5-please-prove-sjf-gives-the-minimum-average-waiting-time-for-a-given-set-of-processes-to-arrive-at-the-same-time">5. Please prove: SJF gives the minimum average waiting time for a given set of processes to arrive at the same time.</a></h4>
<p>假设CPU按照一定顺序执行这些进程，每个进程CPU区间分别为$ t_1,t_2,\dots,t_n $。（非抢占）
则平均等待时间为：
$$
    \overline t = \frac{1}{n}\sum_{i=1}^n{(i-1)t_i}
$$
由排序不等式知$ t_1,t_2,\dots,t_n $降序时最短，即SJF算法。</p>
<h4 id="6-what-is-processor-affinity-what-is-load-balancing-what-is-the-relationship-between-the-two"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/#6-what-is-processor-affinity-what-is-load-balancing-what-is-the-relationship-between-the-two">6. What is Processor Affinity? What is load balancing? What is the relationship between the two?</a></h4>
<p>处理器亲和性指在多处理器调度算法中，由于cache miss的代价比较高，应该努力让一个进程在一个处理器上运行。
而负载平衡指将工作负载平均分配到每个处理器上，从而保持每个处理器使用率都比较高。
因此当一个处理器负载较高时，负载平平衡策略会倾向让负载分配到多个处理器上，而处理器亲和则倾向保持该状态。
因此这两种策略有矛盾的关系。</p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/10/08/2019-10-08-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E7%AC%AC%E4%BA%94%E7%AB%A0%E4%BD%9C%E4%B8%9A-CPU%E8%B0%83%E5%BA%A6/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-23 21:53:24">2019年9月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第三章-作业"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/">操作系统第三章 作业</a></h2>
<h4 id="41"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/#41">4.1</a></h4>
<p>Provide two programming examples in which multithreading does not provide better performance than a single-threaded solution.</p>
<p>1) 任何“线性”执行的程序（后面的程序严重依赖前面执行的结果），这类程序即使使用多线程，每个线程都会阻塞其它线程的执行，因此并不会有更好的性能。</p>
<p>2) 只执行单一任务的程序。多线程对于浏览器，字处理软件等多任务软件是有用的。如浏览器可以在接收网络数据时同时刷新页面。但对于只执行单个任务的程序，便没有必要。</p>
<h4 id="42"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/#42">4.2</a></h4>
<p>Describe the actions taken by a thread library to context switch between user-level threads.</p>
<p>用户级线程库的代码都存在于用户空间，因此调用库中的函数会导致一个本地调用而不是系统调用。因为线程主要包括寄存器的值和栈，因此上下文切换会涉到寄存器和栈状态的保存和恢复。</p>
<h4 id="43"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/#43">4.3</a></h4>
<p>Under what circumstances does a multithreaded solution using multiple kernel threads provide better performance than a single-threaded solution on a single-processor system?</p>
<p>1）一个应用程序分为许多不同的部分。如网页浏览器有一个线程用于显示图像和文本，另一个用于从网络接收数据。
2）一个应用程序需要执行多个相似的任务。如网页服务器可能要处理上千个客户并发请求网页。</p>
<h4 id="44"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/#44">4.4</a></h4>
<p>Which of the following components of program state are shared across threads in a multithreaded process?</p>
<ul>
<li>a. Register values</li>
<li>b. Heap memory</li>
<li>c. Global variables</li>
<li>d. Stack memory</li>
</ul>
<p>答： b,c</p>
<h4 id="48"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/#48">4.8</a></h4>
<p>Consider a multiprocessor system and a multithreaded program written using the
many-to-many threading model. Let the number of user-level threads in the program be more
than the number of processors in the system. Discuss the performance implications of the
following scenarios.</p>
<p><strong>a.</strong> The number of kernel threads allocated to the program is less than the number of
processors.</p>
<p><strong>b.</strong> The number of kernel threads allocated to the program is equal to the number of
processors.</p>
<p><strong>c.</strong> The number of kernel threads allocated to the program is greater than the number of
processors but less than the number of user-level threads.</p>
<p>答：当内核线程小于处理器数目时，因为用户线程只能通过内核线程访问处理器，因此会有一些处理器处于“围观”状态。当内核线程刚好等于处理器时，处理器的效率相对于a会提高，然而当一个线程执行了阻塞系统调用时，其它用户线程就无法使用该内核进程，c的情况则弥补了这一点，当一个用户线程阻塞时可以被其它用户线程替换，因此处理器效率最高。</p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter4-%E4%BD%9C%E4%B8%9A/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-23 21:52:51">2019年9月23日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第三章-作业"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/">操作系统第三章 作业</a></h2>
<h4 id="31"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#31">3.1</a></h4>
<p>Describe the differences among short-term, medium-term, and long-term scheduling.</p>
<ul>
<li>短期调度
从内存中的就绪队列里选择一个进程执行。执行最为频繁，为保证执行时间短，因而调度算法不能太复杂。</li>
<li>长期调度
也称为工作调度，决定从磁盘中将哪些进程放入内存。因为执行很不频繁，所以可以使用更复杂的调度算法，从而使内存中进程的CPU使用和I/O使用更均衡，资源利用率更高。</li>
<li>中期调度
有交换的机制，即将进程从内存中移除，并在适当时间再次将其调入内存。这有助于动态改善进程组合，使CPU和I/O使用更均衡。</li>
</ul>
<h4 id="32"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#32">3.2</a></h4>
<p>Describe the actions taken by a kernel to context-switch between processes.</p>
<p>进程间的上下文切换，即切换到另一个进程时需要保留当前进程的状态并恢复另一进程的状态。这些状态可以用PCB即进程控制块表示，包含进程状态，程序计数器，CPU寄存器等信息。上下文切换时，主要执行一个状态保存和状态恢复过程，可能还要执行一些体系结构有关的操作比如清除cache等。</p>
<h4 id="3a"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#3a">3.A</a></h4>
<p>Consider a computer with N processors in a multiprocessor configuration.</p>
<p><strong>a.</strong> How many processes can be in each of the Ready, Running, and Waiting states at one time?
答：若干个就绪阶段，不超过N个执行阶段，若干个等待阶段。
<strong>b.</strong> What is the minimum number of processes that can be in each of the Ready, Running, and Waiting states at one time?
答：<strong>最少当然都是0个？</strong></p>
<h4 id="3b"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#3b">3.B</a></h4>
<p>Please explain the five states of a process.</p>
<ul>
<li>
<p>new: 进程刚被创建时，处于此阶段。如linux中fork系统调用创建新进程时。</p>
</li>
<li>
<p>ready: 进程执行等待被分配到CPU中执行。</p>
</li>
<li>
<p>run: 进程正在被执行。</p>
</li>
<li>
<p>waiting: 进程由于需要等待I/O等设备的数据，而不能执行，被放置对应设备的等待队列中。</p>
</li>
<li>
<p>terminated: 进程执行结束，正在释放进程的PCB。</p>
</li>
</ul>
<h4 id="3c"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#3c">3.C</a></h4>
<p>what is the role of PCB in OS? What information is contained in PCB?
操作系统对进程的创建、删除、调度都是通过对PCB的操作来完成的。
PCB包含：
* 进程状态
* 程序计数器
* cpu寄存器
* cpu调度信息：如进程优先级，调度队列指针等。
* 内存管理信息：基址，页表或段表等。
* accounting info: cpu时间时间，时间界限，进程数等。
* I/O状态信息：分配的I/O列表，打开的文件列表等待。</p>
<h4 id="3d"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#3d">3.D</a></h4>
<p>When a process is created, the operating system needs to be done?
* 给新进程分配物理和逻辑资源（CPU时间，内存，文件，I/O设备，可来自操作系统或继承父进程资源）
* 传递初始化数据</p>
<h4 id="3e"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/#3e">3.E</a></h4>
<p>Please list the differences between message passing system and shared memory system.
* 共享内存系统基本只能在同一台计算机（可多核）两进程传递信息，而信息传递系统既可以是同一台计算机也可以是通过网络连接的不同计算机间进程传递信息。
* 共享内存系统只需为进程分配共享内存，通信由进程负责，而信息传递系统需要操作系统参与进行进程间的信息传递。</p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/09/23/2019-09-23-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter3-%E4%BD%9C%E4%B8%9A/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 14:59:19">2019年9月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第二章-作业"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter2-%E4%BD%9C%E4%B8%9A.md/">操作系统第二章 作业</a></h2>
<h3 id="22"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter2-%E4%BD%9C%E4%B8%9A.md/#22">2.2</a></h3>
<p>List five services provided by an operating system that are designed to
make it more convenient for users to use the computer system. In what
cases it would be impossible for user-level programs to provide these
services? Explain.</p>
<p><strong>1 程序执行</strong>
服务：操作系统将程序装载入内存并执行程序。
若使用用户程序提供该服务，则很有可能带来安全隐患，因为应用程序可能会装载非法程序。</p>
<p><strong>2 I/O操作</strong>
服务：系统提供方便操作I/O设备的方法。
若使用用户程序提供该服务，在多用户系统中，应用程序可能会窃取其它用户存储在硬盘里的数据。</p>
<p><strong>3 文件系统操作</strong>
服务：提供文件的，创建、删除、搜索、获取信息方法，并提供访问权限管理。
同样，应用程序可能会非法访问文件。</p>
<p><strong>4 通信</strong>
服务：提供进程间的相互通信。（同一计算机内的不同进程或通过网络链接的不同计算机的进程）
同样，应用程序可能会非法窃听其它应用的信息。</p>
<p><strong>5 错误检测</strong>
服务：对于发生在硬件上或用户程序中的错误，操作系统采取适当的处理措施。
若使用应用程序提供该服务，则应用程序在编写时需要考虑所有可能的错误，这是不现实的。</p>
<h3 id="25"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter2-%E4%BD%9C%E4%B8%9A.md/#25">2.5</a></h3>
<p>What are the five major activities of an operating system in regard to file management?</p>
<ul>
<li>文件的创建和删除</li>
<li>文件的打开和关闭</li>
<li>文件的读、写、重定位</li>
<li>读取文件属性和设置文件属性</li>
<li>文件的权限管理</li>
</ul>
<h3 id="28"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter2-%E4%BD%9C%E4%B8%9A.md/#28">2.8</a></h3>
<p>What are the two models of interprocess communication? What are the strengths and
weaknesses of the two approaches?</p>
<p><strong>1 共享内存(shared-memory model)</strong>
优点：
- 速度快
- 访问数据方便</p>
<p>缺点：
- 不易进行数据的保护和同步</p>
<p><strong>2 消息(message-passing model)</strong>
优点：
- 不必避免冲突
- 计算机间通信时，更容易实现</p>
<p>缺点：
- 大量数据传输时，速度慢</p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter2-%E4%BD%9C%E4%B8%9A.md/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-17 14:47:08">2019年9月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 1 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="操作系统第一章-作业"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter1-%E4%BD%9C%E4%B8%9A/">操作系统第一章 作业</a></h2>
<h4 id="13"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter1-%E4%BD%9C%E4%B8%9A/#13">1.3</a></h4>
<p>Under what circumstances would a user be better off using a timesharing system rather than a PC or single-user workstation?
答：当计算机性能足够强大的时候，采用分时系统可以让计算机同时地，快速地，为许多用户解决复杂的问题，并使得计算资源得到充分的利用。此时若让每个用户使用pc机去解决问题会需要很久，而给使用工作站成本又太高。</p>
<h4 id="15"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter1-%E4%BD%9C%E4%B8%9A/#15">1.5</a></h4>
<p>Describe the differences between symmetric and asymmetric multiprocessing. What are three advantages and one disadvantage of multiprocessor systems?
答：
1. 区别：
    - 对称多处理器中的每个核对于程序来讲是完全相同的，而非对称多处理的每个核都有自己擅长处理的特定的计算任务，是不同的。
    - 对称多处理器中的每个核都可以进行I/O操作，而非堆成中多处理中，有一个主核控制其它从核，通常只有主核执行I/O操作。</p>
<ol>
<li>优缺点：<ul>
<li>优点：<ol>
<li>利用了并行性，增加了系统的吞吐量。</li>
<li>因为不同cpu共享外设，大容量存储和电源等资源，因此更加经济。</li>
<li>因为即使一个cpu出了问题，整个系统仍可以正常工作，因此更加可靠。</li>
</ol>
</li>
<li>缺点：<ol>
<li>需要编程人员编写并行性的程序才能发挥效果，增加编程工作量。</li>
</ol>
</li>
</ul>
</li>
</ol>
<h4 id="110"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter1-%E4%BD%9C%E4%B8%9A/#110">1.10</a></h4>
<p>What is the purpose of interrupts? What are the differences between a trap and an interrupt? Can traps be generated intentionally by a user program? If so, for what purpose?
答：
1. 中断的目的：
    - 使用中断访问I/O机制，可以消除cpu对I/O设备的轮询，减少cpu的等待时间。
    - 通过中断更容易对外设进行响应，如按下键盘会产生一个中断，计算机处理这个中断便会跳转到响应处理程序。
2. 中断是硬件产生的，陷阱（trap）是软件产生的。
3. 可以，如软件需要进行系统调用时。</p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/09/17/2019-09-17-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5-chapter1-%E4%BD%9C%E4%B8%9A/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2019-09-12 10:20:58">2019年9月12日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="./" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="计算机组成原理-第一章作业"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/">计算机组成原理 第一章作业</a></h2>
<blockquote>
<p>教材： 计算机组成原理：软硬件接口 第5版(mips 版)
时间: 2019/09/08</p>
</blockquote>
<h3 id="exercise-12"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-12">Exercise 1.2</a></h3>
<ol>
<li>a: "Assembly lines in automobile manufacturing" -&gt; "Performance via Pipelining"</li>
<li>b: "Suspension bridge cables" -&gt; “Dependability via Redundancy”</li>
<li>c: "Aircraft and marine navigation systems that incorporate wind information" -&gt; “Performance via Prediction”</li>
<li>d: "Express elevators in buildings" -&gt; “Performance via Parallelism”</li>
<li>e: "Library reserve desk" -&gt; “Hierarchy of Memories”</li>
<li>f: "Increasing the gate area on a CMOS transistor to decrease its switching time" -&gt; “Make the Common Case Fast”</li>
<li>g: "Adding electromagnetic aircraft catapults (which are electrically-powered as opposed to current steam-powered models), allowed by the increased power generation off ered by the new reactor technology" -&gt; “Design for Moore’s Law”</li>
<li>h: "Building self-driving cars whose control systems partially rely on existing sensor systems already installed into the base veh icle, such as lane departure systems and smart cruise control systems" -&gt; “Use Abstraction to Simplify Design”</li>
</ol>
<h3 id="exercise-13"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-13">Exercise 1.3</a></h3>
<p>以C语言为例:
&emsp;&emsp;&emsp;&emsp;编译&emsp;&emsp;&emsp;&emsp;&emsp;汇编&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;链接
$ 源代码 \Longrightarrow 汇编语言 \Longrightarrow 目标代码 \Longrightarrow 机器代码$
- 编译：通过编译器，读取源程序（字符流），对之进行词法和语法的分析，将高级语言指令转换为功能等效的汇编代码的过程。
- 汇编：通过汇编器将汇编语言代码翻译成目标机器指令的过程。
- 链接：将有关的目标文件彼此相连接，也即将在一个文件中引用的符号同该符号在另外一个文件中的定义连接起来，使得所有的这些目标文件成为一个能够被操作系统装入执行的统一整体。</p>
<h3 id="exercise-14"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-14">Exercise 1.4</a></h3>
<p>a) $ frame size = 1280 \times 1024 \times 3 \times 8bit = 3.75MB $
b) $ time = \frac{ 1280 \times 1024 \times 3 \times 8bit }{100 \times 10^{6} bit} \approx 0.31s $ </p>
<h3 id="exercise-15"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-15">Exercise 1.5</a></h3>
<h4 id="151"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#151">1.5.1</a></h4>
<p>设<span class="arithmatex">\(I\)</span>为指令数，<span class="arithmatex">\(t\)</span>为cpu执行时间，<span class="arithmatex">\(f\)</span>为时钟频率,则：
$$
    I = \frac{t \cdot f}{CPI}
$$
$ I_{p1} = {1 \times 3 \over 1.5} = 2G 条$
$ I_{p2} = {1 \times 2.5 \over 1} = 2.5G 条$
$ I_{p3} = {1 \times 4 \over 2.2} \approx 1.82G 条$</p>
<h4 id="152"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#152">1.5.2</a></h4>
<p>设$ C $为时钟数,则：</p>
<p>$ C_{p1} = 10 \times 3 = 30G $
$ I_{p1} = {30 \over 1.5} = 20G $</p>
<p>$ C_{p2} = 10 \times 2.5 = 25G $
$ I_{p2} = {25 \over 1} = 25G $</p>
<p>$ C_{p3} = 10 \times 4 = 40G $
$ I_{p3} = {40 \over 2.2} \approx 18.2G $</p>
<h4 id="153"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#153">1.5.3</a></h4>
<p>(1) $ t = \frac{I \cdot CPI}{f} $
(2) $ (1-0.3)t = \frac{I \cdot (1+0.2)CPI}{f'} $</p>
<p>$ 由\frac{(1)}{(2)} \Rightarrow \frac{clock rate'}{clock rate} = {(1+0.2) \over (1-0.3)} = 1.71$</p>
<h3 id="exercise-16"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-16">Exercise 1.6</a></h3>
<h4 id="161"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#161">1.6.1</a></h4>
<p>令$ p_i $为一条指令占总指令的比例，则对于平均CPI，有：
$$
    \overline {CPI} = \sum_{i=1}^nCPI_i \cdot p_i
$$
对于P1：$ \overline {CPI} = 0.1\times 1 + 0.2\times 2 + 0.5\times 3 + 0.2\times 3 = 2.5 $
对于P2：$ \overline {CPI} = 2 $</p>
<h4 id="162"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#162">1.6.2</a></h4>
<p>对于P1，时钟数：$ C = \frac{1.0 \times 10^6}{2.5} = 4\times 10^5 $
对于P2，时钟数：$ C = \frac{1.0 \times 10^6}{2} = 5\times 10^5 $</p>
<h3 id="exercise-17"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-17">Exercise 1.7</a></h3>
<h6 id="a"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#a">a)</a></h6>
<p>设$ T <span class="arithmatex">\(为时钟周期，\)</span> t <span class="arithmatex">\(为程序执行时间，\)</span> I $为指令数，则：
$$
    CPI = \frac{t}{I \cdot T}
$$
$ \overline {CPI_A} = \frac{1.1s}{1.0 \times 10^9 \times 1 ns} = 1.1$
$ \overline {CPI_B} = \frac{1.5s}{1.2 \times 10^9 \times 1 ns} = 1.25$</p>
<h6 id="b"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#b">b)</a></h6>
<p>设$ f = \frac{1}{T} $，利用上述公式，得:
$$
\frac{CPI_A}{CPI_B} = \frac{I_B \cdot T_{PB}}{I_A \cdot T_{PA}}\
    \Rightarrow \frac{1.1}{1.25} = \frac{1.2 f_{PA}}{1.0 f_{PB}}\
    \Rightarrow \frac{f_{PA}}{f_{PB}} = 0.733
$$
答：处理器A的时钟频率为处理器B的0.733倍</p>
<h6 id="c"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#c">c)</a></h6>
<p>仍假设cpu时钟周期为1ns，$ t_{new} = 6.0 \times 10^8 \times 1.1 \times 1ns = 0.66s $</p>
<p>对于A: $ 加速比 = (1.1 - 0.66)/1.1 = 40\% $
对于B：$ 加速比 = (1.5 - 0.66)/1.5 = 29.3\% $</p>
<h3 id="exercise-18"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#exercise-18">Exercise 1.8</a></h3>
<h4 id="181"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#181">1.8.1</a></h4>
<p>设P为功耗，C为负载电容，V为电压，f为开关频率，动态功耗公式：
$$
    P = C \cdot U^2 \cdot f
$$
$ C_{Pentium 4} = \frac{90}{1.25^2 \times 3.6 \times 10^6} = 16 \mu F$
$ C_{Core i5} = \frac{40}{0.9^2 \times 3.4 \times 10^6} \approx  14.5 \mu F$</p>
<h4 id="182"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#182">1.8.2</a></h4>
<p>$ 设p1为静态功耗占总功耗的比例，p2为静态功耗相对于动态功耗的比例。 $</p>
<p>$ Pentium 4: p1 = 10/100 = 10\%, p2 = 10/90 = 11.1\%$
$ Core i5: p1 = 30/70 =  42.9\%, p2 = 30/40 = 75\%$</p>
<h4 id="183"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/#183">1.8.3</a></h4>
<div class="arithmatex">\[ P_总 = P_动 + P_静  =  C \cdot U^2 \cdot f + I \cdot U$$
$ 因为I不变，设变化后的电压为U'，t = \frac{U'}{U},则： $
$$ P_总' = P_动 \cdot \left( \frac{U'}{U} \right)^2 + P_静 \cdot \left( \frac{U'}{U} \right) \\
\Rightarrow P_总' = P_动 \cdot t^2 + P_静 \cdot t
\]</div>
<p>对于P4：
$ 90 = 90t^2 + 10t \Rightarrow t \approx  0.946 $
对于i5:
$ 63 = 40t^2 + 30t \Rightarrow t \approx  0.935$
答：对于P4，电压降为原来的$ 94.6\% <span class="arithmatex">\(，对于i5，电压降为原来的\)</span> 93.5\% $</p>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2019/09/12/2019-09-12-%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86-%E7%AC%AC%E4%B8%80%E7%AB%A0%E4%BD%9C%E4%B8%9A/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../%E8%AE%BE%E5%A4%87/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 设备">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                设备
              </div>
            </div>
          </a>
        
        
          
          <a href="../%E9%98%85%E8%AF%BB/" class="md-footer__link md-footer__link--next" aria-label="下一页: 阅读">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                阅读
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>