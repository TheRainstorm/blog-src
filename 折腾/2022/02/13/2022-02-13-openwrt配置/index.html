
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/%E6%8A%98%E8%85%BE/2022/02/13/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/">
      
      
        <link rel="prev" href="../2022-02-13-%E8%AE%B0%E5%BD%95%E7%BA%A2%E7%B1%B3AC2100%E6%8A%98%E8%85%BE/">
      
      
        <link rel="next" href="../2022-02-13-openwrt%E7%BC%96%E8%AF%91/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>openwrt配置 - Rain的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#第三方软件" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../../.." title="Rain的随笔" class="md-header__button md-logo" aria-label="Rain的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              openwrt配置
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="../../../../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../archive/2024/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../../category/homelab/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Rain的随笔" class="md-nav__button md-logo" aria-label="Rain的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Rain的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/homelab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    homelab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何实现网络自由
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    学习
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E6%8A%98%E8%85%BE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    折腾
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E6%9D%82%E6%96%87/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    杂文
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%99%9A%E6%8B%9F%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚拟化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%AE%BE%E5%A4%87/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    设备
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E8%AF%BE%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    课程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../../category/%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    阅读
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../.." class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
                  <span class="md-ellipsis">
                    回到主页
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    元数据
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5v-5Z"/></svg>
                        <time datetime="2022-02-13 01:18:16" class="md-ellipsis">2022年2月13日</time>
                      </div>
                    </li>
                    
                    
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 3v15h3V3H9m3 2 4 13 3-1-4-13-3 1M5 5v13h3V5H5M3 19v2h18v-2H3Z"/></svg>
                          <span class="md-ellipsis">
                            分类于
                            
                              <a href="../../../../../category/%E6%8A%98%E8%85%BE/">折腾</a>, 
                              <a href="../../../../../category/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/">如何实现网络自由</a></span>
                        </div>
                      </li>
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7h1.5Z"/></svg>
                          <span class="md-ellipsis">
                            
                              需要 21 分钟阅读时间
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
            

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ddns" class="md-nav__link">
    <span class="md-ellipsis">
      DDNS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DDNS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#freedns" class="md-nav__link">
    <span class="md-ellipsis">
      FreeDNS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置" class="md-nav__link">
    <span class="md-ellipsis">
      配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#zerotier" class="md-nav__link">
    <span class="md-ellipsis">
      ZeroTier
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ZeroTier">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#作用" class="md-nav__link">
    <span class="md-ellipsis">
      作用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#具体过程" class="md-nav__link">
    <span class="md-ellipsis">
      具体过程
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wireguard" class="md-nav__link">
    <span class="md-ellipsis">
      Wireguard
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Wireguard">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#安装" class="md-nav__link">
    <span class="md-ellipsis">
      安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#配置_1" class="md-nav__link">
    <span class="md-ellipsis">
      配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ipv6" class="md-nav__link">
    <span class="md-ellipsis">
      ipv6
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        
  
  

<nav class="md-tags" >
  
    
    
    
      <a href="../../../../../tags/#openwrt" class="md-tag">openwrt</a>
    
  
</nav>



<p>openwrt换源
<a href="https://mirrors.ustc.edu.cn/help/openwrt.html">OpenWRT/LEDE 源使用帮助 — USTC Mirror Help 文档</a>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>sed -i &#39;s/downloads.openwrt.org/mirrors.ustc.edu.cn\/openwrt/g&#39; /etc/opkg/distfeeds.conf
</span></code></pre></div></p>
<!-- more -->
<h1 id="第三方软件">第三方软件<a class="headerlink" href="#第三方软件" title="Permanent link">&para;</a></h1>
<h2 id="ddns">DDNS<a class="headerlink" href="#ddns" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>opkg install luci-app-ddns ddns-scripts-freedns
</span></code></pre></div>
<h3 id="freedns">FreeDNS<a class="headerlink" href="#freedns" title="Permanent link">&para;</a></h3>
<p><a href="https://freedns.afraid.org/">FreeDNS</a>是一个免费提供DDNS服务的网站，上面有许多人分享了自己的一级域名，我们可以在上面注册自己的二级域名。</p>
<p>以下是FreeDNS各页面功能的介绍</p>
<ul>
<li>
<p><strong><em>Subdomains</em></strong>页面</p>
</li>
<li>
<p>用于添加和管理自己的子域名</p>
<ul>
<li>添加时类型A表示将子域名映射到一个ipv4地址上</li>
<li>类型AAAA表示映射到ipv6地址上</li>
<li>CNAME表示映射到另一个域名</li>
</ul>
<p><img alt="image-20220104231823784" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220104231823784.png" /></p>
</li>
<li>
<p><strong><em>Dynamic DNS</em></strong>页面</p>
</li>
<li>
<p>包含各种配置DDNS的方式，见下节</p>
</li>
<li>
<p><strong><em>Registry</em></strong>页面</p>
</li>
<li>
<p>包含所有可选域名</p>
</li>
</ul>
<h3 id="配置">配置<a class="headerlink" href="#配置" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>方式一：使用crontab脚本（最简单）</p>
</li>
<li>
<p>ipv4</p>
<p>在FreeDNS <strong><em>Dynamic DNS</em></strong>页面，在每个子域名处，有对应的quick cron example。将其添加到crontab中即可。</p>
<p><img alt="image-20220104232125544" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220104232125544.png" /></p>
<p>注：使用这种方式无法更新ipv6地址，会将ipv4地址更新给域名</p>
</li>
<li>
<p>ipv6</p>
<p>在<a href="https://freedns.afraid.org/dynamic/v2/?style=1">Get your update URLs (afraid.org)</a>中开启Randomized Update Token</p>
<p><img alt="image-20220212012558086" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220212012558086.png" /></p>
<p>使用这里的cron script，其中会访问v6.sync.afraid.org，可以更新ipv6</p>
</li>
<li>
<p>方式二：使用openwrt插件</p>
</li>
<li>
<p>openwrt插件下载：luci-ddns-app</p>
<p><img alt="image-20220104232354879" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220104232354879.png" /></p>
</li>
<li>
<p>DDNS Service provider选择afraid.org-keyauth（也可使用afraid.orgv2-token，但是下一步使用的编码则使用上一种方式中开启Randomized Update Token处的token）</p>
</li>
<li>
<p>password处填写每个子域名对应更新链接中的编码（在FreeDNS每个子域名的Direct URL中可见）</p>
<p>类似如下格式</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>https://freedns.afraid.org/dynamic/update.php?Zk9FOG55RxxxxxxxIwMTY3ODY0
</span></code></pre></div>
</li>
<li>
<p>其余domain，username都可以随便填</p>
</li>
</ul>
<p><img alt="image-20220125214526946" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220125214526946.png" /></p>
<ul>
<li>
<p>在Advanced Setting中选择netwrok</p>
<p><img alt="image-20220125214936634" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220125214936634.png" /></p>
</li>
<li>
<p>保存应用后，点击reload，可以在Log File Viewer中查看是否成功运行。</p>
<p>可以看到第一次完成更新，第二次不更新</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>212943       : Detect registered/public IP
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>   212943       : #&gt; /usr/bin/nslookup rm.ipv6.my.to  &gt;/var/run/ddns/FreeDNS_ipv6.dat 2&gt;/var/run/ddns/FreeDNS_ipv6.err
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>   212943       : Registered IP &#39;2409:8a38:1600:7e42:9e9d:7e1f:cfc6:de30&#39; detected
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>   212943  info : Starting main loop at 2022-01-25 21:29
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>   212943       : Detect local IP on &#39;network&#39;
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>   212943       : Local IP &#39;2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39; detected on network &#39;wan_6&#39;
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>   212943       : Update needed - L: &#39;2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39; &lt;&gt; R: &#39;2409:8a38:1600:7e42:9e9d:7e1f:cfc6:de30&#39;
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>   212943       : Force communication via device &#39;pppoe-wan&#39;
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>   212943       : #&gt; /usr/bin/curl -RsS -o /var/run/ddns/FreeDNS_ipv6.dat --stderr /var/run/ddns/FreeDNS_ipv6.err --interface pppoe-wan --noproxy &#39;*&#39; &#39;https://freedns.afraid.org/dynamic/update.php?***PW***&amp;address=2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39;
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>   212945       : DDNS Provider answered:
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>  Updated 1 host(s) rm.ipv6.my.to to 2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30 in 0.335 seconds
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>   212945  info : Update successful - IP &#39;2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39; send
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>   212945  info : Forced update successful - IP: &#39;2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39; send
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>   212945       : Waiting 600 seconds (Check Interval)
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>   213945       : Detect registered/public IP
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>   213945       : #&gt; /usr/bin/nslookup rm.ipv6.my.to  &gt;/var/run/ddns/FreeDNS_ipv6.dat 2&gt;/var/run/ddns/FreeDNS_ipv6.err
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>   213947       : Registered IP &#39;2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39; detected
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>   213947  info : Rerun IP check at 2022-01-25 21:39
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>   213947       : Detect local IP on &#39;network&#39;
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>   213947       : Local IP &#39;2409:8a38:1600:2c2c:9e9d:7e58:c2c6:de30&#39; detected on network &#39;wan_6&#39;
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>   213947       : Waiting 600 seconds (Check Interval)
</span></code></pre></div>
</li>
</ul>
<h2 id="zerotier">ZeroTier<a class="headerlink" href="#zerotier" title="Permanent link">&para;</a></h2>
<h3 id="作用">作用<a class="headerlink" href="#作用" title="Permanent link">&para;</a></h3>
<ol>
<li>将若干个安装了Zerotier的设备添加到一个虚拟的大局域网中互相访问</li>
<li>可以在Zerotier中设置Route，从而实现访问某个zerotier设备所处局域网中的其它设备</li>
</ol>
<h3 id="具体过程">具体过程<a class="headerlink" href="#具体过程" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>去ZeroTier注册一个账号，并了解ZeroTier的使用</p>
</li>
<li>
<p>安装zerotier</p>
</li>
</ol>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>opkg<span class="w"> </span>update
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>opkg<span class="w"> </span>install<span class="w"> </span>zerotier
</span></code></pre></div>
<p>这里会依赖kmod-tun等内核模块，这要求内核版本完全一致才能安装成功。</p>
<ul>
<li>如果使用的是openwrt开发版本(snapshot)：由于snapshot每天、甚至几个小时就会更新，因此很有可能因为有了新的更新，导致opkg下载的kmod-tun内核版本不一致导致报错。解决办法为更新为新版的开发版，并尽快下载安装。或者自己编译openwrt。</li>
<li>
<p>对于stable版本，官方源保证了一致性，因此这里不会出现问题。</p>
</li>
<li>
<p>配置ZeroTier</p>
</li>
<li>
<p>创建目录：   mkdir -p /etc/zerotier</p>
</li>
<li>
<p>修改/etc/config/zerotier内容（存在样本配置），下面代码为使用命令行配置方法
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>zerotier.openwrt_network<span class="o">=</span>zerotier
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>uci<span class="w"> </span>add_list<span class="w"> </span>zerotier.openwrt_network.join<span class="o">=</span><span class="s1">&#39;你的网络ID&#39;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>zerotier.openwrt_network.enabled<span class="o">=</span><span class="s1">&#39;1&#39;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>uci<span class="w"> </span><span class="nb">set</span><span class="w"> </span>zerotier.openwrt_network.config_path<span class="o">=</span><span class="s1">&#39;/etc/zerotier&#39;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>uci<span class="w"> </span>commit<span class="w"> </span>zerotier
</span></code></pre></div></p>
</li>
<li>
<p>启动zerotier（这步之后已经可以从ZeroTier Central中看到路由器连上了）</p>
</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>/etc/init.d/zerotier<span class="w"> </span><span class="nb">enable</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>/etc/init.d/zerotier<span class="w"> </span>start
</span></code></pre></div>
<ol>
<li>
<p>创建接口（这步之后已经可以ping通）</p>
</li>
<li>
<p>web界面，网络 -&gt; 接口，添加新接口</p>
</li>
<li>名称 ZeroTier</li>
<li>协议选静态协议，ip设置为ZeroTier Central中的ip</li>
<li>接口选z开头的适配器</li>
<li>创建/分配防火墙区域选择lan（其实lan/wan都可以）</li>
<li>保存&amp;应用</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>uci set network.Zerotier=interface
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>uci set network.Zerotier.proto=&#39;static&#39;
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>uci set network.Zerotier.device=&#39;ztyou4dlov&#39;
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>uci set network.Zerotier.netmask=$ZEROTIER_MASK
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>uci set network.Zerotier.ipaddr=$ZEROTIER_IP
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a>echo &quot;[INFO] add zerotier to lan zone&quot;
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>uci add_list firewall.@zone[0].network=&#39;Zerotier&#39;   # add Zerotier to lan
</span></code></pre></div>
<ol>
<li>防火墙</li>
</ol>
<p>全部设置成allow</p>
<p><img alt="image-20210916172318383" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20210916172318383.png" /></p>
<ol>
<li><strong>ZeroTier Central配置路由转发</strong></li>
</ol>
<p>配置这个后，在外网可以通过局域网ip直接访问不在ZeroTier Central中的其它局域网设备。（过程大致是：外网 -&gt; zerotier -&gt; 局域网一台设备(位于ZeroTier中) -&gt; 局域网其它设备）</p>
<p>配置图：访问192.168.31.*中的设备时，会通过192.168.192.168(实际局域网ip为路由器)访问</p>
<p><img alt="image-20210707233753989" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20210707233753989.png" /></p>
<p><strong>注意</strong>：别将第一行的删了，否则全部无法访问</p>
<p><strong>缺点</strong>：目前发现，当两台电脑位于同一个局域网，想要直接通过局域网ip访问时，即使没有开启zerotier软件，两台电脑的相互访问速度也会严重受限（原本可以跑到500M，直接降为10M）</p>
<h2 id="wireguard">Wireguard<a class="headerlink" href="#wireguard" title="Permanent link">&para;</a></h2>
<ul>
<li>官方教程：[<a href="https://openwrt.org/docs/guide-user/services/vpn/wireguard/server">OpenWrt Wiki] WireGuard server</a></li>
</ul>
<h3 id="安装">安装<a class="headerlink" href="#安装" title="Permanent link">&para;</a></h3>
<ul>
<li>安装wireguard
  wiregurad是内核模块，如果是自己编译的openwrt则无法通过opkg安装(linux kernel hash校验失败导致依赖不满足），需要在编译时集成到openwrt中。或者手动安装</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>opkg update
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>opkg install luci-app-wireguard
</span></code></pre></div>
<h3 id="配置_1">配置<a class="headerlink" href="#配置_1" title="Permanent link">&para;</a></h3>
<p>新手使用luci配置，之后直接复制到/etc/config/network中即可
- 创建接口
  - web界面，网络 -&gt; 接口，添加新接口
  - 名称wireguard
  - 协议选wiregurad VPN
  - 生成私钥
  - 设置ip地址为虚拟局域网地址，如10.0.31.10/24
  - 保存&amp;应用</p>
<ul>
<li>添加peer</li>
<li>在Luci中手动添加</li>
<li>
<p>或者编辑<code>/etc/config/network</code>，添加已有的设备，如
    <div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>config wireguard_wireguard
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>    option public_key &#39;anjf3DtB6EkSo88uBXk8zFMLAZ3W2gD7AmXjqRl2mgM=&#39;
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>    list allowed_ips &#39;10.0.31.2/32&#39;
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    option route_allowed_ips &#39;1&#39;
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    option description &#39;ryzen5800X&#39;
</span></code></pre></div></p>
</li>
<li>
<p>使其生效方式：</p>
</li>
<li>重启路由器</li>
<li>重启网络接口</li>
<li>命令行重启网络接口
  <div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>ifconfig wg_s2s down &amp;&amp; ifup wg_s2s
</span></code></pre></div></li>
</ul>
<h3 id="ipv6">ipv6<a class="headerlink" href="#ipv6" title="Permanent link">&para;</a></h3>
<p>op有ipv6网络环境，如何让wg接入的设备也能拥有ipv6环境？</p>
<p>可以给op和peer设置ULA的ipv6地址，peer的ipv6包到达op后，需要从op的网络接口出去（比如wan）。但是wan的masq默认是不对ipv6流量进行src nat的。这里我们想要做到：
- 从wg接口进入op的流量，从wan出去时，对ipv6的源地址（ULA地址）进行nat
- 其它ipv6流量（源地址为分配的公网ipv6地址）从wan出去时，不进行nat</p>
<ol>
<li>依赖，对于22.03以后的版本，实测不需要安装其它内核模块。官方文档写对于openwrt21.02 ，需要安装nat模块
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>opkg install kmod-ipt-nat6
</span></code></pre></div></li>
<li>
<p>wg接口设置ipv6地址。从ULA地址段选取一个：<a href="https://en.wikipedia.org/wiki/Unique_local_address">Unique local address - Wikipedia</a>，如图所示。
<img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20230409162306.png" />
我选择了一个48的网段
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>fdab:2333:2333::2/48
</span></code></pre></div></p>
</li>
<li>
<p>设置nft规则，从wg接口进入的流量出去时需要进行src nat。
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>vim /etc/nftables.d/11-nat6-wg.nft
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>chain srcnat_ula6_wg0 {
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>        type nat hook postrouting priority srcnat; policy accept;
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>        oifname &quot;eth0&quot; ip6 saddr fdab:2333:2333::/48 counter masquerade comment &quot;!fw4: ULA masquerade6&quot;
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>}
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>chain srcnat_ula6_wg1 {
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>        type nat hook postrouting priority srcnat; policy accept;
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>        oifname &quot;eth0&quot; ip6 saddr fdab:2333:2334::/48 counter masquerade comment &quot;!fw4: ULA masquerade6&quot;
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>}
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>service firewall restart
</span></code></pre></div></p>
</li>
<li>
<p>允许ULA地址路由。虽然我们上面开启了SNAT是不会把私有地址发送到公网的，但是路由器对于ULA地址仍然默认是不会进行路由转发的，需要手动开启。（这里要注意的是防火墙postrouting规则是在进行路由选择之后生效的，参考<a href="https://upload.wikimedia.org/wikipedia/commons/3/37/Netfilter-packet-flow.svg">netfilter-packet-flow</a>）</p>
</li>
<li>对于wan6口通过dhcpv6上网，只需要设置sourcefilter=0。</li>
<li><em>对于pppoe上网，没有wan6接口，暂时还不知道怎么配置。</em>
<div class="language-text highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>uci set network.wan6.sourcefilter=&quot;0&quot;
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>uci commit
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>ifup wan6
</span></code></pre></div></li>
</ol>
<p>参考
- <a href="https://forum.openwrt.org/t/wireguard-vpn-with-ula-and-nat6/119495">WireGuard VPN with ULA and NAT6? - Installing and Using OpenWrt / Network and Wireless Configuration - OpenWrt Forum</a>
- <a href="https://openwrt.org/docs/guide-user/services/vpn/wireguard/road-warrior">[OpenWrt Wiki] WireGuard Road-Warrior Configuration</a>
  - NAT6 through your upstream IPv6 interface when routing IPv6 peer traffic from a ULA (configuration B, or configuration A if the peer only uses a ULA)</p>
<h1 id="网络">网络<a class="headerlink" href="#网络" title="Permanent link">&para;</a></h1>
<h2 id="ipv6_1">IPv6<a class="headerlink" href="#ipv6_1" title="Permanent link">&para;</a></h2>
<p>安装好openwrt(21.02)后，会默认开启并配置ipv6，电脑可以直接访问ipv6。但是该方式只有路由器能得到一个公网ipv6地址，路由器局域网内设备只有本地ipv6地址。类似于Openwrt开启了一层ipv6的NAT。而为了让连上路由器的所有设备获得公网ipv6地址，需要进行以下设置</p>
<!-- more -->

<h3 id="理论">理论<a class="headerlink" href="#理论" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>ICMPv6有多种报文格式，大体可以分为两类，差错报文和数据报文。ipv6使用ICMPv6中的一系列报文RS, RA, NS, NA（R--&gt; router, N--&gt;neighbor, S--&gt;solicitation, A--&gt;advertisement）来完成地址解析(通过ip获得MAC)、邻居不可达检测、地址冲突检测、地址分配(SLAAC)等任务。</p>
</li>
<li>
<p>SLAAC(Stateless Address Autoconfiguration)：无状态的地址自动配置协议。使用RA进行地址配置，特点是无状态的。DHCPv6则是有状态的。目前会混合使用这两个协议来配置ipv6。</p>
</li>
</ul>
<p>详细：一个接口up时，会发送一个RS报文请求网络前缀。其它设备返回一个RA报文。设备通过前缀+EUI64自动生成ipv6地址。设备的默认网关（路由表中::项）也被设置为响应者，同时设置一个网关的有效时间。其它设备每隔一段时间发送一个RA报文。200-600s</p>
<h3 id="wan口为dhcp">WAN口为dhcp<a class="headerlink" href="#wan口为dhcp" title="Permanent link">&para;</a></h3>
<p>这种情况，路由器为一个二级的路由器，直接转发WAN传来的RA报文即可。</p>
<p>修改<code>/etc/config/dhcp</code></p>
<ul>
<li>lan和wan6 添加3个relay（其中wan6部分可能需要自己添加）</li>
<li>设置一个master</li>
</ul>
<div class="language-text highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>config dhcp &#39;lan&#39;
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>        option interface &#39;lan&#39;
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        option start &#39;100&#39;
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>        option limit &#39;150&#39;
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>        option leasetime &#39;12h&#39;
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>        option dhcpv4 &#39;server&#39;
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>        option ra &#39;relay&#39;
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>        option dhcpv6 &#39;relay&#39;
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>        option ndp &#39;relay&#39;
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>        list ra_flags &#39;none&#39;
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>config dhcp &#39;wan&#39;
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>        option interface &#39;wan&#39;
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>        option ignore &#39;1&#39;
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>config dhcp &#39;wan6&#39;
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>        option interface &#39;wan&#39;
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>        option ra &#39;relay&#39;
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>        option dhcpv6 &#39;relay&#39;
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>        option ndp &#39;relay&#39;
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>        option master &#39;1&#39;
</span></code></pre></div>
<h3 id="静态ipv6">静态ipv6<a class="headerlink" href="#静态ipv6" title="Permanent link">&para;</a></h3>
<p>理论上获得了一个ipv6前缀后，可以自己设置静态的ipv6地址，基本不会和别人发生冲突。</p>
<p>可以在WAN6 interface中设置为static（动态为DHCPv6 client)，并设置一个ipv6地址。</p>
<p>以下为修改后的<code>/etc/config/network</code>内容</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>config interface &#39;wan&#39;
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>    option device &#39;wan&#39;
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>    option proto &#39;dhcp&#39;
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>config interface &#39;wan6&#39;
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>    option device &#39;wan&#39;
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a>    option proto &#39;static&#39;
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a>    list ip6addr &#39;2001:da8:d800:611::123d/64&#39;
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>    option ip6gw &#39;2001:da8:d800:611::1&#39;
</span></code></pre></div>
<h3 id="wan口为pppoe">WAN口为pppoe<a class="headerlink" href="#wan口为pppoe" title="Permanent link">&para;</a></h3>
<p>这种情况，不能使用上面的全部配置为relay的方式。刚开始全部配置为relay后，<strong>发现设备需要先ping一下路由器的WAN口ipv6地址之后，才能正常ipv6上网。</strong></p>
<p>我还没有搞懂是为什么，经过不断各种尝试后，发现以下配置成功。</p>
<ul>
<li>首先wan口设置为pppoe后，拨号成功后会生成一个WAN_6虚拟接口，我们可以将WAN6接口删掉</li>
</ul>
<p>（以下为最终成功的截图）</p>
<p><img alt="image-20220126181749809" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220126181749809.png" /></p>
<ul>
<li>然后需要将WAN中的DHCP Server设置为忽略，之后需要配置LAN</li>
</ul>
<p><img alt="image-20220126181855902" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220126181855902.png" /></p>
<ul>
<li>LAN中RA和DHCPv6都需要设置为server</li>
</ul>
<p><img alt="image-20220126184655662" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220126184655662.png" /></p>
<p>​ 然后Advanced中需要开启Delegate IPv6 prefixes，最终效果就是LAN接口中也出现了ipv6地址</p>
<p><img alt="image-20220126182454486" src="../../../../../images/2022-02-13-openwrt%E9%85%8D%E7%BD%AE/image-20220126182454486.png" /></p>
<p>记录下最后的配置文件</p>
<p><code>/etc/config/dhcp</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>config dhcp &#39;lan&#39;
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>        option interface &#39;lan&#39;
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>        option start &#39;100&#39;
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>        option limit &#39;150&#39;
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>        option leasetime &#39;12h&#39;
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>        option dhcpv4 &#39;server&#39;
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>        option dhcpv6 &#39;server&#39;
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>        option ra &#39;server&#39;
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>        list ra_flags &#39;managed-config&#39;
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>        list ra_flags &#39;other-config&#39;
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>config dhcp &#39;wan&#39;
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>        option interface &#39;wan&#39;
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>        option ignore &#39;1&#39;
</span></code></pre></div>
<p><code>/etc/config/network</code></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>config interface &#39;lan&#39;
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>        option device &#39;br-lan&#39;
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a>        option proto &#39;static&#39;
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a>        option netmask &#39;255.255.255.0&#39;
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a>        option ipaddr &#39;192.168.33.1&#39;
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a>        option ip6assign &#39;60&#39;
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a>        list ip6class &#39;wan_6&#39;
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>config interface &#39;wan&#39;
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a>        option device &#39;wan&#39;
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a>        option proto &#39;pppoe&#39;
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>        option username &#39;xxx&#39;
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>        option password &#39;xxx&#39;
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>        option ipv6 &#39;auto&#39;
</span></code></pre></div>
<h2 id="dnsdnsmasq">DNS/dnsmasq<a class="headerlink" href="#dnsdnsmasq" title="Permanent link">&para;</a></h2>
<p>dnsmasq主要配置文件位于<code>/etc/config/dhcp</code>
配置文件文档：<a href="https://openwrt.org/docs/guide-user/base-system/dhcp">[OpenWrt Wiki] DNS and DHCP configuration /etc/config/dhcp</a></p>
<ul>
<li>允许除局域网内设备访问</li>
<li><em>p.s要允许wan访问，同时需要开启防火墙</em>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>option localservice &#39;0&#39;
</span></code></pre></div></li>
</ul>
<h3 id="转发请求">转发请求<a class="headerlink" href="#转发请求" title="Permanent link">&para;</a></h3>
<ul>
<li>转发给其它dns</li>
<li>下面是openclash选择了重定向dnsmasq后的配置。可以关闭后手动维护（便于切换到adguard home等其它dns）</li>
<li><strong>noresolv表示不使用上游dns</strong></li>
<li>cachesize=0，表示禁用缓存，每个dns请求都被转发给openclash
<div class="language-text highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>config dnsmasq
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>      ...
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>      list server &#39;127.0.0.1#7874&#39;
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>      option noresolv &#39;1&#39;
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>      option cachesize &#39;0&#39;
</span></code></pre></div></li>
</ul>
<h3 id="dhcp-option">dhcp option<a class="headerlink" href="#dhcp-option" title="Permanent link">&para;</a></h3>
<ul>
<li>3：设置默认网关</li>
<li>6：设置dns</li>
<li>无法指定端口</li>
</ul>
<p>luci：interface -&gt; lan -&gt; edit ...
配置文件：dhcp
<div class="language-text highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>config dhcp &#39;lan&#39;
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>    ...
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>    list dhcp_option &#39;6,192.168.36.1&#39;
</span></code></pre></div></p>
<h3 id="dns分流">dns分流<a class="headerlink" href="#dns分流" title="Permanent link">&para;</a></h3>
<p>以下设置默认将dns转发给<code>127.0.0.1:7874</code>（clash dns），对于<code>*.my.to</code>转发给119.29.29.29
<div class="language-text highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>option localservice &#39;0&#39;
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>        option port &#39;53&#39;
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>        #option resolvfile &#39;/tmp/resolv.conf.d/resolv.conf.auto&#39;
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>        option noresolv &#39;1&#39;
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>        option serverlist &#39;/etc/dnsmasq.servers&#39;
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>        list server &#39;127.0.0.1#7874&#39;
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>        list server &#39;/my.to/119.29.29.29&#39;
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>        list server &#39;/us.to/119.29.29.29&#39;
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        list server &#39;/zhenwei.site/119.29.29.29&#39;
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>        list server &#39;119.29.29.29&#39;
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        option cachesize &#39;500&#39;
</span></code></pre></div></p>
<p>或者在单独的配置文件中配置
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>option confdir &#39;/etc/dnsmasq.d&#39;
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>vim /etc/dnsmasq.d/dnsmasq_accelerated-domains.china.conf
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>server=/baidu.cc/202.38.64.56
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>server=/baidu.cm/202.38.64.56
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>server=/baidu.com/202.38.64.56
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>server=/baidu.jp/202.38.64.56
</span></code></pre></div></p>
<h3 id="bind接口和非局域网访问">bind接口和非局域网访问<a class="headerlink" href="#bind接口和非局域网访问" title="Permanent link">&para;</a></h3>
<p>容易搞混的选项
- localise_queries(1): Choose IP address to match the incoming interface if multiple addresses are assigned to a host name in <code>/etc/hosts</code>. Initially <a href="https://github.com/openwrt/openwrt/blob/master/package/network/services/dnsmasq/files/dnsmasq.init#L879" title="https://github.com/openwrt/openwrt/blob/master/package/network/services/dnsmasq/files/dnsmasq.init#L879">disabled</a>, but still <a href="https://github.com/openwrt/openwrt/blob/master/package/network/services/dnsmasq/files/dhcp.conf#L5" title="https://github.com/openwrt/openwrt/blob/master/package/network/services/dnsmasq/files/dhcp.conf#L5">enabled</a> in the config by default. <img alt=":!:" src="https://openwrt.org/lib/images/smileys/icon_exclaim.gif" /> Note well the spelling of this option.
- <strong>localservice</strong>(0): Accept DNS queries only from hosts whose address is on a local subnet, ie a subnet for which an interface exists on the server.</p>
<p>dnsmasq默认监听所有接口（但是不是bind到<code>::</code>，而是bind所有本地地址）
localservice控制是否允许其它网段访问。比较特别的是，如果手动指定了bind interface，则除了开启localservice，还需要保证绑定了对应接口。
<div class="language-text highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>list interface wg_s2s
</span></code></pre></div></p>
<h3 id="一些配置选项说明">一些配置选项说明<a class="headerlink" href="#一些配置选项说明" title="Permanent link">&para;</a></h3>
<ul>
<li><code>noresolv 0</code>: Don't read upstream servers from <code>/etc/resolv.conf</code> which is linked to <code>resolvfile</code> by default</li>
<li>
<p><code>resolvfile /tmp/resolv.conf.d/resolv.conf.auto</code>:  tells <em>dnsmasq</em> to use this file to find upstream name servers; it gets created by the WAN DHCP or PPP client.</p>
</li>
<li>
<p><code>rebind_protection 1</code>: Enables DNS rebind attack protection by discarding upstream RFC1918 responses
<a href="https://support.google.com/googlenest/answer/9144137?hl=en#zippy=%2Cwhat-is-a-dns-rebinding-attack">DNS rebinding protection - Google Nest Help</a></p>
</li>
<li>
<p>用户访问一个恶意网站时，恶意网站动态地将自己的域名绑定到用户私有地址，这样用户就会去访问本地网络。从而恶意网站可能获取用户的私有信息。</p>
<blockquote>
<p>A DNS rebinding attack is performed when a malicious website pretends that <a href="https://support.google.com/websearch/answer/1696588">IP addresses</a> (usually IPs reserved for local networks) are part of their domain. This allows them to circumvent the same-origin policy implemented by browsers and view data from these IP addresses.
A DNS rebinding attack can happen if someone using your network visits a malicious website that identifies your local IP address and deduces the structure of your local network. The malicious website could then bind their domains to the local IP address, send requests to devices on your network, and then read any responses to those requests. This could allow attackers to access some of your private information, or further compromise your network security.</p>
</blockquote>
</li>
<li>
<p><code>allservers 0</code>: By default, when dnsmasq has more than one upstream server available, it will send queries to just one server. Setting this parameter forces dnsmasq to send all queries to all available servers. The reply from the server which answers first will be returned to the original requeser.</p>
</li>
</ul>
<p>rebind_protection导致无法返回局部地址。
<div class="language-text highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>19:43:37.091228 IP 127.0.0.1.51697 &gt; 127.0.0.1.53: 15907+ A? jellyfin.yfycloud.top. (39)
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>19:43:37.091314 IP 10.0.32.2.47023 &gt; 192.168.35.1.53: 50832+ A? jellyfin.yfycloud.top. (39)
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>19:43:37.091349 IP 127.0.0.1.51697 &gt; 127.0.0.1.53: 16164+ AAAA? jellyfin.yfycloud.top. (39)
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>19:43:37.091388 IP 10.0.32.2.33248 &gt; 192.168.35.1.53: 53062+ AAAA? jellyfin.yfycloud.top. (39)
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>19:43:37.092516 IP 192.168.35.1.53 &gt; 10.0.32.2.33248: 53062 1/0/0 AAAA :: (67)
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>19:43:37.092518 IP 192.168.35.1.53 &gt; 10.0.32.2.47023: 50832 1/0/0 A 192.168.35.2 (55)
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>19:43:37.092643 IP 127.0.0.1.53 &gt; 127.0.0.1.51697: 15907 0/0/0 (39)
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>19:43:37.092713 IP 127.0.0.1.53 &gt; 127.0.0.1.51697: 16164 0/0/0 (39)
</span></code></pre></div></p>
<h3 id="递归循环">递归循环<a class="headerlink" href="#递归循环" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>root@op2 ➜  ~ nslookup debian12-docker.op2
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>Server:         127.0.0.1
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>Address:        127.0.0.1:53
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>Name:   debian12-docker.op2
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>Address: 192.168.36.137
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>** server can&#39;t find debian12-docker.op2: SERVFAIL   # 也可能是no answer
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>root@op2 ➜  ~ tcpdump -ni any udp port 53 |grep debian
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a>tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a>listening on any, link-type LINUX_SLL (Linux cooked v1), capture size 262144 bytes
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>10:42:06.385808 IP 127.0.0.1.53119 &gt; 127.0.0.1.53: 51457+ A? debian12-docker.op2. (37)
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a>10:42:06.385822 IP 127.0.0.1.53119 &gt; 127.0.0.1.53: 51714+ AAAA? debian12-docker.op2. (37)
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a>10:42:06.388495 IP 10.0.32.2.53348 &gt; 192.168.35.1.53: 13219+ AAAA? debian12-docker.op2. (37)
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>10:42:06.389850 IP 10.0.32.1.59871 &gt; 192.168.36.1.53: 7106+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a>10:42:06.389983 IP 10.0.32.2.39748 &gt; 192.168.35.1.53: 20089+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a>10:42:06.391086 IP 10.0.32.1.37076 &gt; 192.168.36.1.53: 37382+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a>10:42:08.889751 IP 127.0.0.1.53119 &gt; 127.0.0.1.53: 51714+ AAAA? debian12-docker.op2. (37)
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a>10:42:08.890363 IP 10.0.32.2.53348 &gt; 192.168.35.1.53: 13219+ AAAA? debian12-docker.op2. (37)
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>10:42:08.892259 IP 10.0.32.1.59755 &gt; 192.168.36.1.53: 7106+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a>10:42:08.892541 IP 10.0.32.2.39748 &gt; 192.168.35.1.53: 20089+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a>10:42:08.894341 IP 10.0.32.1.33708 &gt; 192.168.36.1.53: 37382+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a>10:42:08.894564 IP 10.0.32.2.39748 &gt; 192.168.35.1.53: 20089+ [1au] AAAA? debian12-docker.op2. (48)
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a>10:42:08.896553 IP 10.0.32.1.48899 &gt; 192.168.36.1.53: 37382+ [1au] AAAA? debian12-docker.op2. (48)
</span></code></pre></div>
<h2 id="dnsadguardhome">DNS/Adguardhome<a class="headerlink" href="#dnsadguardhome" title="Permanent link">&para;</a></h2>
<p>使用Adguardhome代替dnsmasq有一些好处
- 更容易进行dns分流
- 美观的控制面板，可以看到统计信息
- 一些高级的dns filtering操作：block域名，返回指定ip</p>
<h3 id="安装_1">安装<a class="headerlink" href="#安装_1" title="Permanent link">&para;</a></h3>
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>opkg<span class="w"> </span>install<span class="w"> </span>adguardhome
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="c1"># 启动服务</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>service<span class="w"> </span>adguardhome<span class="w"> </span>start
</span></code></pre></div>
初次安装需要访问<code>&lt;ip_address&gt;:3000</code>进行初始配置。配置完成后在<code>/etc/adguardhome.yaml</code>中生成配置文件。</p>
<p>我们需要使用adguardhome作为主dns，因此修改原本dnsmasq，绑定到54端口。
<div class="language-text highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a># vim /etc/config/dhcp
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>config dnsmasq
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>  ...
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>  option port &#39;54&#39;
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>  option cachesize &#39;1000&#39;
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>  option rebind_protection &#39;0&#39;
</span></code></pre></div></p>
<p>最后，修改adguradhome配置文件<code>/etc/adguardhome.yaml</code>，绑定到局域网
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nt">dns</span><span class="p">:</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">  </span><span class="nt">bind_hosts</span><span class="p">:</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.36.1</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">53</span>
</span></code></pre></div>
<code>service adguardhome restart</code>重启服务</p>
<h4 id="bind接口ip">bind接口/ip<a class="headerlink" href="#bind接口ip" title="Permanent link">&para;</a></h4>
<p>PD情况下，ohcpd会将br-lan的PD ip作为DNS响应给lan内设备。但是adguardhome dns默认没有监听该ip。
而由于PD可能会发生变化，因此也没办法手动设置（Adguardhome并不支持bind到指定接口，只能指定具体ip）
一个可以的解决办法是：odhcp中设置DNS为fe80地址，然后在AG中设置绑定到该地址。注意：由于fe80地址可以重复，因此需要使用<code>%</code>格式指定接口。
<div class="language-text highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>  bind_hosts:
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>    - 192.168.35.1
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>    - 127.0.0.1
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>    - ::1   # ipv6版本的127.0.0.1，只能本机访问
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>    - fe80::216:3eff:fe4b:6780%br-lan
</span></code></pre></div></p>
<p>监听所有接口（包含ipv6）
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>bind_hosts:
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>   - 0.0.0.0
</span></code></pre></div></p>
<h4 id="dns设置">dns设置<a class="headerlink" href="#dns设置" title="Permanent link">&para;</a></h4>
<p>可以通过以下几种方式配置上游dns(upstream dns)
- GUI配置
- 配置文件<code>upstream_dns</code>
- 配置文件<code>upstream_dns_file: /usr/share/adguardhome.upstream</code>
  - 会禁用upstream_dns并且GUI中无法看到</p>
<p>多个dns有以下策略
<img alt="image.png" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20231206134711.png" /></p>
<p>对应配置文件中以下选项
- <code>all_servers</code>: Enables parallel queries to all configured upstream servers to speed up resolving. If enabled, the queries are sent to each server simultaneously and the first response is chosen. If disabled, the queries are sent to each upstream server one-by-one and then sorted by RTT. Note that more stable upstream servers are preferred by the algorithm.
- <code>fastest_addr</code>: Use the Fastest Address algorithm. It finds an IP address with the lowest latency and returns this IP address in DNS response.</p>
<h3 id="dns分流_1">dns分流<a class="headerlink" href="#dns分流_1" title="Permanent link">&para;</a></h3>
<p>可以根据域名选择使用不同dns。
<a href="https://github.com/AdguardTeam/AdGuardHome/wiki/Configuration">Configuration · AdguardTeam/AdGuardHome Wiki (github.com)</a></p>
<p><code>/etc/adguardhome.yaml</code>中启用上游dns文件
- <code>upstream_dns_file</code>: Path to a file with the list of upstream DNS servers. If it is configured, the value of <code>upstream_dns</code> is ignored.
<div class="language-text highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>dns:
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>  upstream_dns_file: /usr/share/adguardhome.upstream   
</span></code></pre></div></p>
<p><code>/usr/share/adguardhome.upstream</code>设置上游dns
- <code>[xxx]#</code>: <code>#</code>表示使用默认dns
- <code>[*.my.to]</code>和<code>[my.to]</code>有一些区别。前者必须是my.to的子域名，不包括my.to自身，而后者包含自身及子域名。
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># Default</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="l l-Scalar l-Scalar-Plain">127.0.0.1:7874</span><span class="w">    </span><span class="c1"># clash dns，关闭ipv6解析</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="c1"># my network</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="p p-Indicator">[</span><span class="nv">/lan/</span><span class="p p-Indicator">]</span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1:54</span><span class="w">   </span><span class="c1"># 局域网设备 *.lan解析</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="p p-Indicator">[</span><span class="nv">/my.to/</span><span class="p p-Indicator">]</span><span class="l l-Scalar l-Scalar-Plain">202.38.64.56</span><span class="w">  </span><span class="c1"># 使用学校dns，在无网络时解析路由器ipv6，用于建立wg</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="p p-Indicator">[</span><span class="nv">/us.to/</span><span class="p p-Indicator">]</span><span class="l l-Scalar l-Scalar-Plain">202.38.64.56</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="l l-Scalar l-Scalar-Plain"># 其余需要ipv6域名</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="l l-Scalar l-Scalar-Plain">[/pt/]119.29.29.29</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="l l-Scalar l-Scalar-Plain">[/ipw.cn/]119.29.29.29</span><span class="w">  </span><span class="c1"># 双栈，测试用</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="p p-Indicator">[</span><span class="nv">/wikipedia.org/</span><span class="p p-Indicator">]</span><span class="l l-Scalar l-Scalar-Plain">119.29.29.29</span>
</span></code></pre></div></p>
<h3 id="filters自定义域名解析">filters/自定义域名解析<a class="headerlink" href="#filters自定义域名解析" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/AdguardTeam/AdGuardHome/wiki/Hosts-Blocklists#dnstype">Hosts Blocklists · AdguardTeam/AdGuardHome Wiki (github.com)</a></p>
<p>位于网页Filters -&gt; custom filtering rules菜单中，以hosts文件的格式设置域名ip即可。
- 该功能还支持对域名进行blocking，见网页中给出的例子。
<img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/20230424141324.png" /></p>
<h4 id="某些域名只返回ipv6">某些域名只返回ipv6<a class="headerlink" href="#某些域名只返回ipv6" title="Permanent link">&para;</a></h4>
<p><a href="https://github.com/AdguardTeam/AdGuardHome/discussions/4482">Is it possible to return only the ipv6 address when having both ipv4 and ipv6 addresses · AdguardTeam/AdGuardHome · Discussion #4482 (github.com)</a></p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>||internal.my-campus.edu^$dnstype=A,dnsrewrite=NOERROR
</span></code></pre></div>
<p>关于是否支持prefer_ipv4的讨论：<a href="https://github.com/AdguardTeam/AdGuardHome/issues/5919">Prefer IPv4/6. However, it does not affect the resolution of pure IPv6/4 domain names. · Issue #5919 · AdguardTeam/AdGuardHome (github.com)</a>
- 有观点认为这应该是client做的事情</p>
<h3 id="问题">问题<a class="headerlink" href="#问题" title="Permanent link">&para;</a></h3>
<h4 id="重启后无法自启动">重启后无法自启动<a class="headerlink" href="#重启后无法自启动" title="Permanent link">&para;</a></h4>
<p>是由于启动脚本优先级冲突导致的。 <a href="https://forum.openwrt.org/t/adguardhome-doesnt-start-automatically/148957">AdguardHome doesn’t start automatically</a>
解决方法为修改procd启动优先级:
- 删除启动软连接（位于<code>/etc/rc.d/</code>）
<div class="language-text highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>service adguardhome disable
</span></code></pre></div>
- 修改启动脚本中的START和STOP值，<code>vim /etc/init.d/adguardhome</code>
<div class="language-text highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>START=95
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>STOP=01
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>## starts after network starts
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a>#START=21
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a>## stops before networking stops
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a>#STOP=89
</span></code></pre></div></p>
<h4 id="设备无法获得dns">设备无法获得dns<a class="headerlink" href="#设备无法获得dns" title="Permanent link">&para;</a></h4>
<p>发现手机设备不能获得dns了，显示为连上wifi后显示无法上网，浏览器打不开网页，但是app应用貌似都没有问题。
解决办法是在/etc/config/dhcp中添加dns option，强行设置dns。
<div class="language-text highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>config dhcp &#39;lan&#39;
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>    ...
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>    list dhcp_option &#39;6,192.168.36.1&#39;
</span></code></pre></div></p>
<p>记录下dnsmasq的设置，看下是否是不小心改错了。
<div class="language-text highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>config dnsmasq
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a>        option domainneeded &#39;1&#39;
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>        option localise_queries &#39;1&#39;
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>        option local &#39;/lan/&#39;
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>        option domain &#39;lan&#39;
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a>        option expandhosts &#39;1&#39;
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a>        option authoritative &#39;1&#39;
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>        option readethers &#39;1&#39;
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a>        option leasefile &#39;/tmp/dhcp.leases&#39;
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a>        option localservice &#39;1&#39;
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a>        option ednspacket_max &#39;1232&#39;
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a>        option rebind_protection &#39;0&#39;
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a>        option port &#39;54&#39;
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>        option localuse &#39;1&#39;
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a>        list server &#39;127.0.0.1#7874&#39;
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a>        option noresolv &#39;1&#39;
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17" href="#__codelineno-39-17"></a>        option cachesize &#39;0&#39;
</span></code></pre></div></p>
<p><a href="https://my.f5.com/manage/s/article/K03325735">Getting ''bad udp cksum'' when running tcpdump (f5.com)</a>
tcpdump时发现一个有意思的问题，dhcp reply显示bad udp cksum</p>
<blockquote>
<p>This is an expected behavior as tcpdump tool on Linux because the checksum is offloading on your NIC but tcpdump reads IP packets from the Linux kernel right before the actual checksum takes place in the NIC chipset.</p>
</blockquote>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>root@op2 ➜  ~ tcpdump -nvvv -i eth1 port 67 and port 68
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture size 262144 bytes
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>12:55:06.175120 IP (tos 0x0, ttl 128, id 28628, offset 0, flags [none], proto UDP (17), length 328)
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a>    192.168.36.180.68 &gt; 192.168.36.1.67: [udp sum ok] BOOTP/DHCP, Request from 28:11:a8:27:40:3e, length 300, xid 0xab30355a, Flags [none] (0x0000)
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a>          Client-IP 192.168.36.180
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a>          Client-Ethernet-Address 28:11:a8:27:40:3e
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a>          Vendor-rfc1048 Extensions
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a>            Magic Cookie 0x63825363
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>            DHCP-Message Option 53, length 1: Request
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a>            Client-ID Option 61, length 7: ether 28:11:a8:27:40:3e
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a>            Hostname Option 12, length 6: &quot;S3-Pro&quot;
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a>            FQDN Option 81, length 9: &quot;S3-Pro&quot;
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a>            Vendor-Class Option 60, length 8: &quot;MSFT 5.0&quot;
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a>            Parameter-Request Option 55, length 14:
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a>              Subnet-Mask, Default-Gateway, Domain-Name-Server, Domain-Name
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16" href="#__codelineno-40-16"></a>              Router-Discovery, Static-Route, Vendor-Option, Netbios-Name-Server
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17" href="#__codelineno-40-17"></a>              Netbios-Node, Netbios-Scope, Option 119, Classless-Static-Route
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18" href="#__codelineno-40-18"></a>              Classless-Static-Route-Microsoft, Option 252
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19" href="#__codelineno-40-19"></a>            END Option 255, length 0
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20" href="#__codelineno-40-20"></a>            PAD Option 0, length 0, occurs 2
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21" href="#__codelineno-40-21"></a>12:55:06.175586 IP (tos 0xc0, ttl 64, id 38812, offset 0, flags [none], proto UDP (17), length 340)
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22" href="#__codelineno-40-22"></a>    192.168.36.1.67 &gt; 192.168.36.180.68: [bad udp cksum 0xcb57 -&gt; 0x4904!] BOOTP/DHCP, Reply, length 312, xid 0xab30355a, Flags [none] (0x0000)
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23" href="#__codelineno-40-23"></a>          Client-IP 192.168.36.180
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24" href="#__codelineno-40-24"></a>          Your-IP 192.168.36.180
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25" href="#__codelineno-40-25"></a>          Server-IP 192.168.36.1
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26" href="#__codelineno-40-26"></a>          Client-Ethernet-Address 28:11:a8:27:40:3e
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27" href="#__codelineno-40-27"></a>          Vendor-rfc1048 Extensions
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28" href="#__codelineno-40-28"></a>            Magic Cookie 0x63825363
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29" href="#__codelineno-40-29"></a>            DHCP-Message Option 53, length 1: ACK
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30" href="#__codelineno-40-30"></a>            Server-ID Option 54, length 4: 192.168.36.1
</span><span id="__span-40-31"><a id="__codelineno-40-31" name="__codelineno-40-31" href="#__codelineno-40-31"></a>            Lease-Time Option 51, length 4: 43200
</span><span id="__span-40-32"><a id="__codelineno-40-32" name="__codelineno-40-32" href="#__codelineno-40-32"></a>            RN Option 58, length 4: 19452
</span><span id="__span-40-33"><a id="__codelineno-40-33" name="__codelineno-40-33" href="#__codelineno-40-33"></a>            RB Option 59, length 4: 35652
</span><span id="__span-40-34"><a id="__codelineno-40-34" name="__codelineno-40-34" href="#__codelineno-40-34"></a>            Subnet-Mask Option 1, length 4: 255.255.255.0
</span><span id="__span-40-35"><a id="__codelineno-40-35" name="__codelineno-40-35" href="#__codelineno-40-35"></a>            BR Option 28, length 4: 192.168.36.255
</span><span id="__span-40-36"><a id="__codelineno-40-36" name="__codelineno-40-36" href="#__codelineno-40-36"></a>            Default-Gateway Option 3, length 4: 192.168.36.1
</span><span id="__span-40-37"><a id="__codelineno-40-37" name="__codelineno-40-37" href="#__codelineno-40-37"></a>            Domain-Name Option 15, length 3: &quot;lan&quot;
</span><span id="__span-40-38"><a id="__codelineno-40-38" name="__codelineno-40-38" href="#__codelineno-40-38"></a>            FQDN Option 81, length 13: [SO] 255/255 &quot;S3-Pro.lan&quot;
</span><span id="__span-40-39"><a id="__codelineno-40-39" name="__codelineno-40-39" href="#__codelineno-40-39"></a>            Domain-Name-Server Option 6, length 4: 192.168.36.1
</span><span id="__span-40-40"><a id="__codelineno-40-40" name="__codelineno-40-40" href="#__codelineno-40-40"></a>            END Option 255, length 0
</span></code></pre></div>
<h3 id="配置文件">配置文件<a class="headerlink" href="#配置文件" title="Permanent link">&para;</a></h3>
<h4 id="upstream-dns-servers-settings">Upstream DNS servers settings<a class="headerlink" href="#upstream-dns-servers-settings" title="Permanent link">&para;</a></h4>
<ul>
<li><code>bootstrap_dns</code>: List of DNS servers used for initial hostname resolution in case an upstream server name is a hostname.</li>
<li>
<p><code>bootstrap_prefer_ipv6</code>: If <code>true</code>, instructs the bootstrapper to prefer IPv6 addresses to IPv4 ones when resolving DoH, DoQ, and DoT hostnames.</p>
</li>
<li>
<p><code>all_servers</code>: Enables parallel queries to all configured upstream servers to speed up resolving. If enabled, the queries are sent to each server simultaneously and the first response is chosen. If disabled, the queries are sent to each upstream server one-by-one and then sorted by RTT. Note that more stable upstream servers are preferred by the algorithm.</p>
</li>
</ul>
<p><strong>DNS cache settings</strong>
- <code>cache_size</code> — DNS cache size (in bytes).
- <code>cache_optimistic</code> (<strong>since v0.107.0</strong>) — Make AdGuard Home respond from the cache even when the entries are expired and also try to refresh them. Before <strong>v0.108.0-b.5</strong> the TTL for such responses is 60 seconds and since <strong>v0.108.0-b.5</strong> it's 10 seconds.</p>
<p><strong>Other settings</strong>
- <code>enable_dnssec</code>: Set DNSSEC flag in the outgoing DNS requests and check the result.
- <code>aaaa_disabled</code>: Respond with an empty answer to all <code>AAAA</code> requests.</p>
<h2 id="防火墙">防火墙<a class="headerlink" href="#防火墙" title="Permanent link">&para;</a></h2>
<p>参考
- fw3基于iptable/netfilter实现：<a href="https://openwrt.org/docs/guide-user/firewall/netfilter_iptables/netfilter_openwrt">[OpenWrt Wiki] Netfilter In OpenWrt</a>
- 在启动时运行iptable（firewall.user）：<a href="https://forum.openwrt.org/t/executing-scripts-at-boot-time/91992">Executing scripts at boot time - Installing and Using OpenWrt - OpenWrt Forum</a></p>
<p>从22.03版本开始，openwrt firwall后端，从iptables(fw3)换成了nftables(fw4)</p>
<h3 id="nftable">nftable<a class="headerlink" href="#nftable" title="Permanent link">&para;</a></h3>
<h4 id="参考">参考<a class="headerlink" href="#参考" title="Permanent link">&para;</a></h4>
<p>快速入门：<a href="https://openwrt.org/docs/guide-user/firewall/misc/nftables">[OpenWrt Wiki] nftables</a>
reference：<a href="https://www.netfilter.org/projects/nftables/manpage.html">Man page of NFT (netfilter.org)</a></p>
<h4 id="打印规则">打印规则<a class="headerlink" href="#打印规则" title="Permanent link">&para;</a></h4>
<p><code>fw4 print</code> dumps the nftables configuration that is built by fw4 and passed to nftables. It contains slightly higher-level code than the raw nftables state: fw4 uses variables, include files…</p>
<p><code>nft list ruleset</code> dumps the full nftables configuration from the kernel. This dump mixes data from different sources:
-   rules generated by fw4
-   rules included from external files (<code>/etc/nftables.d/*.nft</code> or <code>/usr/share/nftables.d/</code>)
-   rules added manually through the <code>nft</code> command</p>
<p><code>fw3 print</code> is the main utility to inspect iptable rules. Additionally the <code>iptable</code> command can be used to sort the rules differently and retrieve packet counts for matching rules. There are a number of arguments but the two most useful examples are:
<div class="language-text highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>iptables -t &lt;table&gt; -vnL
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a>iptables -t &lt;table&gt; -vS
</span></code></pre></div>
where
-   table is one of: <code>filter</code> (default), <code>nat</code>, <code>mangle</code>
-   <code>-v</code>: verbose, includes packet counts and physical interface name
-   <code>-n</code>: numeric output
-   <code>-L</code>: list rules
-   <code>-S</code>: print rules
The <code>-L</code> and <code>-S</code> arguments sort/format the output differently. The <code>-S</code> option is equivalent to using the <code>iptable-save</code> command.</p>
<ul>
<li>不能打印fw4，nft生成的规则</li>
<li>使用<code>iptables-save</code>打印所有table</li>
</ul>
<h3 id="配置文件_1">配置文件<a class="headerlink" href="#配置文件_1" title="Permanent link">&para;</a></h3>
<h4 id="总结">总结<a class="headerlink" href="#总结" title="Permanent link">&para;</a></h4>
<p><a href="https://openwrt.org/docs/guide-user/firewall/firewall_configuration">[OpenWrt Wiki] Firewall configuration /etc/config/firewall</a>
- zone：定义zone和路由器之间(input, output)，zone内不同接口间的(forward)规则。还可以定义从zone出去的masq
- forward: 定义zone之间的转发
- rule：用于指定特定host，端口是否允许放行，相当于对zone更细粒度的补充。
- redirect：SNAT，DNAT
- include：fw4(nftable), fw3(shell script，可以使用iptable)</p>
<h4 id="ntftable实现">ntftable实现<a class="headerlink" href="#ntftable实现" title="Permanent link">&para;</a></h4>
<p><strong>filter rules</strong>
- input, forward, output
- input_zone, forward_zone, output_zone
- accept_from_zone, accept_to_zone
<div class="language-text highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a>        chain forward {
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>                type filter hook forward priority filter; policy drop;
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>                ct state established,related accept comment &quot;!fw4: Allow forwarded established and related flows&quot;
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>                iifname { &quot;eth1&quot;, &quot;wg0&quot;, &quot;ztyou4dlov&quot; } jump forward_lan comment &quot;!fw4: Handle lan IPv4/IPv6 forward traffic&quot;
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a>                ...
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>                jump handle_reject
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a>        }
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>        chain forward_lan {
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a>                jump accept_to_wan comment &quot;!fw4: Accept lan to wan forwarding&quot;
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>                jump accept_to_wg_s2s comment &quot;!fw4: Accept lan to wg_s2s forwarding&quot;
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>                ct status dnat accept comment &quot;!fw4: Accept port forwards&quot;
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>                jump accept_to_lan
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>        }
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>        chain accept_to_wan {
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a>                oifname &quot;eth0&quot; counter accept comment &quot;!fw4: accept wan IPv4/IPv6 traffic&quot;
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a>        }
</span></code></pre></div></p>
<p><strong>nat rules</strong>
- dstnat
- srcnat
- dstnat_zone
- srcnat_zone
<div class="language-text highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>        chain srcnat {
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>                type nat hook postrouting priority srcnat; policy accept;
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a>                oifname { &quot;eth1&quot;, &quot;wg0&quot;, &quot;ztyou4dlov&quot; } jump srcnat_lan comment &quot;!fw4: Handle lan IPv4/IPv6 srcnat traffic&quot;
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a>                oifname &quot;eth0&quot; jump srcnat_wan comment &quot;!fw4: Handle wan IPv4/IPv6 srcnat traffic&quot;
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a>                oifname &quot;wg_s2s&quot; jump srcnat_wg_s2s comment &quot;!fw4: Handle wg_s2s IPv4/IPv6 srcnat traffic&quot;
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a>        }
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a>        chain srcnat_wg_s2s {
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a>                ip saddr 10.0.33.0/24 counter snat 10.0.33.2 comment &quot;!fw4: wg1-snat&quot;
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a>        }
</span></code></pre></div></p>
<p><strong>raw rules</strong>
<strong>mangle rules</strong></p>
<h3 id="自定义规则">自定义规则<a class="headerlink" href="#自定义规则" title="Permanent link">&para;</a></h3>
<p><a href="https://openwrt.org/docs/guide-user/firewall/firewall_configuration">[OpenWrt Wiki] Firewall configuration /etc/config/firewall</a></p>
<p>有时不满足于使用openwrt提供的方式设置防火墙，而想要直接运行iptable命令或者nftable命令。这种情况下可以使用<code>/etc/config/firewall</code>中<code>include</code>类型用于自定义规则。包含几种类型
- nftable方式，在一个文件中保存nftable规则
- scipt方式，直接运行iptable或者nftable命令
<em>由于openwrt 22.04后nftable取代了iptable，因此官方推荐使用nftable方式。</em></p>
<h4 id="nftable_1">nftable<a class="headerlink" href="#nftable_1" title="Permanent link">&para;</a></h4>
<p>在指定位置插入自定义table，chain或则rule
位置：</p>
<table>
<thead>
<tr>
<th>ruleset-pre</th>
<th>At the very beginning, before the fw4 table definition</th>
</tr>
</thead>
<tbody>
<tr>
<td>ruleset-post</td>
<td>At the very end, after the fw4 table definition</td>
</tr>
<tr>
<td>table-pre</td>
<td>At the beginning of the fw4 table, before any chain definition</td>
</tr>
<tr>
<td>table-post</td>
<td>At the end of the fw4 table, after all chains definition</td>
</tr>
<tr>
<td>chain-pre</td>
<td>At the beginning of $chain (defined in option chain), before rules in this chain</td>
</tr>
<tr>
<td>chain-post</td>
<td>At the end of $chain (defined in option chain), after rules in this chain</td>
</tr>
</tbody>
</table>
<div class="language-text highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a># /etc/config/firewall
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a>config include
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a>    option  type        &#39;nftables&#39;
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a>    option  path        &#39;/etc/my_custom_firewall_rule.nft&#39;
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a>    option  position    &#39;chain-pre&#39;
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a>    option  chain       &#39;input_wan&#39;
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a> 
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a># /etc/my_custom_firewall_rule.nft
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>tcp dport 0-1023 log prefix &quot;Inbound WAN connection attempt to low TCP port: &quot;
</span></code></pre></div>
<h4 id="script">script<a class="headerlink" href="#script" title="Permanent link">&para;</a></h4>
<p>可以使用iptables命令（fw3）或者nftables命令
<div class="language-text highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>config include
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a>    option  enabled     1
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a>    option  type        &#39;script&#39;
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>    option  path        &#39;/etc/firewall.user&#39;
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>  option    fw4_compatible  1    # 使用nftables命令需要指定
</span></code></pre></div></p>
<h2 id="策略路由">策略路由<a class="headerlink" href="#策略路由" title="Permanent link">&para;</a></h2>
<h3 id="gui配置文件">GUI/配置文件<a class="headerlink" href="#gui配置文件" title="Permanent link">&para;</a></h3>
<p>通过iproute2设置的策略路由不知如何保存。openwrt支持其它的方式设置，在luci中可以手动添加策略路由，如图所示。</p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20230217185649.png" /></p>
<p><img alt="" src="https://raw.githubusercontent.com/TheRainstorm/.image-bed/main/picgo/20230217185718.png" /></p>
<p>会在<code>network</code>文件中生成如下两条
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>config rule
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>        option priority &#39;20&#39;
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>        option lookup &#39;2&#39;
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a>config route
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a>        option target &#39;114.214.160.0/19&#39;
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a>        option gateway &#39;114.214.236.254&#39;
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a>        option table &#39;2&#39;
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a>        option interface &#39;wan&#39;
</span></code></pre></div></p>
<h1 id="系统">系统<a class="headerlink" href="#系统" title="Permanent link">&para;</a></h1>
<h2 id="基本软件包">基本软件包<a class="headerlink" href="#基本软件包" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>git curl wget
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a>zsh vim-full  tmux
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a>mtr iperf3
</span></code></pre></div>
<h2 id="使用zsh">使用ZSH<a class="headerlink" href="#使用zsh" title="Permanent link">&para;</a></h2>
<p>参考：<a href="https://gist.github.com/fire1ce/65d3e370120750a5deb283abe1d74491">Install oh-my-zsh on openwrt/lede-project (github.com)</a></p>
<p>安装必要的包
<div class="language-text highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>opkg update &amp;&amp; opkg install ca-certificates zsh curl git-http
</span></code></pre></div></p>
<p>安装oh-my-zsh，脚本安装可能会卡住，可以手动安装（见后）。</p>
<p>选择zsh为默认shell
<div class="language-text highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>which zsh &amp;&amp; sed -i -- &#39;s:/bin/ash:&#39;`which zsh`&#39;:g&#39; /etc/passwd
</span></code></pre></div></p>
<p>为了避免因删除zsh导致无法登录，可以在启动脚本<code>/etc/rc.local</code>中设置自动fallback回ash
<div class="language-text highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a># Revert root shell to ash if zsh is not available
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>if grep -q &#39;^root:.*:/usr/bin/zsh$&#39; /etc/passwd &amp;&amp; [ ! -x /usr/bin/zsh ]; then
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a>    # zsh is root shell, but zsh was not found or not executable: revert to default ash
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a>    [ -x /usr/bin/logger ] &amp;&amp; /usr/bin/logger -s &quot;Reverting root shell to ash, as zsh was not found on the system&quot;
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a>    sed -i -- &#39;s:/usr/bin/zsh:/bin/ash:g&#39; /etc/passwd
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a>fi
</span></code></pre></div></p>
<h3 id="oh-my-zsh手动安装">oh-my-zsh手动安装<a class="headerlink" href="#oh-my-zsh手动安装" title="Permanent link">&para;</a></h3>
<p>通常来说curl获得install脚本时会卡住，git clone仓库时也可能卡住，此时不如手动安装，查看<a href="https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh">install</a>脚本，会发现其实只做了几件事情：
- 将oh-my-zsh仓库克隆到$HOME下<code>.oh-my-zsh</code>
  - 可以从其他计算机scp到路由器里
- 复制zshrc文件：<code>cp .oh-my-zsh/templates/zshrc.zsh-template .zshrc</code>
  - 直接复制即可，不用修改内容
- chsh
  - openwrt没有chsh命令，需要修改/etc/passwd
  - <em>注意，如果修改错误（如直接输入zsh而不是从根开始的完整路径）可能导致无法登录openwrt</em></p>
<h3 id="fzf手动安装">fzf手动安装<a class="headerlink" href="#fzf手动安装" title="Permanent link">&para;</a></h3>
<p>想办法获得fzf仓库，可以从x86电脑scp。
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>~/.fzf/install  # 依赖bash，可以手动改为zsh，会下载fzf可执行程序。复制到/bin目录
</span></code></pre></div></p>
<p>创建.fzf.zsh文件
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1"># Auto-completion</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="c1"># ---------------</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="o">[[</span><span class="w"> </span><span class="nv">$-</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>*i*<span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;/root/.fzf/shell/completion.zsh&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="w"> </span>/dev/null
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="c1"># Key bindings</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="c1"># ------------</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;/root/.fzf/shell/key-bindings.zsh&quot;</span>
</span></code></pre></div></p>
<p>zshrc中添加
<div class="language-text highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a># fzf
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>[ -f ~/.fzf.zsh ] &amp;&amp; source ~/.fzf.zsh
</span></code></pre></div></p>
<h2 id="procd">procd<a class="headerlink" href="#procd" title="Permanent link">&para;</a></h2>
<ul>
<li>文档：<a href="https://openwrt.org/docs/guide-developer/procd-init-scripts">[OpenWrt Wiki] procd init scripts</a></li>
<li>例子讲解：<a href="https://openwrt.org/docs/guide-developer/procd-init-script-example">[OpenWrt Wiki] Create a sample procd init script</a></li>
</ul>
<p>procd是用于替代init的系统启动管理软件（进程号为1，命令/sbin/procd）</p>
<h3 id="示例">示例<a class="headerlink" href="#示例" title="Permanent link">&para;</a></h3>
<ul>
<li>START用于控制启动顺序（从小到大启动）</li>
<li>通过<code>ls -al /etc/rc.d/</code>查看启动顺序</li>
<li>procd使用openwrt UCI配置接口。配置文件位于<code>/etc/config/myservice</code>，通过<code>CONFIGURATION=myservice</code>指定</li>
<li><code>procd_set_param command</code>设置服务运行命令</li>
<li><code>procd_set_param stdout 1</code>将输出重定向到logd。通过logread查看
<div class="language-bash highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="ch">#!/bin/sh /etc/rc.common</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w"> </span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="nv">USE_PROCD</span><span class="o">=</span><span class="m">1</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a><span class="w"> </span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="nv">START</span><span class="o">=</span><span class="m">95</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="nv">STOP</span><span class="o">=</span><span class="m">01</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="w"> </span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8" href="#__codelineno-54-8"></a><span class="nv">CONFIGURATION</span><span class="o">=</span>myservice
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9" href="#__codelineno-54-9"></a><span class="w"> </span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10" href="#__codelineno-54-10"></a>start_service<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11" href="#__codelineno-54-11"></a><span class="w">    </span><span class="c1"># Reading config</span>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12" href="#__codelineno-54-12"></a><span class="w">    </span>config_load<span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CONFIGURATION</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13" href="#__codelineno-54-13"></a><span class="w">    </span><span class="nb">local</span><span class="w"> </span>name
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14" href="#__codelineno-54-14"></a><span class="w">    </span><span class="nb">local</span><span class="w"> </span>every
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15" href="#__codelineno-54-15"></a><span class="w"> </span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16" href="#__codelineno-54-16"></a><span class="w">    </span>config_get<span class="w"> </span>name<span class="w"> </span>hello<span class="w"> </span>name
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17" href="#__codelineno-54-17"></a><span class="w">    </span>config_get<span class="w"> </span>every<span class="w"> </span>hello<span class="w"> </span>every
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18" href="#__codelineno-54-18"></a><span class="w"> </span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19" href="#__codelineno-54-19"></a><span class="w">    </span>procd_open_instance
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20" href="#__codelineno-54-20"></a><span class="w"> </span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21" href="#__codelineno-54-21"></a><span class="w">    </span><span class="c1"># pass config to script on start</span>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22" href="#__codelineno-54-22"></a><span class="w">    </span>procd_set_param<span class="w"> </span><span class="nb">command</span><span class="w"> </span>/bin/sh<span class="w"> </span><span class="s2">&quot;/var/myscript.sh&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$name</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$every</span><span class="s2">&quot;</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23" href="#__codelineno-54-23"></a><span class="w">    </span>procd_set_param<span class="w"> </span>file<span class="w"> </span>/etc/config/myservice
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24" href="#__codelineno-54-24"></a><span class="w">    </span>procd_set_param<span class="w"> </span>stdout<span class="w"> </span><span class="m">1</span>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25" href="#__codelineno-54-25"></a><span class="w">    </span>procd_set_param<span class="w"> </span>stderr<span class="w"> </span><span class="m">1</span>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26" href="#__codelineno-54-26"></a><span class="w">    </span>procd_close_instance
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27" href="#__codelineno-54-27"></a><span class="o">}</span>
</span></code></pre></div></li>
</ul>
<h2 id="其它">其它<a class="headerlink" href="#其它" title="Permanent link">&para;</a></h2>
<h3 id="ssh-key登录">ssh key登录<a class="headerlink" href="#ssh-key登录" title="Permanent link">&para;</a></h3>
<ul>
<li>一般发行版本的 Linux 系统都是使用的 <code>sshd</code> 作为 ssh 服务端，我们将客户端的 <code>~/.ssh/id_rsa.pub</code> 拷贝到服务端的 <code>~/.ssh/authorized_keys</code> 即可</li>
<li>openwrt 使用的 <code>dropbear</code> 作为 ssh 的服务端程序，我们需要将公钥拷贝到 <code>/etc/dropbear/authorized_keys</code>，最好保证其文件权限是 644</li>
</ul>
<p>或者使用luci界面System--&gt;Admin--&gt;SSH key添加</p>
<h3 id="增大无线的发射功率">增大无线的发射功率<a class="headerlink" href="#增大无线的发射功率" title="Permanent link">&para;</a></h3>
<p>修改路由器的国家地区，使得无线的功率更大，因此信号更好。</p>
<p>Network--&gt;Wireless中选择Edit 2.4Ghz和5Ghz网络，在Advanced Setting中设置Country Code，可以修改为US。这样2.4Ghz和5Ghz信号功率变为30dBm和26dBm</p>
<h3 id="软件安装在usb上">软件安装在usb上<a class="headerlink" href="#软件安装在usb上" title="Permanent link">&para;</a></h3>
<p>正常情况，路由器的flash都很小，比如16MB，很难装下多少软件。但是如果路由器有USB接口的话，就可以插上U盘作为额外的存储空间。以GB为单位后，就可以随意安装软件了。
过程：</p>
<ol>
<li>
<p><code>/etc/opkg.conf</code>中添加usb dest
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="c1">#/etc/opkg.conf</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a>dest<span class="w"> </span>root<span class="w"> </span>/
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a>dest<span class="w"> </span>usb<span class="w"> </span>/mnt/sdb1<span class="w">       </span><span class="c1">#添加此行, sdb1为挂载的U盘位置</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a>dest<span class="w"> </span>ram<span class="w"> </span>/tmp
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a>lists_dir<span class="w"> </span>ext<span class="w"> </span>/var/opkg-lists
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a>option<span class="w"> </span>overlay_root<span class="w"> </span>/overlay
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a>option<span class="w"> </span>check_signature
</span></code></pre></div></p>
</li>
<li>
<p>opkg安装软件时，添加<code>-d usb</code>选项，如安装python
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>opkg<span class="w"> </span>install<span class="w"> </span>-d<span class="w"> </span>usb<span class="w"> </span>python3<span class="w"> </span>python3-pip
</span></code></pre></div></p>
</li>
<li>
<p>不知为何，安装在usb上时，opkg创建软链接时会报错，导致直接运行命令会报错。因此可能需要自己手动创建软连接，如python需要创建以下软连接
   <div class="language-bash highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/sdb1/usr/bin/python3.9<span class="w"> </span>/usr/bin/python3
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/sdb1/usr/lib/libpython3.9.so.1.0<span class="w"> </span>/usr/lib/libpython3.9.so.1.0
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/sdb1/usr/bin/pip3.9<span class="w"> </span>/usr/bin/pip
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a>ln<span class="w"> </span>-s<span class="w"> </span>/mnt/sdb1/usr/bin/pip3.9<span class="w"> </span>/usr/bin/pip3
</span></code></pre></div></p>
</li>
</ol>
<h1 id="其它_1">其它<a class="headerlink" href="#其它_1" title="Permanent link">&para;</a></h1>
<h2 id="webcam设备">webcam设备<a class="headerlink" href="#webcam设备" title="Permanent link">&para;</a></h2>
<div class="language-text highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>kmod-video-core kmod-video-uvc
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a>luci-app-mjpg-streamer  # mjpg-streamer的每个组件需要单独安装
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a>mjpg-streamer mjpg-streamer-input-uvc mjpg-streamer-output-http mjpg-streamer-www-simple
</span></code></pre></div>
<div class="language-text highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a>root@p2w:~# opkg list-installed |grep usb
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a>kmod-usb-audio - 5.10.161-1
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a>kmod-usb-core - 5.10.161-1
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a>kmod-usb-dwc3 - 5.10.161-1
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a>kmod-usb-dwc3-qcom - 5.10.161-1
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a>kmod-usb-storage - 5.10.161-1
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a>kmod-usb-xhci-hcd - 5.10.161-1
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a>kmod-usb3 - 5.10.161-1
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a>root@p2w:~# opkg list-installed |grep video
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a>kmod-video-core - 5.10.161-1
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a>kmod-video-uvc - 5.10.161-1
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a>kmod-video-videobuf2 - 5.10.161-1
</span></code></pre></div>
<h2 id="音频设备">音频设备<a class="headerlink" href="#音频设备" title="Permanent link">&para;</a></h2>
<h3 id="驱动">驱动<a class="headerlink" href="#驱动" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a>opkg install kmod-usb-audio (kmod-sound-core)
</span></code></pre></div>
<p>此时已经有驱动了，通过<code>/proc/asound</code>查看设备
<div class="language-text highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>root@p2w:~# cat /proc/asound/cards
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a> 0 [Lanseyaoji     ]: USB-Audio - Lanseyaoji
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>FEC Lanseyaoji at usb-xhci-hcd.0.auto-1, high speed
</span></code></pre></div></p>
<p>安装alsa-utils，可以使用arecord, aplay工具</p>
<blockquote>
<p>arecord, aplay - command-line sound recorder and player for ALSA soundcard driver</p>
</blockquote>
<div class="language-text highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>opkg install alsa-utils
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>root@p2w:~# opkg files alsa-utils
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>Package alsa-utils (1.2.6-1) is installed on root and has the following files:
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>/usr/share/alsa/init/ca0106
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>/usr/bin/amixer
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>/usr/share/alsa/init/test
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>/usr/share/alsa/init/info
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>/usr/share/alsa/init/hda
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>/usr/bin/alsamixer
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>/usr/share/alsa/init/default
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>/usr/bin/arecord
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>/usr/share/alsa/init/00main
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>/usr/share/alsa/init/help
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>/usr/bin/aplay
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>/usr/sbin/alsactl
</span></code></pre></div>
<h3 id="alsa-utils">alsa-utils<a class="headerlink" href="#alsa-utils" title="Permanent link">&para;</a></h3>
<p><code>arecord -d 10 -f cd -t wav -D copy foobar.wav</code> will record foobar.wav as a 10-second, CD-quality wave file</p>
<p><code>arecord -f cd -t wav --max-file-time 3600 --use-strftime %Y/%m/%d/listen-%H-%M-%v.wav</code>
Record in stereo from the default audio source. Create a new file every hour. The files are placed in directories based on their start dates and have names which include their start times and file numbers.</p>
<h3 id="pulseaudio">pulseaudio<a class="headerlink" href="#pulseaudio" title="Permanent link">&para;</a></h3>
<p>想要达到的效果：在windows上实时监听路由器usb麦克风的音频。
实现的效果：在linux上实时监听路由器usb麦克风的音频。</p>
<ul>
<li>
<p>安装pulseaudio：<a href="https://openwrt.org/docs/guide-user/hardware/audio/pulseaudio">[OpenWrt Wiki] PulseAudio</a>
<div class="language-text highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a>opkg install pulseaudio-tools pulseaudio-profiles
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a>root@p2w \u@\h:\w\$ opkg list-installed |grep pulse                                                                                                                                                                                                                               19:04:09
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a>pulseaudio-daemon-avahi - 14.2-8
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a>pulseaudio-profiles - 14.2-8
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a>pulseaudio-tools - 14.2-8
</span></code></pre></div></p>
</li>
<li>
<p>修改system.pa（system模式启动使用该文件，per-user模式启动使用default.pa）
<div class="language-text highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a>vim /etc/pulse/system.pa
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a># 开启tcp访问，有几种不同的访问控制
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a>#load-module module-native-protocol-tcp # server和client需要有相同的cookie，位于`~/.config/pulse/cookie`
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a>load-module module-native-protocol-tcp auth-anonymous=1  # 允许匿名
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a>#load-module module-native-protocol-tcp auth-ip-acl=127.0.0.1;192.168.0.0/24 # 通过ip访问控制
</span></code></pre></div></p>
</li>
<li>
<p>启动pulseaudio
<div class="language-text highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a>service pulseaudio start  # 会以system模式启动（ps命令行中可以看到--system）, pactl无法使用
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a>ps |grep pulseaudio
</span></code></pre></div></p>
</li>
<li>
<p>在client上（比如linux笔记本），实时播放音频
<div class="language-text highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a>#load-module module-tunnel-sink server=192.168.36.230
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a>load-module module-tunnel-source server=192.168.36.230
</span></code></pre></div></p>
</li>
</ul>
<h1 id="遇到的问题">遇到的问题<a class="headerlink" href="#遇到的问题" title="Permanent link">&para;</a></h1>
<h3 id="系统时间导致opkg无法下载">系统时间导致opkg无法下载<a class="headerlink" href="#系统时间导致opkg无法下载" title="Permanent link">&para;</a></h3>
<p>通过wget url，发现以下错误
<div class="language-text highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a>Connection error: Invalid SSL certificate
</span></code></pre></div></p>
<p>查找SSL 证书错误原因，有一项是系统时间不一致导致的。
在openwrt System -&gt; System Localtime中，可以选择sync with browser。同步后问题解决。</p>
<h3 id="ddns-curl-48错误">ddns curl 48错误<a class="headerlink" href="#ddns-curl-48错误" title="Permanent link">&para;</a></h3>
<p>导致ddns无法正常运行
<div class="language-text highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a>Sat May  6 23:28:44 2023 user.warn ddns-scripts[12337]: FreeDNS: Transfer failed - retry 7/0 in 60 seconds
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a>Sat May  6 23:29:41 2023 user.err ddns-scripts[11285]: FreeDNS_2_ipv6: cURL Error: &#39;48&#39;
</span></code></pre></div></p>
<p>需要更新curl：<a href="https://forum.openwrt.org/t/using-curl-libcurl4-for-sending-mails/141105/2">Using curl/libcurl4 for sending mails - Installing and Using OpenWrt - OpenWrt Forum</a></p>
<blockquote>
<p>Error code 48 in curl refers to "<code>An unknown option was passed in to libcurl</code>", which would be in line with OpenWrt's tendency to disable optional features for size reasons (apparently you can enable <code>LIBCURL_SMTP</code> when building from source).</p>
</blockquote>
<p>图形化界面更新curl和libcurl</p>
<h3 id="ddns无法自动启动">ddns无法自动启动<a class="headerlink" href="#ddns无法自动启动" title="Permanent link">&para;</a></h3>
<p>看到22.03还有人遇到一样问题：<a href="https://openwrt.org/docs/guide-user/services/ddns/client#operation">[OpenWrt Wiki] DDNS client</a>
手动重启ddns服务可以，但是重启路由器后，ddns仍然不在运行。</p>
<p>修改了procd顺序仍然不行，暂时通过rc.local中手动重启ddns解决
<div class="language-text highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a>vim /etc/rc.local
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a>service ddns restart
</span></code></pre></div></p>
<h3 id="luci-proto安装后不显示">luci-proto安装后不显示<a class="headerlink" href="#luci-proto安装后不显示" title="Permanent link">&para;</a></h3>
<p><a href="https://forum.openwrt.org/t/luci-proto-wont-appear-in-luci-after-installation/53419">Luci-proto won't appear in LuCI after installation - Installing and Using OpenWrt - OpenWrt Forum</a>
<div class="language-text highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a>/etc/init.d/network restart
</span></code></pre></div></p>
<p>如果安装是安装了luci-app-xxx，想要在luci中显示。
- 方法一：登出然后登录
- 方法二：<code>/etc/init.d/rpcd restart</code></p>
<h3 id="git-remote-https-is-not-a-git-command">git: 'remote-https' is not a git command.<a class="headerlink" href="#git-remote-https-is-not-a-git-command" title="Permanent link">&para;</a></h3>
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>opkg install git-http
</span></code></pre></div>
<p>git-http
- Git is a free &amp; open source, distributed version control system designed to handle everything from small to very large projects with speed and efficiency. This package allows <strong>git push/fetch over http(s) and ftp(s)</strong></p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
        
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2022-02-13-%E8%AE%B0%E5%BD%95%E7%BA%A2%E7%B1%B3AC2100%E6%8A%98%E8%85%BE/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 记录红米AC2100折腾">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                记录红米AC2100折腾
              </div>
            </div>
          </a>
        
        
          
          <a href="../2022-02-13-openwrt%E7%BC%96%E8%AF%91/" class="md-footer__link md-footer__link--next" aria-label="下一页: openwrt编译">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                openwrt编译
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>