
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录一些关于数学、计算机的知识，以及一些日常。">
      
      
      
        <link rel="canonical" href="https://yfy.cqu.ai/archive/2021/">
      
      
        <link rel="prev" href="../2022/">
      
      
        <link rel="next" href="../2020/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.3">
    
    
      
        <title>2021 - Rain的随笔</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.50c56a3b.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2021" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Rain的随笔" class="md-header__button md-logo" aria-label="Rain的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Rain的随笔
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2021
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  博客

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../about/" class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tags/" class="md-tabs__link">
        
  
    
  
  标签

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../series/" class="md-tabs__link">
        
  
    
  
  系列

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../tools/" class="md-tabs__link">
        
  
    
  
  工具

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../2024/" class="md-tabs__link">
          
  
  归档

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../category/homelab/" class="md-tabs__link">
          
  
  分类

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Rain的随笔" class="md-nav__button md-logo" aria-label="Rain的随笔" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Rain的随笔
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../about/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tags/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    标签
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../series/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    系列
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    归档
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            归档
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2023/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2023
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    2021
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#记一次路由器刷出问题修复过程" class="md-nav__link">
    <span class="md-ellipsis">
      记一次路由器刷出问题修复过程
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#openwrt折腾" class="md-nav__link">
    <span class="md-ellipsis">
      Openwrt折腾
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ucore-mips-代码分析" class="md-nav__link">
    <span class="md-ellipsis">
      ucore-mips 代码分析
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#更新固态之旅" class="md-nav__link">
    <span class="md-ellipsis">
      更新固态之旅
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux内核设计与实现阅读" class="md-nav__link">
    <span class="md-ellipsis">
      linux内核设计与实现阅读
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    分类
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            分类
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/homelab/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    homelab
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E4%B8%AA%E4%BA%BA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    博客
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    如何实现网络自由
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    学习
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E6%8A%98%E8%85%BE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    折腾
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E6%9D%82%E6%96%87/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    杂文
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E8%99%9A%E6%8B%9F%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    虚拟化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E8%AE%BE%E5%A4%87/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    设备
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E8%AF%BE%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    课程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../category/%E9%98%85%E8%AF%BB/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    阅读
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="2021">2021<a class="headerlink" href="#2021" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-10-17 01:03:03">2021年10月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE/" class="md-meta__link">折腾</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 7 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="记一次路由器刷出问题修复过程"><a class="toclink" href="../../%E6%8A%98%E8%85%BE/2021/10/17/2021-10-17-%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B7%AF%E7%94%B1%E5%99%A8%E5%88%B7%E5%87%BA%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D%E8%BF%87%E7%A8%8B/">记一次路由器刷出问题修复过程</a></h2>
<h4 id="前言"><a class="toclink" href="../../%E6%8A%98%E8%85%BE/2021/10/17/2021-10-17-%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B7%AF%E7%94%B1%E5%99%A8%E5%88%B7%E5%87%BA%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D%E8%BF%87%E7%A8%8B/#前言">前言</a></h4>
<p>起因是想在openwrt上装上<strong>openclash</strong>插件，但路由器空间不够了（路由器为mi4a千兆版，有一个16M的NOR flash。通过在编译时设置块大小为512KB，成功安装了<code>zerotier</code>,<code>wireguard</code>,<code>python</code>等软件，编译的镜像大小为13,894,754 B），因此参考官方教程：[<a href="https://openwrt.org/docs/guide-user/additional-software/saving_space">OpenWrt Wiki] Saving firmware space and RAM</a>，在编译时关闭了一些内核相关的选项，并将块大小设置为了1MB。最后成功生成镜像，大小为14,943,330 B。</p>
<p>可没想到在更新系统后路由器无法正确启动，于是需要先使用小米官方工具恢复，然后再重刷openwrt系统。但考虑到之后如果要多次尝试的话，每次失败都需要先恢复官方系统然后重新刷比较麻烦。于是这一次重装，我选择了刷<strong>breed</strong>引导程序。这样，下次刷失败后便可以通过breed直接重刷固件。</p>
<p>然而，不知是否是因为操作过程中的一个失误，我使用breed刷openwrt会失败，路由器会无限重启。并且在刷回官方固件后，甚至无法上网。最后，我从原厂固件直接刷回了openwrt，但是却发现openwrt中的<strong>5GHz的无线最大发射功率(Maximum transmit power)居然变为了1mW(3dBm)</strong>，这导致路由器的5G信号非常弱，即使是1m的距离，信号也很弱。于是我各种尝试去修复这个问题，以下是记录的过程。</p>

    <nav class="md-post__action">
      <a href="../../%E6%8A%98%E8%85%BE/2021/10/17/2021-10-17-%E8%AE%B0%E4%B8%80%E6%AC%A1%E8%B7%AF%E7%94%B1%E5%99%A8%E5%88%B7%E5%87%BA%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D%E8%BF%87%E7%A8%8B/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-09-17 00:15:15">2021年9月17日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE/" class="md-meta__link">折腾</a>, 
              <a href="../../category/%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%BD%91%E7%BB%9C%E8%87%AA%E7%94%B1/" class="md-meta__link">如何实现网络自由</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="openwrt折腾"><a class="toclink" href="../../%E6%8A%98%E8%85%BE/2021/09/17/2021-09-17-Openwrt%E6%8A%98%E8%85%BE/">Openwrt折腾</a></h2>
<ul>
<li>移动宽带开启ipv6</li>
<li>Openwrt安装ZeroTier</li>
<li>Openwrt配置ipv6</li>
<li>CPU性能测试</li>
</ul>

    <nav class="md-post__action">
      <a href="../../%E6%8A%98%E8%85%BE/2021/09/17/2021-09-17-Openwrt%E6%8A%98%E8%85%BE/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-04-06 22:51:13">2021年4月6日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E8%AF%BE%E7%A8%8B/" class="md-meta__link">课程</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 15 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="ucore-mips-代码分析"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">ucore-mips 代码分析</a></h2>
<div class="toc">
<ul>
<li><a href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#ucore-mips-代码分析">ucore-mips 代码分析</a></li>
</ul>
</div>
<h4 id="1-makefile"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#1-makefile">1. Makefile</a></h4>
<ol>
<li><code>boot/loader.bin</code>基本就是一个读取elf的函数，我们上板使用pmon加载ucore，因此用不到。</li>
<li><code>obj/ucore-kernel-initrd</code>是一个elf文件，特殊之处在于，它的data段包含<code>user/_archive</code>目录下的文件（包含一个test.txt）和<code>$(USER_APP_BINS)</code>（如sh, ls等用户程序）的内容。<strong>将内核和文件系统打包到了一起</strong>。</li>
</ol>
<h4 id="2-kernel_entry"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#2-kernel_entry">2. kernel_entry</a></h4>
<p>kern/init/entry.S</p>
<ol>
<li>设置了$gp</li>
</ol>
<p>定义在链接脚本里，可以通过<code>readelf obj/ucore-kernel-initrd -a|grep _gp</code>来查看其值。参考值（修改了代码编译出的值可能不一样）<code>0x800c7f40</code></p>
<ol>
<li>设置了$sp，启动时用的栈，栈大小为<code>KSTACKSIZE</code>，8KB</li>
</ol>
<p>参考值：<code>bootstacktop(0x80068730)</code>，<code>bootstack(0x80066730)</code></p>
<ol>
<li>设置了Ebase为<code>__exception_vector</code>。参考值：<code>0x8002b000</code>。__exception_vector包含了各异常向量地址的入口。</li>
</ol>
<h4 id="3-kern_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#3-kern_init">3. kern_init</a></h4>
<p>kern/int/init.c</p>
<h5 id="杂项"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#杂项">杂项</a></h5>
<h6 id="tlb_invalidate_all"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#tlb_invalidate_all">tlb_invalidate_all</a></h6>
<p>定义于kern/include/thumips_tlb.h和kern/mm/thumips_tlb.c</p>
<p>tlb_invalidata_all循环调用write_one_tlb清空tlb表项
<strong>默认tlb有128项</strong>，虽然不会导致错误，但是可以优化</p>
<h6 id="pic_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pic_init">pic_init</a></h6>
<p>定义于kern/driver/picirq.c
pic_init -&gt; write_c0_status
将Statu中的IM域全置0，关闭所有中断。
之后可以通过pic_enable(int irq)或pic_disable(int irq)开关中断</p>
<h6 id="cons_init--clock_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#cons_init--clock_init">cons_init &amp; clock_init</a></h6>
<p>一个初始化串口，一个初始化时钟中断。</p>
<p>相关宏定义于/kern/include/thumips.h</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="cp">#define COM1_IRQ        3</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="cp">#define TIMER0_IRQ       7</span>
</span></code></pre></div>
<p>clock需要用到<code>cp0_count</code>和<code>cp0_compare</code>
设置clock中断后，每<code>clock.c::TIMER0_INTERVAL</code>=1000000后会产生一个时钟中断</p>
<h6 id="check_initrd"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_initrd">check_initrd</a></h6>
<p>检查内核是否有initrd，通过判断是否_initrd_begin == _initrd_end)</p>
<h5 id="kprintf"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kprintf">kprintf</a></h5>
<p>内核第一次输出信息</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;(THU.CST) os is loading ...</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
</span></code></pre></div>
<p>kprintf函数最后调用串口的cons_putc输出字符。串口输出字符采用忙等待方式。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">kprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vkprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">printfmt</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vprintfmt</span><span class="p">(</span><span class="n">cputch</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cputch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">driver</span><span class="o">/</span><span class="n">console</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cons_putc</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="cp">#!kern/driver/console.c</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="nf">serial_putc_sub</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">COM1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COM_LSR</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">COM_LSR_TXRDY</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="n">COM1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">COM_TX</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>作为对比，用户程序cprintf</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vcprintf</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">vprintfmt</span><span class="p">(</span><span class="n">cputch</span><span class="p">,</span><span class="w"> </span><span class="p">...)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">cputch</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">user</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">sys_putc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">syscall</span><span class="p">(</span><span class="n">SYS_putc</span><span class="p">,</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="n">系统调用</span><span class="err">，</span><span class="n">进入内核</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="n">异常处理程序调用kern</span><span class="o">/</span><span class="n">syscall</span><span class="o">/</span><span class="n">syscall</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">sys_putc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">kern</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">stdio</span><span class="p">.</span><span class="n">c</span><span class="o">::</span><span class="n">kputchar</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">cons_putc</span>
</span></code></pre></div>
<p><strong>用户程序输出每一个字符都会触发一次系统调用</strong></p>
<h5 id="pmm_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pmm_init">pmm_init</a></h5>
<h6 id="page结构体"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page结构体">page结构体</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">ref</span><span class="p">;</span><span class="w">                   </span><span class="c1">// page frame&#39;s reference counter</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                 </span><span class="c1">// array of flags that describe the status of the page frame</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">property</span><span class="p">;</span><span class="w">          </span><span class="c1">// used in buddy system, stores the order (the X in 2^X) of the continuous memory block</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">zone_num</span><span class="p">;</span><span class="w">                   </span><span class="c1">// used in buddy system, the No. of zone which the page belongs to</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">page_link</span><span class="p">;</span><span class="w">         </span><span class="c1">// free list link</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="c1">//    swap_entry_t index;             // stores a swapped-out page identifier</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">swap_link</span><span class="p">;</span><span class="w">         </span><span class="c1">// swap hash link</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="p">};</span>
</span></code></pre></div>
<p>ucore将物理内存划分成一个一个的页，并使用Page结构体数组来管理。一个Page项对应一个物理页。</p>
<p>参考pmm.c::page_init代码</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;memory map:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;    [&quot;</span><span class="p">);</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="n">printhex</span><span class="p">(</span><span class="n">KERNBASE</span><span class="p">);</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="n">printhex</span><span class="p">(</span><span class="n">KERNTOP</span><span class="p">);</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="n">maxpa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KERNTOP</span><span class="p">;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">npage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KMEMSIZE</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="c1">// end address of kernel</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="k">extern</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">end</span><span class="p">[];</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1">// put page structure table at the end of kernel</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">pages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ROUNDUP_2N</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div>
<p><code>KMEMSIZE</code>代表内核管理的物理内存的大小，npage计算出来为物理页的个数。</p>
<p>end在链接脚本中定义，为ucore-kernel-initrd的结尾。即ucore在内核的结尾分配了（直接写）Page数组的空间，pages为数组的起始地址。</p>
<p>此时page项可以和物理页一一对应起来了</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="n">ppn_t</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nf">page2ppn</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">page</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pages</span><span class="p">;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="p">}</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">uintptr_t</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="nf">page2pa</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KERNBASE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">page2ppn</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="p">}</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="n">pa2page</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PPN</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">npage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;pa2page called with invalid pa&quot;</span><span class="p">);</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pages</span><span class="p">[</span><span class="n">PPN</span><span class="p">(</span><span class="n">pa</span><span class="p">)];</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="p">}</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="n">page2kva</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">KADDR</span><span class="p">(</span><span class="n">page2pa</span><span class="p">(</span><span class="n">page</span><span class="p">));</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="p">}</span>
</span></code></pre></div>
<p>这里强调一下<code>page2kva</code>中<code>KADDR</code>的作用，事实上如果看其定义的话，KADDR(pa)的值和pa是一样的，如下</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cm">/* *</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="cm"> * PADDR - takes a kernel virtual address (an address that points above KERNBASE),</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="cm"> * where the machine&#39;s maximum 256MB of physical memory is mapped and returns the</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="cm"> * corresponding physical address.  It panics if you pass it a non-kernel virtual address.</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="cm"> * */</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="cp">#define PADDR(kva) ({                                                   \</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="cp">            uintptr_t __m_kva = (uintptr_t)(kva);                       \</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="cp">            if (__m_kva &lt; KERNBASE) {                                   \</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="cp">                panic(&quot;PADDR called with invalid kva %08lx&quot;, __m_kva);  \</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="cp">            }                                                           \</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="cp">            __m_kva ;                                         \</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="cp">        })</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="cm">/* *</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="cm"> * KADDR - takes a physical address and returns the corresponding kernel virtual</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="cm"> * address. It panics if you pass an invalid physical address.</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="cm"> * */</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="cp">#define KADDR(pa) ({                                                    \</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="cp">            uintptr_t __m_pa = (pa);                                    \</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="cp">            size_t __m_ppn = PPN(__m_pa);                               \</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="cp">            if (__m_ppn &gt;= npage) {                                     \</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="cp">                panic(&quot;KADDR called with invalid pa %08lx&quot;, __m_pa);    \</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="cp">            }                                                           \</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="cp">            (void *) (__m_pa);                               \</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="cp">        })</span>
</span></code></pre></div>
<p>而之所以需要进行一次转换，主要是保持逻辑上的一致性。因为CPU直接发出的地址都是虚拟地址，会经过MMU进行虚拟地址转换（一般基于TLB，而TLB基于操作系统管理的页表）。整个转换过程是硬件自动完成的，因此软件基本不用和物理地址打交道（操作系统中涉及到和硬件软硬件协同的部分会涉及到物理地址，如页表中存储的地址是物理地址，当MIPS中tlb refill异常时，便会读取页表项加载到TLB表项中）</p>
<p>因而我们在代码中访问数据时都要使用虚拟地址。</p>
<p>因为这里的整个内核虚拟空间（<code>[KERNBASE, KERNBASE+KMEMSIZE]=[0x8000_0000, 0x8200_0000)</code>）都位于MIPS中的kseg0段，而该段采用固定地址映射的方式，而不使用TLB，因此内核访问整个内核虚拟地址空间丝毫不用担心。</p>
<h6 id="这里应该有一个错误"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#这里应该有一个错误">这里应该有一个错误</a></h6>
<p>按照定义来说，page2pa就应该是(page2ppn(page) &lt;&lt; PGSHIFT)，加了KERNBASE后反而是虚拟地址了。</p>
<p>不过因为KADDR也错了，因此当我们分配了一个空闲物理页page后，要获得其虚拟地址</p>
<p><code>KADDR(page2pa(page))</code>反而没错了</p>
<h6 id="空闲页"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#空闲页">空闲页</a></h6>
<p>空闲地址开始于Page数组之后。init_memmap会调用pmm_manager的init_memmap函数，用于记录哪些页是空闲的。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">freemem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PADDR</span><span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">pages</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">npage</span><span class="p">);</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;freemem start at: &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">freemem</span><span class="p">);</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mbegin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDUP_2N</span><span class="p">(</span><span class="n">freemem</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="kt">uint32_t</span><span class="w"> </span><span class="n">mend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">KERNTOP</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">mbegin</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">mend</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="n">init_memmap</span><span class="p">(</span><span class="n">pa2page</span><span class="p">(</span><span class="n">mbegin</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">mend</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mbegin</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;free pages: &quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">mend</span><span class="o">-</span><span class="n">mbegin</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="n">PRINT_HEX</span><span class="p">(</span><span class="s">&quot;## &quot;</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="p">));</span>
</span></code></pre></div>
<h6 id="pmm_manager"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pmm_manager">pmm_manager</a></h6>
<p>物理内存管理其实就是要实现<strong>物理空闲页</strong>的分配和回收，ucore定义了pmm_manager的结构体，可以认为C中实现的类。</p>
<p>关键的两个函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alloc_pages</span><span class="p">)(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">free_pages</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div>
<p>alloc_pages从空闲页中分配了一段连续的空闲页</p>
<p>而free_pages则将指定的一段连续的页重新回收为空闲页</p>
<p>ucore代码实现了伙伴分配系统(buddy system)，可以参考其具体实现</p>
<h6 id="页表相关函数"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#页表相关函数">页表相关函数</a></h6>
<p>ucore实现了二级页表</p>
<p>关键函数</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="nf">get_pte</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">create</span><span class="p">);</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">get_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">**</span><span class="n">ptep_store</span><span class="p">);</span><span class="w">  </span><span class="c1">//根据pte的值获得对应的page</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">page_remove</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">);</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">page_insert</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="get_pte"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#get_pte">get_pte</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_pte</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">create</span><span class="p">)</span>
</span></code></pre></div>
<p>函数作用：给定页目录表的虚拟地址，查找虚拟地址la对应的页表项pte。（只要la在一个页内，返回的pte是相同的）
    注：获得的是pte项的<strong>虚拟地址</strong>
过程：</p>
<ol>
<li>先计算页目录表中对应pde表项的虚拟地址</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">pdep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PDX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>如果pde项有效，即<code>((*pdep)&amp;PTE_P) == 0</code>。直接访问pde获得la对应二级页表的物理地址。</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>计算二级页表中对应页表项pte的<strong>物理</strong>地址</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)(</span><span class="w">    </span><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">)</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PTX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>转换成虚拟地址</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)</span><span class="n">KADDR</span><span class="p">(</span><span class="w">   </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="w">  </span><span class="p">(</span><span class="n">pte_t</span><span class="o">*</span><span class="p">)(</span><span class="n">PDE_ADDR</span><span class="p">(</span><span class="o">*</span><span class="n">pdep</span><span class="p">))</span><span class="o">+</span><span class="n">PTX</span><span class="p">(</span><span class="n">la</span><span class="p">)</span><span class="w">  </span><span class="p">)</span><span class="w">  </span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>如果02中无效，则需要根据create决定是否创建二级页表。（下面代码只考虑了创建情形，并为了突出重点，删减了许多有用的代码）</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="o">*</span><span class="w"> </span><span class="n">new_pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">pa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">page2kva</span><span class="p">(</span><span class="n">new_pte</span><span class="p">);</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="o">*</span><span class="n">pdep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PADDR</span><span class="p">(</span><span class="n">pa</span><span class="p">);</span>
</span></code></pre></div>
<p>最后一行，页表中存储的是物理地址。然而根据之前的分析，我们知道上面代码中的PADDR(pa)实际上是虚拟地址。然而我们发现在这样设置之后，下次调用get_pte时，获得的pte的地址确实是虚拟地址（KADDR不产生作用）。</p>
<h6 id="page_insert"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page_insert">page_insert</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">page_insert</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
</span></code></pre></div>
<p>作用：将虚拟地址la映射到page对应的物理页上</p>
<p>步骤：</p>
<ol>
<li>
<p>根据虚拟地址la查找到二级页表项ptep</p>
</li>
<li>
<p>如果原本ptep已经映射到另一个物理页上了，则删除该映射（有可能导致回收物理页）</p>
</li>
<li>
<p>设置ptep映射到新物理页</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>*ptep = page2pa(page) | PTE_P | perm;
</span></code></pre></div>
<p>由以上代码，可以看到二级页表项中存储的地址其实是虚拟地址。</p>
<h6 id="page_remove"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#page_remove">page_remove</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">page_remove</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span></code></pre></div>
<p>作用：解除pgdir中虚拟地址la的映射</p>
<p>步骤：</p>
<ol>
<li>获得pte</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>如果<code>ptep != NULL</code>且<code>*ptep &amp; PTE_P</code>，</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pte2page</span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="n">page_ref_dec</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="c1">// and free it when reach 0</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="k">if</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">    </span><span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>清除映射</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span></code></pre></div>
<h6 id="pgdir_alloc_page"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#pgdir_alloc_page">pgdir_alloc_page</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span>
</span></code></pre></div>
<p>作用：该函数分配一个物理页，并将la对应的虚拟页，映射到该物理页</p>
<h6 id="check"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check">check</a></h6>
<h6 id="check_pgdir"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_pgdir">check_pgdir</a></h6>
<ol>
<li>将虚拟地址0x0映射到一个物理页(随便分配一个page, p1)上。</li>
<li>将虚拟地址0x1000(PAGESIZE)映射到一个物理页(随便分配一个page, p2)。</li>
<li>将0x1000重新映射到p1.
   ......
   主要是检查了page_insert, page_remove等函数的正确性。</li>
</ol>
<h6 id="check_boot_pgdirtlb-refill处理"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_boot_pgdirtlb-refill处理">check_boot_pgdir（tlb refill处理)</a></h6>
<ol>
<li>分配一个物理页，并写入初始值</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Page</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x100</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">;</span>
</span></code></pre></div>
<ol>
<li>将两个虚拟页映射到该物理页上</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_insert</span><span class="p">(</span><span class="n">boot_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_insert</span><span class="p">(</span><span class="n">boot_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mh">0x100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">assert</span><span class="p">(</span><span class="n">page_ref</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>直接使用虚拟地址访问该物理页，引发tlb refill异常</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">assert</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="mh">0x100</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x1234</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>进入对应异常处理程序</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handle_tlbmiss</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="o">*</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">)</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">in_kernel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">trap_in_kernel</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">current_pgdir</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">badaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">;</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">current_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="o">==</span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ptep_invalid</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span><span class="w">   </span><span class="c1">//PTE miss, pgfault</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;## pagefault in kernel, badaddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">);</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a><span class="w">    </span><span class="c1">//tlb will not be refill in do_pgfault,</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="w">    </span><span class="c1">//so a vmm pgfault will trigger 2 exception</span>
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="w">    </span><span class="c1">//permission check in tlb miss</span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgfault_handler</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">get_error_code</span><span class="p">(</span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">));</span>
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a><span class="w">  </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w"> </span><span class="c1">//tlb miss only, reload it</span>
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a><span class="w">    </span><span class="cm">/* refill two slot */</span>
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a><span class="w">    </span><span class="cm">/* check permission */</span>
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">in_kernel</span><span class="p">){</span>
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;## tlb refill in kernel, badaddr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="p">);</span>
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a><span class="w">      </span><span class="n">tlb_refill</span><span class="p">(</span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a><span class="w">      </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptep_u_read</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a><span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">ptep_u_write</span><span class="p">(</span><span class="n">pte</span><span class="p">)){</span>
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a><span class="w">    </span><span class="c1">//kprintf(&quot;## refill U %d %08x\n&quot;, write, badaddr);</span>
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a><span class="w">      </span><span class="n">tlb_refill</span><span class="p">(</span><span class="n">badaddr</span><span class="p">,</span><span class="w"> </span><span class="n">pte</span><span class="p">);</span>
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a><span class="nl">exit</span><span class="p">:</span>
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">){</span>
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a><span class="w">    </span><span class="n">print_trapframe</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">in_kernel</span><span class="p">){</span>
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled pgfault&quot;</span><span class="p">);</span>
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a><span class="w">      </span><span class="n">do_exit</span><span class="p">(</span><span class="o">-</span><span class="n">E_KILLED</span><span class="p">);</span>
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-28-44"><a id="__codelineno-28-44" name="__codelineno-28-44" href="#__codelineno-28-44"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-28-45"><a id="__codelineno-28-45" name="__codelineno-28-45" href="#__codelineno-28-45"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-28-46"><a id="__codelineno-28-46" name="__codelineno-28-46" href="#__codelineno-28-46"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>
<p>首先判断是否在内核中发生了异常，这里通过Status.KSU位来判断，2'b00表示kernel mode，2'b10表示user mode。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="kt">bool</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="nf">trap_in_kernel</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_status</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">KSU_USER</span><span class="p">);</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>然后获得pte</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">current_pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_vaddr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>之后进入tlb_refill函数, tlb_refill执行tlbwr，从pte读取映射的物理页号写入到tlb项中。（一次映射两页）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">tlb_replace_random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">badaddr</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">THUMIPS_TLB_ENTRYH_VPN2_MASK</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">      </span><span class="n">pte2tlblow</span><span class="p">(</span><span class="o">*</span><span class="n">pte</span><span class="p">),</span><span class="w"> </span><span class="n">pte2tlblow</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pte</span><span class="o">+</span><span class="mi">1</span><span class="p">)));</span>
</span></code></pre></div>
</li>
</ol>
<p>终端输出</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>## tlb refill in kernel, badaddr: 0x100
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>check_boot_pgdir() succeeded!
</span></code></pre></div>
<h6 id="kmalloc"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kmalloc">kmalloc</a></h6>
<p>pmm_init中还调用了kmalloc_init。</p>
<p>kmalloc中主要实现了以下关键函数</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">objp</span><span class="p">);</span>
</span></code></pre></div>
<p>可以看到kmalloc函数的参数为字节数，返回值为分配的物理内存的虚拟起始地址。</p>
<p>kmalloc利用到了slab机制</p>
<blockquote>
<p>slab是Linux操作系统的一种内存分配机制。其工作是针对一些经常分配并释放的对象，如进程描述符等，这些对象的大小一般比较小，如果直接采用伙伴系统来进行分配和释放，不仅会造成大量的内存碎片，而且处理速度也太慢。而slab分配器是基于对象进行管理的，相同类型的对象归为一类(如进程描述符就是一类)，每当要申请这样一个对象，slab分配器就从一个slab列表中分配一个这样大小的单元出去，而当要释放时，将其重新保存在该列表中，而不是直接返回给伙伴系统，从而避免这些内碎片。</p>
</blockquote>
<h5 id="vmm_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#vmm_init">vmm_init</a></h5>
<p>通过内存地址虚拟化，可以使得软件在没有访问某虚拟内存地址时不分配具体的物理理内存，而只有在实际访问某虚拟内存地址时，操作系统再动态地分配物理内存，建立虚拟内存到物理理内存的页映射关系，这种技术称为按需分页（demand paging）。把不不经常访问的数据所占的内存空间临时写到硬盘上，这样可以腾出更更多的空闲内存空间
给经常访问的数据；当CPU访问到不不经常访问的数据时，再把这些数据从硬盘读入到内存中。这种技术称为页换入换出(page in/out)</p>
<h6 id="vma_struct"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#vma_struct">vma_struct</a></h6>
<p>vma用于描述进程对虚拟内存的需求</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vm_mm</span><span class="p">;</span><span class="w"> </span><span class="c1">// the set of vma using the same PDT </span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">;</span><span class="w">      </span><span class="c1">// start addr of vma   </span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">;</span><span class="w">        </span><span class="c1">// end addr of vma</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">;</span><span class="w">       </span><span class="c1">// flags of vma</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">  </span><span class="c1">// linear list link which sorted by start addr of vma</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="p">};</span>
</span></code></pre></div>
<p>vma指示了一段连续的虚拟内存空间，不同vma通过list_link相连，共同表示一个进程的虚拟内存空间。</p>
<h6 id="mm_struct"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#mm_struct">mm_struct</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">mmap_list</span><span class="p">;</span><span class="w">        </span><span class="c1">// linear list link which sorted by start addr of vma</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mmap_cache</span><span class="p">;</span><span class="w"> </span><span class="c1">// current accessed vma, used for speed purpose</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="w">    </span><span class="n">pde_t</span><span class="w"> </span><span class="o">*</span><span class="n">pgdir</span><span class="p">;</span><span class="w">                  </span><span class="c1">// the PDT of these vma</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">map_count</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the count of these vma</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sm_priv</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the private data for swap manager</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="n">atomic_t</span><span class="w"> </span><span class="n">mm_count</span><span class="p">;</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="w">    </span><span class="n">semaphore_t</span><span class="w"> </span><span class="n">mm_sem</span><span class="p">;</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">locked_by</span><span class="p">;</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="p">};</span>
</span></code></pre></div>
<p>mm_struct用于管理一系列使用同一个页目录表的vma的集合。</p>
<p>进程控制块中包含一个mm_struct的指针，用于管理该进程的虚拟内存空间</p>
<h6 id="关键函数"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#关键函数">关键函数</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">find_vma</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma_create</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_start</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">vm_end</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">);</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">insert_vma_struct</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
<h6 id="check_pgfaultpagefault的处理"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#check_pgfaultpagefault的处理">check_pgfault（pagefault的处理）</a></h6>
<ol>
<li>
<p>创建mm_struct</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">check_mm_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">();</span>
</span></code></pre></div>
<p>这里的<code>check_mm_struct</code>为全局变量</p>
</li>
<li>
<p>分配[0, PTSIZE]的虚拟内存</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma_create</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PTSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">);</span><span class="w"> </span><span class="c1">//如果该成VM_READ，之后在do_pgfault便会通不过权限检查。</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="n">insert_vma_struct</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>访问0x100</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="w">  </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100</span><span class="p">;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">vma</span><span class="p">);</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">    </span><span class="c1">//page fault</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span><span class="n">sum</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">sum</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>触发tlb refill异常。（实际为pagefault，此时页表中没有该映射，因此tlb中也没有该项 ）</p>
<p>参考之前tlb refill异常处理的代码，进入pgfault_handler</p>
<ol>
<li>首先通过判断check_mm_struct非空，知道是在执行check_pgfault函数，将mm设置为check_mm_struct</li>
<li>在do_pgfault中首先调用find_vma函数，确定该虚拟地址是有效的</li>
<li>然后检查该地址访问权限是否正确（如果将</li>
<li>都通过了后，调用pgdir_alloc_page，直接分配一个物理页，并在mm-&gt;pgdir中插入映射关系。</li>
<li>异常处理完成并返回</li>
</ol>
</li>
<li>
<p>再次触发tlb refill异常。（现在页表中存在了该映射，因此进入tlb_refill函数）</p>
</li>
</ol>
<p>终端输出</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>## pagefault in kernel, badaddr: 0x100
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a>## tlb refill in kernel, badaddr: 0x100
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a>check_pgfault() succeeded!
</span></code></pre></div>
<p>代码</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">get_error_code</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">,</span><span class="w"> </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">pte</span><span class="p">)</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="p">{</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">pte</span><span class="o">!=</span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ptep_present</span><span class="p">(</span><span class="n">pte</span><span class="p">))</span><span class="w">    </span><span class="c1">//因为pagefault的条件(pte==NULL || ptep_invalid(pte))，这里根本不可能为真</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x01</span><span class="p">;</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="n">write</span><span class="p">)</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">    </span><span class="n">r</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="mh">0x02</span><span class="p">;</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">r</span><span class="p">;</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="nf">pgfault_handler</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">error_code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">  </span><span class="k">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">check_mm_struct</span><span class="p">;</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_mm_struct</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">    </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_mm_struct</span><span class="p">;</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">      </span><span class="n">print_trapframe</span><span class="p">(</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">      </span><span class="c1">//print_pgfault(tf);</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;unhandled page fault.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="w">    </span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">do_pgfault</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="p">}</span>
</span></code></pre></div>
<div class="language-c highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="cp">#! vmm.c</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="c1">//page fault number</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">pgfault_num</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="c1">// do_pgfault - interrupt handler to process the page fault execption</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="kt">int</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="nf">do_pgfault</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">error_code</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_INVAL</span><span class="p">;</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">vma_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_vma</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">  </span><span class="c1">//kprintf(&quot;## %08x %08x\n&quot;, error_code, addr);</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">  </span><span class="n">pgfault_num</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vma</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;not valid addr %x, and  can not find it in vma</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">error_code</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19" href="#__codelineno-43-19"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20" href="#__codelineno-43-20"></a><span class="w">      </span><span class="cm">/* default is 3: write, present */</span>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21" href="#__codelineno-43-21"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="cm">/* write, not present */</span>
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22" href="#__codelineno-43-22"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23" href="#__codelineno-43-23"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;write, not present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24" href="#__codelineno-43-24"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25" href="#__codelineno-43-25"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26" href="#__codelineno-43-26"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27" href="#__codelineno-43-27"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read, present */</span>
</span><span id="__span-43-28"><a id="__codelineno-43-28" name="__codelineno-43-28" href="#__codelineno-43-28"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;read, present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-43-29"><a id="__codelineno-43-29" name="__codelineno-43-29" href="#__codelineno-43-29"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-30"><a id="__codelineno-43-30" name="__codelineno-43-30" href="#__codelineno-43-30"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="cm">/* read, not present */</span>
</span><span id="__span-43-31"><a id="__codelineno-43-31" name="__codelineno-43-31" href="#__codelineno-43-31"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">VM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_EXEC</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-32"><a id="__codelineno-43-32" name="__codelineno-43-32" href="#__codelineno-43-32"></a><span class="w">        </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;read, not present in do_pgfault failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-43-33"><a id="__codelineno-43-33" name="__codelineno-43-33" href="#__codelineno-43-33"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-34"><a id="__codelineno-43-34" name="__codelineno-43-34" href="#__codelineno-43-34"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-43-35"><a id="__codelineno-43-35" name="__codelineno-43-35" href="#__codelineno-43-35"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-36"><a id="__codelineno-43-36" name="__codelineno-43-36" href="#__codelineno-43-36"></a>
</span><span id="__span-43-37"><a id="__codelineno-43-37" name="__codelineno-43-37" href="#__codelineno-43-37"></a><span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
</span><span id="__span-43-38"><a id="__codelineno-43-38" name="__codelineno-43-38" href="#__codelineno-43-38"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-39"><a id="__codelineno-43-39" name="__codelineno-43-39" href="#__codelineno-43-39"></a><span class="w">    </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">;</span>
</span><span id="__span-43-40"><a id="__codelineno-43-40" name="__codelineno-43-40" href="#__codelineno-43-40"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-41"><a id="__codelineno-43-41" name="__codelineno-43-41" href="#__codelineno-43-41"></a><span class="w">  </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-43-42"><a id="__codelineno-43-42" name="__codelineno-43-42" href="#__codelineno-43-42"></a>
</span><span id="__span-43-43"><a id="__codelineno-43-43" name="__codelineno-43-43" href="#__codelineno-43-43"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-43-44"><a id="__codelineno-43-44" name="__codelineno-43-44" href="#__codelineno-43-44"></a>
</span><span id="__span-43-45"><a id="__codelineno-43-45" name="__codelineno-43-45" href="#__codelineno-43-45"></a><span class="w">  </span><span class="c1">// try to find a pte, if pte&#39;s PT(Page Table) isn&#39;t existed, then create a PT.</span>
</span><span id="__span-43-46"><a id="__codelineno-43-46" name="__codelineno-43-46" href="#__codelineno-43-46"></a><span class="w">  </span><span class="n">pte_t</span><span class="w"> </span><span class="o">*</span><span class="n">ptep</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-43-47"><a id="__codelineno-43-47" name="__codelineno-43-47" href="#__codelineno-43-47"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ptep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pte</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-48"><a id="__codelineno-43-48" name="__codelineno-43-48" href="#__codelineno-43-48"></a><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-49"><a id="__codelineno-43-49" name="__codelineno-43-49" href="#__codelineno-43-49"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-50"><a id="__codelineno-43-50" name="__codelineno-43-50" href="#__codelineno-43-50"></a>
</span><span id="__span-43-51"><a id="__codelineno-43-51" name="__codelineno-43-51" href="#__codelineno-43-51"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ptep</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// if the phy addr isn&#39;t exist, then alloc a page &amp; map the phy addr with logical addr</span>
</span><span id="__span-43-52"><a id="__codelineno-43-52" name="__codelineno-43-52" href="#__codelineno-43-52"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-53"><a id="__codelineno-43-53" name="__codelineno-43-53" href="#__codelineno-43-53"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-54"><a id="__codelineno-43-54" name="__codelineno-43-54" href="#__codelineno-43-54"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-43-55"><a id="__codelineno-43-55" name="__codelineno-43-55" href="#__codelineno-43-55"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-56"><a id="__codelineno-43-56" name="__codelineno-43-56" href="#__codelineno-43-56"></a><span class="w">  </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// if this pte is a swap entry, then load data from disk to a page with phy addr, </span>
</span><span id="__span-43-57"><a id="__codelineno-43-57" name="__codelineno-43-57" href="#__codelineno-43-57"></a><span class="w">    </span><span class="c1">// map the phy addr with logical addr, trig swap manager to record the access situation of this page</span>
</span><span id="__span-43-58"><a id="__codelineno-43-58" name="__codelineno-43-58" href="#__codelineno-43-58"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">swap_init_ok</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-59"><a id="__codelineno-43-59" name="__codelineno-43-59" href="#__codelineno-43-59"></a><span class="w">      </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;No swap!! never reach!!&quot;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-43-60"><a id="__codelineno-43-60" name="__codelineno-43-60" href="#__codelineno-43-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-43-61"><a id="__codelineno-43-61" name="__codelineno-43-61" href="#__codelineno-43-61"></a><span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-62"><a id="__codelineno-43-62" name="__codelineno-43-62" href="#__codelineno-43-62"></a><span class="w">      </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;no swap_init_ok but ptep is %x, failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">ptep</span><span class="p">);</span>
</span><span id="__span-43-63"><a id="__codelineno-43-63" name="__codelineno-43-63" href="#__codelineno-43-63"></a><span class="w">      </span><span class="k">goto</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span>
</span><span id="__span-43-64"><a id="__codelineno-43-64" name="__codelineno-43-64" href="#__codelineno-43-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-43-65"><a id="__codelineno-43-65" name="__codelineno-43-65" href="#__codelineno-43-65"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-43-66"><a id="__codelineno-43-66" name="__codelineno-43-66" href="#__codelineno-43-66"></a><span class="w">  </span><span class="cm">/* refill TLB for mips, no second exception */</span>
</span><span id="__span-43-67"><a id="__codelineno-43-67" name="__codelineno-43-67" href="#__codelineno-43-67"></a><span class="w">  </span><span class="c1">//tlb_refill(addr, ptep);</span>
</span><span id="__span-43-68"><a id="__codelineno-43-68" name="__codelineno-43-68" href="#__codelineno-43-68"></a><span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-43-69"><a id="__codelineno-43-69" name="__codelineno-43-69" href="#__codelineno-43-69"></a><span class="nl">failed</span><span class="p">:</span>
</span><span id="__span-43-70"><a id="__codelineno-43-70" name="__codelineno-43-70" href="#__codelineno-43-70"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-43-71"><a id="__codelineno-43-71" name="__codelineno-43-71" href="#__codelineno-43-71"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="函数调用"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#函数调用">函数调用</a></h5>
<ol>
<li>
<p>使用jal调用函数，使用jr ra返回。使用a0-a3传递参数，使用v0-v1传递返回值。对于更多的参数，使用栈传递。</p>
</li>
<li>
<p>为了防止寄存器的值被覆盖。需要在存储寄存器的值，可以由caller或者callee来完成。但是只有一方完成时，因为caller不知道callee会用哪些寄存器，或者callee不知道caller需要用哪些寄存器。因此就会导致存储不必要的寄存器。MIPS采用了一种折衷的策略，将寄存器分为caller-save（如t0-t7, a0-a3, v0-v1）和callee-save（如s0-s7, ra）</p>
</li>
<li>
<p>fp寄存器（也是s8）用于指向栈帧的第一个元素。因为x86中提供了push和pop指令，sp的位置是变化的，要引用不同变量的值是用fp更方便。而MIPS中则是在函数的开头手动将sp设置，sp之后的值不会变化，因此fp貌似作用不大。</p>
</li>
<li>
<p>gp寄存器，用于程序访问全局变量（比如函数的地址）。</p>
</li>
</ol>
<blockquote>
<p>ps. 使用mipsel-linux-gnu-gcc -S编译一个简单的函数调用测试代码。不知为什么和上面讲的caller-save，callee-save对不上。比如函数开头<code>addiu $sp,$sp,-40</code>，但结果却根本没用上这么大的空间。然后，为什么还会出现<code>sw $a0,40($fp)</code>，即将参数<code>a0</code>写入父函数栈帧的情况。（这个然后fp和sp始终相等，不知道为什么要去存储fp</p>
</blockquote>
<h5 id="sched_init--proc_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#sched_init--proc_init">sched_init &amp; proc_init</a></h5>
<h6 id="proc_struct进程控制块"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#proc_struct进程控制块">proc_struct(进程控制块)</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">proc_state</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">                      </span><span class="c1">// Process state</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span><span class="w">                                    </span><span class="c1">// Process ID</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">runs</span><span class="p">;</span><span class="w">                                   </span><span class="c1">// the running times of Proces</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">kstack</span><span class="p">;</span><span class="w">                           </span><span class="c1">// Process kernel stack</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="k">volatile</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">need_resched</span><span class="p">;</span><span class="w">                 </span><span class="c1">// bool value: need to be rescheduled to release CPU?</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span><span class="w">                 </span><span class="c1">// the parent process</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Process&#39;s memory management field</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Switch here to run process</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span><span class="w">                       </span><span class="c1">// Trap frame for current interrupt</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">cr3</span><span class="p">;</span><span class="w">                              </span><span class="c1">// CR3 register: the base addr of Page Directroy Table(PDT)</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">flags</span><span class="p">;</span><span class="w">                             </span><span class="c1">// Process flag</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">PROC_NAME_LEN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span><span class="w">               </span><span class="c1">// Process name</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">list_link</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Process link list </span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">hash_link</span><span class="p">;</span><span class="w">                     </span><span class="c1">// Process hash list</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">exit_code</span><span class="p">;</span><span class="w">                              </span><span class="c1">// exit code (be sent to parent proc)</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">wait_state</span><span class="p">;</span><span class="w">                        </span><span class="c1">// waiting state</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">yptr</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">optr</span><span class="p">;</span><span class="w">     </span><span class="c1">// relations between processes</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">run_queue</span><span class="w"> </span><span class="o">*</span><span class="n">rq</span><span class="p">;</span><span class="w">                       </span><span class="c1">// running queue contains Process</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="w">    </span><span class="n">list_entry_t</span><span class="w"> </span><span class="n">run_link</span><span class="p">;</span><span class="w">                      </span><span class="c1">// the entry linked in run queue</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">time_slice</span><span class="p">;</span><span class="w">                             </span><span class="c1">// time slice for occupying the CPU</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">fs_struct</span><span class="w"> </span><span class="o">*</span><span class="n">fs_struct</span><span class="p">;</span><span class="w">                </span><span class="c1">// the file related info(pwd, files_count, files_array, fs_semaphore) of process</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="p">};</span>
</span></code></pre></div>
<h6 id="tf"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#tf">tf</a></h6>
<div class="language-c highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_vaddr</span><span class="p">;</span><span class="w">  </span><span class="cm">/* coprocessor 0 vaddr register */</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_status</span><span class="p">;</span><span class="w"> </span><span class="cm">/* coprocessor 0 status register */</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_cause</span><span class="p">;</span><span class="w">  </span><span class="cm">/* coprocessor 0 cause register */</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_lo</span><span class="p">;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_hi</span><span class="p">;</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_ra</span><span class="p">;</span><span class="w"> </span><span class="cm">/* Saved register 31 */</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">pushregs</span><span class="w"> </span><span class="n">tf_regs</span><span class="p">;</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">tf_epc</span><span class="p">;</span><span class="w">    </span><span class="cm">/* coprocessor 0 epc register */</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="p">};</span>
</span></code></pre></div>
<p>tf记录了</p>
<ol>
<li>进程的上下文：32个通用寄存器的值</li>
<li>epc, status, cause等CP0寄存器</li>
</ol>
<p>进入异常后，要将sp切换到内核栈。对于内核进程来说，就是当前的sp，而对于用户进程来说，需要从进程控制块中读取kstack的地址。</p>
<p>uCore内核允许嵌套中断。因此为了了保证嵌套中断发⽣生时tf 总是能够指向当前的trapframe，uCore 在内核栈上维护了了 tf 的链。</p>
<blockquote>
<p>发生中断（异常）时，trap.c::mips_trap会改变当前进程current-&gt;tf的值</p>
<p><code>current-&gt;tf = *tf*;</code></p>
<p>要实现嵌套中断，需要在改变current-&gt;tf前使用一个trapframe *otf（局部变量，存储在内核栈中）存下来。之后再将current-&gt;tf恢复为otf。</p>
<p>这里提一下，如果一个用户进程发生了异常，在异常处理程序中又发生了一次异常，那么第二次异常时，已经处于了内核模式（在压入tf后，调用mips_trap之前）。在ramExcHandle_general中就不会计算新的sp</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>mfc0 k0, CP0_STATUS /* Get status register */
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>andi k0, k0, KSU_USER/* Check the we-were-in-user-mode bit */
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a>beq   k0, $0, 1f      /* If clear, from kernel, already have stack */
</span></code></pre></div>
</blockquote>
<h6 id="kstack"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#kstack">kstack</a></h6>
<p>内核栈用于存储中断帧tf以及作为进程在内核中执行使用的sp</p>
<p>对于内核线程，该栈就是运行时的程序使⽤用的栈。而对于普通进程，uCore在创建进程时分配了了 2 个连续的物理理⻚页作为内核栈的空间。</p>
<p>内核栈位于内核地址空间，并且是不不共享的（每个线程都拥有⾃自⼰己的内核栈），因此不不受到 mm 的管理理，当进程退出的时候，内核能够根据 kstack 的值快速定位栈的位置并进⾏行行回收。</p>
<h6 id="mm"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#mm">mm</a></h6>
<p>内存管理理的信息，包括内存映射列列表、⻚页表指针等。mm成员变量量在lab3中⽤用于虚存管理理。但在实际OS中，内核线程常驻内存，不不需要考虑swap page问题，在lab3中涉及到了了⽤用户进程，才考虑进程⽤用户内存空间的swap page问题，mm才会发挥作⽤用。</p>
<blockquote>
<p>还没看到用户进程的swap page代码</p>
</blockquote>
<h6 id="创建内核线程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#创建内核线程">创建内核线程</a></h6>
<h6 id="idle"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#idle">idle</a></h6>
<p>proc_init函数启动了创建内核线程的步骤。首先当前的执行上下文（从kern_init 启动至今）就可以看成是uCore内核中的一个内线程的上下文。为此，uCore调用alloc_proc函数给当前执行的上下文分配一个进程控制块并在proc_init中对它进行相应初始化，将其打造成第0个内核线程 --idleproc。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="w">   </span><span class="c1">//alloc_proc</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">             </span><span class="c1">//不需要，所有内核进程公用一个页表</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">boot_cr3</span><span class="p">;</span><span class="w">        </span><span class="c1">//在pmm_init中分配为PADDR(boot_pgdir)</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">   </span><span class="c1">//proc_init</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PROC_RUNNABLE</span><span class="p">;</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">bootstack</span><span class="p">;</span><span class="w"> </span><span class="c1">//在entry.S中设置的</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">   </span><span class="n">idleproc</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">  </span><span class="c1">//表明在kern_init后会切换</span>
</span></code></pre></div>
<h6 id="initkernel_thread--do_fork"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#initkernel_thread--do_fork">init(kernel_thread &amp; do_fork)</a></h6>
<p>idle内核线程主要工作是完成内核中各个子系统的初始化，idle会调用kernel_thread函数创建内核线程init。</p>
<p>kernel_thread简单来说为新进程分配了PCB空间，和kstack空间。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="w">    </span><span class="c1">//proc_init</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">init_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create init_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="n">initproc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_proc</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="n">set_proc_name</span><span class="p">(</span><span class="n">initproc</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;init&quot;</span><span class="p">);</span>
</span></code></pre></div>
<p>过程：</p>
<ol>
<li>kernel_thread创建内核线程的中断帧，重点在于将epc设置为了kernel_thread_entry，以及设置a0和a1为arg和fn。<strong>还有一点值得注意，status的KSU为内核模式</strong>。</li>
</ol>
<p>当从eret返回后（forkrets -&gt; exception_return），CPU便会进入kernel_thread_entry，并以tf中指定的寄存器值执行。</p>
<p>kernel_thread函数采用了局部变量tf来放置中断帧，并把中断帧的指针传递给do_fork函数。</p>
<p>kernel_thread调用do_fork的stack参数为0。在do_fork-&gt;copy_thread以此来判断是创建内核线程</p>
<ol>
<li>
<p>do_fork作用是以当前进程为父进程，创建一个子进程，可以根据clone_flags决定是否共享mm。具体主要做了以下一些事情：</p>
</li>
<li>
<p>调用alloc_proc为子进程分配PCB空间</p>
</li>
<li>
<p>调用setup_kstack(proc)<strong>分配了内核栈空间</strong>（注意这里的kstack为空闲页的起始地址，而非栈顶）</p>
</li>
<li>
<p>调用copy_mm，根据clone_flags来确定是复制还是共享mm。（只对用户进程有效，内核线程mm都为NULL）</p>
</li>
<li>
<p>调用copy_thread：将tf拷贝到kstack的栈顶，<strong>设置tf中的sp为proc-&gt;tf - 32</strong>（这里的减32应该和之前提到的MIPS函数调用规则有关，不管怎样，sp是位于kstack中的）</p>
<p><strong>将context中的ra设置为forkret</strong></p>
</li>
<li>
<p>将子进程插入hash_list和proc_list</p>
</li>
<li>
<p>调用wakeup_proc将进程加入调度队列</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="kt">int</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="nf">kernel_thread</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="p">));</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">fn</span><span class="p">;</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_V0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a><span class="w">    </span><span class="c1">//TODO</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_c0_status</span><span class="p">();</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ST0_KSU</span><span class="p">;</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_IE</span><span class="p">;</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_EXL</span><span class="p">;</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_GP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__read_reg</span><span class="p">(</span><span class="n">$28</span><span class="p">);</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">    </span><span class="n">tf</span><span class="p">.</span><span class="n">tf_epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">kernel_thread_entry</span><span class="p">;</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">do_fork</span><span class="p">(</span><span class="n">clone_flags</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CLONE_VM</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="p">}</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17" href="#__codelineno-49-17"></a>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18" href="#__codelineno-49-18"></a><span class="c1">//kern/proc/entry.S</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19" href="#__codelineno-49-19"></a><span class="nl">kernel_thread_entry</span><span class="p">:</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20" href="#__codelineno-49-20"></a><span class="w">  </span><span class="n">addiu</span><span class="w"> </span><span class="n">$sp</span><span class="p">,</span><span class="w"> </span><span class="n">$sp</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21" href="#__codelineno-49-21"></a><span class="w">  </span><span class="n">jal</span><span class="w"> </span><span class="n">$a1</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22" href="#__codelineno-49-22"></a><span class="w">  </span><span class="n">nop</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23" href="#__codelineno-49-23"></a><span class="w">  </span><span class="n">move</span><span class="w"> </span><span class="n">$a0</span><span class="p">,</span><span class="w"> </span><span class="n">$v0</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24" href="#__codelineno-49-24"></a><span class="w">  </span><span class="n">la</span><span class="w">  </span><span class="n">$t0</span><span class="p">,</span><span class="w"> </span><span class="n">do_exit</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25" href="#__codelineno-49-25"></a><span class="w">  </span><span class="n">jal</span><span class="w"> </span><span class="n">$t0</span><span class="w"> </span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26" href="#__codelineno-49-26"></a><span class="w">  </span><span class="n">nop</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27" href="#__codelineno-49-27"></a><span class="w">  </span><span class="cm">/* never here */</span>
</span><span id="__span-49-28"><a id="__codelineno-49-28" name="__codelineno-49-28" href="#__codelineno-49-28"></a>
</span><span id="__span-49-29"><a id="__codelineno-49-29" name="__codelineno-49-29" href="#__codelineno-49-29"></a><span class="c1">//called by do_fork</span>
</span><span id="__span-49-30"><a id="__codelineno-49-30" name="__codelineno-49-30" href="#__codelineno-49-30"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-49-31"><a id="__codelineno-49-31" name="__codelineno-49-31" href="#__codelineno-49-31"></a><span class="n">copy_thread</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">esp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-32"><a id="__codelineno-49-32" name="__codelineno-49-32" href="#__codelineno-49-32"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">KSTACKSIZE</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-49-33"><a id="__codelineno-49-33" name="__codelineno-49-33" href="#__codelineno-49-33"></a><span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-49-34"><a id="__codelineno-49-34" name="__codelineno-49-34" href="#__codelineno-49-34"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_V0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-49-35"><a id="__codelineno-49-35" name="__codelineno-49-35" href="#__codelineno-49-35"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">esp</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="c1">//a kernel thread</span>
</span><span id="__span-49-36"><a id="__codelineno-49-36" name="__codelineno-49-36" href="#__codelineno-49-36"></a><span class="w">      </span><span class="n">esp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-49-37"><a id="__codelineno-49-37" name="__codelineno-49-37" href="#__codelineno-49-37"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_SP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">esp</span><span class="p">;</span>
</span><span id="__span-49-38"><a id="__codelineno-49-38" name="__codelineno-49-38" href="#__codelineno-49-38"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sf_ra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">forkret</span><span class="p">;</span>
</span><span id="__span-49-39"><a id="__codelineno-49-39" name="__codelineno-49-39" href="#__codelineno-49-39"></a><span class="w">    </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">.</span><span class="n">sf_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-49-40"><a id="__codelineno-49-40" name="__codelineno-49-40" href="#__codelineno-49-40"></a><span class="p">}</span>
</span><span id="__span-49-41"><a id="__codelineno-49-41" name="__codelineno-49-41" href="#__codelineno-49-41"></a>
</span><span id="__span-49-42"><a id="__codelineno-49-42" name="__codelineno-49-42" href="#__codelineno-49-42"></a><span class="c1">// do_fork - parent process for a new child process</span>
</span><span id="__span-49-43"><a id="__codelineno-49-43" name="__codelineno-49-43" href="#__codelineno-49-43"></a><span class="c1">//    1. call alloc_proc to allocate a proc_struct</span>
</span><span id="__span-49-44"><a id="__codelineno-49-44" name="__codelineno-49-44" href="#__codelineno-49-44"></a><span class="c1">//    2. call setup_kstack to allocate a kernel stack for child process</span>
</span><span id="__span-49-45"><a id="__codelineno-49-45" name="__codelineno-49-45" href="#__codelineno-49-45"></a><span class="c1">//    3. call copy_mm to dup OR share mm according clone_flag</span>
</span><span id="__span-49-46"><a id="__codelineno-49-46" name="__codelineno-49-46" href="#__codelineno-49-46"></a><span class="c1">//    4. call copy_thread to setup tf &amp; context in proc_struct</span>
</span><span id="__span-49-47"><a id="__codelineno-49-47" name="__codelineno-49-47" href="#__codelineno-49-47"></a><span class="c1">//    5. insert proc_struct into hash_list &amp;&amp; proc_list</span>
</span><span id="__span-49-48"><a id="__codelineno-49-48" name="__codelineno-49-48" href="#__codelineno-49-48"></a><span class="c1">//    6. call wakup_proc to make the new child process RUNNABLE </span>
</span><span id="__span-49-49"><a id="__codelineno-49-49" name="__codelineno-49-49" href="#__codelineno-49-49"></a><span class="c1">//    7. set the </span>
</span><span id="__span-49-50"><a id="__codelineno-49-50" name="__codelineno-49-50" href="#__codelineno-49-50"></a><span class="kt">int</span>
</span><span id="__span-49-51"><a id="__codelineno-49-51" name="__codelineno-49-51" href="#__codelineno-49-51"></a><span class="n">do_fork</span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-52"><a id="__codelineno-49-52" name="__codelineno-49-52" href="#__codelineno-49-52"></a><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_FREE_PROC</span><span class="p">;</span>
</span><span id="__span-49-53"><a id="__codelineno-49-53" name="__codelineno-49-53" href="#__codelineno-49-53"></a><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-49-54"><a id="__codelineno-49-54" name="__codelineno-49-54" href="#__codelineno-49-54"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nr_process</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MAX_PROCESS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-55"><a id="__codelineno-49-55" name="__codelineno-49-55" href="#__codelineno-49-55"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-49-56"><a id="__codelineno-49-56" name="__codelineno-49-56" href="#__codelineno-49-56"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-49-57"><a id="__codelineno-49-57" name="__codelineno-49-57" href="#__codelineno-49-57"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-49-58"><a id="__codelineno-49-58" name="__codelineno-49-58" href="#__codelineno-49-58"></a><span class="w"> </span><span class="c1">//LAB4:EXERCISE2 2009010989</span>
</span><span id="__span-49-59"><a id="__codelineno-49-59" name="__codelineno-49-59" href="#__codelineno-49-59"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_proc</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-60"><a id="__codelineno-49-60" name="__codelineno-49-60" href="#__codelineno-49-60"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-49-61"><a id="__codelineno-49-61" name="__codelineno-49-61" href="#__codelineno-49-61"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-49-62"><a id="__codelineno-49-62" name="__codelineno-49-62" href="#__codelineno-49-62"></a>
</span><span id="__span-49-63"><a id="__codelineno-49-63" name="__codelineno-49-63" href="#__codelineno-49-63"></a><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
</span><span id="__span-49-64"><a id="__codelineno-49-64" name="__codelineno-49-64" href="#__codelineno-49-64"></a>
</span><span id="__span-49-65"><a id="__codelineno-49-65" name="__codelineno-49-65" href="#__codelineno-49-65"></a><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">setup_kstack</span><span class="p">(</span><span class="n">proc</span><span class="p">)){</span>
</span><span id="__span-49-66"><a id="__codelineno-49-66" name="__codelineno-49-66" href="#__codelineno-49-66"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_proc</span><span class="p">;</span>
</span><span id="__span-49-67"><a id="__codelineno-49-67" name="__codelineno-49-67" href="#__codelineno-49-67"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-49-68"><a id="__codelineno-49-68" name="__codelineno-49-68" href="#__codelineno-49-68"></a><span class="w"> </span><span class="c1">//LAB8:EXERCISE2 2009010989 HINT:how to copy the fs in parent&#39;s proc_struct?</span>
</span><span id="__span-49-69"><a id="__codelineno-49-69" name="__codelineno-49-69" href="#__codelineno-49-69"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_fs</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-70"><a id="__codelineno-49-70" name="__codelineno-49-70" href="#__codelineno-49-70"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_kstack</span><span class="p">;</span>
</span><span id="__span-49-71"><a id="__codelineno-49-71" name="__codelineno-49-71" href="#__codelineno-49-71"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-49-72"><a id="__codelineno-49-72" name="__codelineno-49-72" href="#__codelineno-49-72"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copy_mm</span><span class="p">(</span><span class="n">clone_flags</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="p">)){</span>
</span><span id="__span-49-73"><a id="__codelineno-49-73" name="__codelineno-49-73" href="#__codelineno-49-73"></a><span class="w">     </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_fork_cleanup_fs</span><span class="p">;</span>
</span><span id="__span-49-74"><a id="__codelineno-49-74" name="__codelineno-49-74" href="#__codelineno-49-74"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-49-75"><a id="__codelineno-49-75" name="__codelineno-49-75" href="#__codelineno-49-75"></a>
</span><span id="__span-49-76"><a id="__codelineno-49-76" name="__codelineno-49-76" href="#__codelineno-49-76"></a><span class="w"> </span><span class="n">copy_thread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">stack</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-49-77"><a id="__codelineno-49-77" name="__codelineno-49-77" href="#__codelineno-49-77"></a>
</span><span id="__span-49-78"><a id="__codelineno-49-78" name="__codelineno-49-78" href="#__codelineno-49-78"></a><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_pid</span><span class="p">();</span>
</span><span id="__span-49-79"><a id="__codelineno-49-79" name="__codelineno-49-79" href="#__codelineno-49-79"></a><span class="w"> </span><span class="n">hash_proc</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-49-80"><a id="__codelineno-49-80" name="__codelineno-49-80" href="#__codelineno-49-80"></a>
</span><span id="__span-49-81"><a id="__codelineno-49-81" name="__codelineno-49-81" href="#__codelineno-49-81"></a>
</span><span id="__span-49-82"><a id="__codelineno-49-82" name="__codelineno-49-82" href="#__codelineno-49-82"></a><span class="w"> </span><span class="c1">//list_add(&amp;proc_list, &amp;(proc-&gt;list_link));</span>
</span><span id="__span-49-83"><a id="__codelineno-49-83" name="__codelineno-49-83" href="#__codelineno-49-83"></a><span class="w"> </span><span class="n">set_links</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-49-84"><a id="__codelineno-49-84" name="__codelineno-49-84" href="#__codelineno-49-84"></a>
</span><span id="__span-49-85"><a id="__codelineno-49-85" name="__codelineno-49-85" href="#__codelineno-49-85"></a><span class="w"> </span><span class="n">wakeup_proc</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-49-86"><a id="__codelineno-49-86" name="__codelineno-49-86" href="#__codelineno-49-86"></a>
</span><span id="__span-49-87"><a id="__codelineno-49-87" name="__codelineno-49-87" href="#__codelineno-49-87"></a><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>
</span><span id="__span-49-88"><a id="__codelineno-49-88" name="__codelineno-49-88" href="#__codelineno-49-88"></a>
</span><span id="__span-49-89"><a id="__codelineno-49-89" name="__codelineno-49-89" href="#__codelineno-49-89"></a><span class="nl">fork_out</span><span class="p">:</span>
</span><span id="__span-49-90"><a id="__codelineno-49-90" name="__codelineno-49-90" href="#__codelineno-49-90"></a><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-49-91"><a id="__codelineno-49-91" name="__codelineno-49-91" href="#__codelineno-49-91"></a>
</span><span id="__span-49-92"><a id="__codelineno-49-92" name="__codelineno-49-92" href="#__codelineno-49-92"></a><span class="nl">bad_fork_cleanup_fs</span><span class="p">:</span>
</span><span id="__span-49-93"><a id="__codelineno-49-93" name="__codelineno-49-93" href="#__codelineno-49-93"></a><span class="w"> </span><span class="n">put_fs</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-49-94"><a id="__codelineno-49-94" name="__codelineno-49-94" href="#__codelineno-49-94"></a><span class="nl">bad_fork_cleanup_kstack</span><span class="p">:</span>
</span><span id="__span-49-95"><a id="__codelineno-49-95" name="__codelineno-49-95" href="#__codelineno-49-95"></a><span class="w"> </span><span class="n">put_kstack</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-49-96"><a id="__codelineno-49-96" name="__codelineno-49-96" href="#__codelineno-49-96"></a><span class="nl">bad_fork_cleanup_proc</span><span class="p">:</span>
</span><span id="__span-49-97"><a id="__codelineno-49-97" name="__codelineno-49-97" href="#__codelineno-49-97"></a><span class="w"> </span><span class="n">kfree</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-49-98"><a id="__codelineno-49-98" name="__codelineno-49-98" href="#__codelineno-49-98"></a><span class="w"> </span><span class="k">goto</span><span class="w"> </span><span class="n">fork_out</span><span class="p">;</span>
</span><span id="__span-49-99"><a id="__codelineno-49-99" name="__codelineno-49-99" href="#__codelineno-49-99"></a><span class="p">}</span>
</span></code></pre></div>
<h6 id="user_main"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#user_main">user_main</a></h6>
<p>在init_main中，创建了user_main线程。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="c1">// init_main - the second kernel thread used to create user_main kernel threads</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="nf">init_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">user_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create user_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">do_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">        </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12" href="#__codelineno-50-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13" href="#__codelineno-50-13"></a>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14" href="#__codelineno-50-14"></a><span class="w">    </span><span class="n">fs_cleanup</span><span class="p">();</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15" href="#__codelineno-50-15"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;all user-mode processes have quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16" href="#__codelineno-50-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17" href="#__codelineno-50-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>kernel_thread之前已经分析过了，我们来看user_main做了什么</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="c1">// user_main - kernel thread used to exec a user program</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="nf">user_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;in user main, pid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">    </span><span class="n">KERNEL_EXECVE</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">    </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;user_main execve failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="p">}</span>
</span></code></pre></div>
<p>user_main调用了<code>KERNEL_EXECVE</code>来加载执行一个用户程序。<code>KERNEL_EXECVE</code>被展开为对kernel_execve的调用。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="c1">// kernel_execve - do SYS_exec syscall to exec a user program called by user_main kernel_thread</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="nf">kernel_execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">        </span><span class="n">argc</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="c1">//panic(&quot;unimpl&quot;);</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="w">    </span><span class="k">asm</span><span class="w"> </span><span class="k">volatile</span><span class="p">(</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10" href="#__codelineno-52-10"></a><span class="w">      </span><span class="s">&quot;la $v0, %1;</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="cm">/* syscall no. */</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11" href="#__codelineno-52-11"></a><span class="w">      </span><span class="s">&quot;move $a0, %2;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12" href="#__codelineno-52-12"></a><span class="w">      </span><span class="s">&quot;move $a1, %3;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13" href="#__codelineno-52-13"></a><span class="w">      </span><span class="s">&quot;move $a2, %4;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14" href="#__codelineno-52-14"></a><span class="w">      </span><span class="s">&quot;move $a3, %5;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15" href="#__codelineno-52-15"></a><span class="w">      </span><span class="s">&quot;syscall;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16" href="#__codelineno-52-16"></a><span class="w">      </span><span class="s">&quot;nop;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17" href="#__codelineno-52-17"></a><span class="w">      </span><span class="s">&quot;move %0, $v0;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18" href="#__codelineno-52-18"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;=r&quot;</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19" href="#__codelineno-52-19"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;i&quot;</span><span class="p">(</span><span class="n">SYSCALL_BASE</span><span class="o">+</span><span class="n">SYS_exec</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argv</span><span class="p">),</span><span class="w"> </span><span class="s">&quot;r&quot;</span><span class="p">(</span><span class="n">argc</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20" href="#__codelineno-52-20"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;a0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;v0&quot;</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21" href="#__codelineno-52-21"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22" href="#__codelineno-52-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23" href="#__codelineno-52-23"></a><span class="p">}</span>
</span></code></pre></div>
<p>而kernel_execve则是进行了一次系统调用。</p>
<p>kernel_execve -&gt; SYSCALL -&gt; sys_exec -&gt; do_execve</p>
<ol>
<li>
<p>因为kernel_execve就是在内核线程，所以之后进行系统调用，仍然是使用一样的内核栈。</p>
</li>
<li>
<p>do_execve做的事情</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">do_execve</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">argv</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<ol>
<li>
<p>创建局部变量local_name, kargv（位于上下文的内核栈中），将参数name, argv复制过来。</p>
<p>kernel_execve调用时传递了"sh"字符串常量的地址。而该"sh"的地址在gdb调试时显示为0x8002_7ff0，而local_name的地址则为0x81fe_bd20（此时sp为0x81fe_bd00，可以知道local_name位于当前函数的栈帧中，而"sh"位于别处）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="n">copy_string</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">local_name</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">local_name</span><span class="p">))</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="n">copy_kargv</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">kargv</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span>
</span></code></pre></div>
<p>copy_string函数，作用是先检查访问src是否合法（通过mm），然后将src复制到dst中。这里的dst位于内核空间</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="kt">bool</span><span class="w"> </span><span class="n">copy_string</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">dst</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxn</span><span class="p">)</span><span class="w"> </span>
</span></code></pre></div>
<p>copy_string具体代码，if判断有点复杂，且没有注释，没太看懂。</p>
</li>
<li>
<p>读取文件系统，获得文件号，之后传给load_icode使用。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sysfile_open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">)</span>
</span></code></pre></div>
</li>
<li>
<p>清空原本的mm。vma，分配的Page，页表等等都会被清除。(user此时是内核进程，因此没有mm)</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="w">        </span><span class="n">lcr3</span><span class="p">(</span><span class="n">boot_cr3</span><span class="p">);</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mm_count_dec</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">            </span><span class="n">exit_mmap</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">            </span><span class="n">put_pgdir</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="w">            </span><span class="n">mm_destroy</span><span class="p">(</span><span class="n">mm</span><span class="p">);</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>调用load_icode</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="n">load_icode</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">kargv</span><span class="p">)</span>
</span></code></pre></div>
<p>调用完load_icode后，elf文件已经被全部加载进内存，并且根据elf文件program header的内容设置好了vma，页表等内容。还分配了USTACK空间。</p>
</li>
<li>
<p>load_icode做的事情</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="c1">// load_icode -  called by sys_exec--&gt;do_execve</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="c1">// 1. create a new mm for current process</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="c1">// 2. create a new PDT, and mm-&gt;pgdir= kernel virtual addr of PDT</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="c1">// 3. copy TEXT/DATA/BSS parts in binary to memory space of process</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="c1">// 4. call mm_map to setup user stack, and put parameters into user stack</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="c1">// 5. setup trapframe for user environment   </span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="n">load_icode</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">kargv</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>
<p>创建新的mm</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">;</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">mm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_create</span><span class="p">())</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_mm</span><span class="p">;</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setup_pgdir</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_pgdir_cleanup_mm</span><span class="p">;</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7" href="#__codelineno-60-7"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>接下来涉及到对elf文件的解析。首先调用load_icode_read读取elf头(struct elfhdr32)。然后根据elfhdr，获得程序头(struct proghdr)的文件内偏移elf-&gt;e_phoff、程序头的数量elf-&gt;e_phnum。再通过for循环，读取每个程序头ph。程序头显示了每个段的信息。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">phnum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">phnum</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phnum</span><span class="p">;</span><span class="w"> </span><span class="n">phnum</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">phoff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_phoff</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proghdr</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">phnum</span><span class="p">;</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_icode_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proghdr</span><span class="p">),</span><span class="w"> </span><span class="n">phoff</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#__codelineno-61-5"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6" href="#__codelineno-61-6"></a><span class="w">    </span><span class="p">...</span>
</span></code></pre></div>
<p>readelf -l  obj/user/sh的信息</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>Elf 文件类型为 EXEC (可执行文件)
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>Entry point 0x100033d0
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>There are 2 program headers, starting at offset 52
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>程序头：
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>  ABIFLAGS       0x0141d0 0x100041d0 0x100041d0 0x00018 0x00018 R   0x8
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>  LOAD           0x010000 0x10000000 0x10000000 0x05010 0x09010 RWE 0x10000
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a> Section to Segment mapping:
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>  段节...
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>   00     .MIPS.abiflags 
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>   01     .text .MIPS.abiflags .data .bss
</span></code></pre></div>
</li>
<li>
<p>根据每个ph的信息，添加vma。这里用的是ph-&gt;p_memsz。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#__codelineno-63-1"></a><span class="w">  </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#__codelineno-63-2"></a><span class="w">      </span><span class="c1">//ptep_set_u_read(&amp;perm);</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#__codelineno-63-3"></a><span class="w">    </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_U</span><span class="p">;</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4" href="#__codelineno-63-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_X</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_EXEC</span><span class="p">;</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5" href="#__codelineno-63-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_W</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">;</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6" href="#__codelineno-63-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">ELF_PF_R</span><span class="p">)</span><span class="w"> </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_READ</span><span class="p">;</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7" href="#__codelineno-63-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="p">)</span><span class="w"> </span><span class="n">perm</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PTE_W</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8" href="#__codelineno-63-8"></a>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9" href="#__codelineno-63-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_map</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="p">,</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10" href="#__codelineno-63-10"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11" href="#__codelineno-63-11"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>调用pgdir_alloc_page为每个虚拟地址分配物理页，并添加页表映射。调用load_icode_read将elf文件对应段(segment)读取到对应的物理页中。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#__codelineno-64-1"></a><span class="w">    </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_offset</span><span class="p">;</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#__codelineno-64-2"></a><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#__codelineno-64-3"></a><span class="w">    </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ROUNDDOWN_2N</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="n">PGSHIFT</span><span class="p">);</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#__codelineno-64-4"></a>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#__codelineno-64-5"></a><span class="w">    </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_filesz</span><span class="p">;</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#__codelineno-64-6"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#__codelineno-64-7"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#__codelineno-64-8"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#__codelineno-64-9"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#__codelineno-64-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#__codelineno-64-11"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12" href="#__codelineno-64-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13" href="#__codelineno-64-13"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14" href="#__codelineno-64-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15" href="#__codelineno-64-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_icode_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16" href="#__codelineno-64-16"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17" href="#__codelineno-64-17"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18" href="#__codelineno-64-18"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19" href="#__codelineno-64-19"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>设置bss段（猜测）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#__codelineno-65-1"></a><span class="w">  </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_va</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph</span><span class="o">-&gt;</span><span class="n">p_memsz</span><span class="p">;</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#__codelineno-65-2"></a>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#__codelineno-65-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#__codelineno-65-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5" href="#__codelineno-65-5"></a><span class="w">            </span><span class="k">continue</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6" href="#__codelineno-65-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7" href="#__codelineno-65-7"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8" href="#__codelineno-65-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9" href="#__codelineno-65-9"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10" href="#__codelineno-65-10"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11" href="#__codelineno-65-11"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12" href="#__codelineno-65-12"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13" href="#__codelineno-65-13"></a><span class="w">        </span><span class="n">assert</span><span class="p">((</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">la</span><span class="p">));</span>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14" href="#__codelineno-65-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15" href="#__codelineno-65-15"></a>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16" href="#__codelineno-65-16"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17" href="#__codelineno-65-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pgdir_alloc_page</span><span class="p">(</span><span class="n">mm</span><span class="o">-&gt;</span><span class="n">pgdir</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18" href="#__codelineno-65-18"></a><span class="w">            </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">E_NO_MEM</span><span class="p">;</span>
</span><span id="__span-65-19"><a id="__codelineno-65-19" name="__codelineno-65-19" href="#__codelineno-65-19"></a><span class="w">            </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-65-20"><a id="__codelineno-65-20" name="__codelineno-65-20" href="#__codelineno-65-20"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-65-21"><a id="__codelineno-65-21" name="__codelineno-65-21" href="#__codelineno-65-21"></a><span class="w">        </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">la</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-65-22"><a id="__codelineno-65-22" name="__codelineno-65-22" href="#__codelineno-65-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">la</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-23"><a id="__codelineno-65-23" name="__codelineno-65-23" href="#__codelineno-65-23"></a><span class="w">            </span><span class="n">size</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">la</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-65-24"><a id="__codelineno-65-24" name="__codelineno-65-24" href="#__codelineno-65-24"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-65-25"><a id="__codelineno-65-25" name="__codelineno-65-25" href="#__codelineno-65-25"></a><span class="w">        </span><span class="n">memset</span><span class="p">(</span><span class="n">page2kva</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">off</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-65-26"><a id="__codelineno-65-26" name="__codelineno-65-26" href="#__codelineno-65-26"></a><span class="w">        </span><span class="n">start</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>
</span><span id="__span-65-27"><a id="__codelineno-65-27" name="__codelineno-65-27" href="#__codelineno-65-27"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>映射用户栈空间（添加vma，当发生pagefault时，异常处理程序会自动分配物理页）</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#__codelineno-66-1"></a><span class="w">  </span><span class="n">vm_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">VM_STACK</span><span class="p">;</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#__codelineno-66-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mm_map</span><span class="p">(</span><span class="n">mm</span><span class="p">,</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">USTACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">USTACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">vm_flags</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#__codelineno-66-3"></a><span class="w">        </span><span class="k">goto</span><span class="w"> </span><span class="n">bad_cleanup_mmap</span><span class="p">;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4" href="#__codelineno-66-4"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>将函数调用参数压入用户栈中</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#__codelineno-67-1"></a><span class="w">      </span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">stacktop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#__codelineno-67-2"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">uargv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="p">)(</span><span class="n">stacktop</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">argc</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3" href="#__codelineno-67-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4" href="#__codelineno-67-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5" href="#__codelineno-67-5"></a><span class="w">        </span><span class="n">uargv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strcpy</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="n">stacktop</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">),</span><span class="w"> </span><span class="n">kargv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6" href="#__codelineno-67-6"></a><span class="w">    </span><span class="p">}</span>
</span></code></pre></div>
<p>上一个步骤已经将USTACKTOP添加到了vma中。因此在第一次访问用户栈时会触发pagefault（页表中没有映射关系），操作系统会动态分配Page。第二次访问会再触发一次tlb refill，tlb添加映射关系，之后便可以正常访问了。</p>
</li>
<li>
<p>设置tf。</p>
<ol>
<li>
<p>将tf-&gt;tf_epc设置为了elf-&gt;e_entry。因此异常返回时便开始执行elf程序。</p>
</li>
<li>
<p>在tf-&gt;tf_status中设置了KSU_USER，因此从SYSCALL返回后，CPU会转变为用户态。</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#__codelineno-68-1"></a><span class="w">  </span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="w"> </span><span class="o">*</span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">;</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#__codelineno-68-2"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">trapframe</span><span class="p">));</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#__codelineno-68-3"></a>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4" href="#__codelineno-68-4"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_epc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="o">-&gt;</span><span class="n">e_entry</span><span class="p">;</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5" href="#__codelineno-68-5"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_SP</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USTACKTOP</span><span class="p">;</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6" href="#__codelineno-68-6"></a><span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_c0_status</span><span class="p">();</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7" href="#__codelineno-68-7"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">ST0_KSU</span><span class="p">;</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8" href="#__codelineno-68-8"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">KSU_USER</span><span class="p">;</span><span class="w">     </span><span class="c1">//变成用户进程</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9" href="#__codelineno-68-9"></a><span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">ST0_EXL</span><span class="p">;</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10" href="#__codelineno-68-10"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11" href="#__codelineno-68-11"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argc</span><span class="p">;</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12" href="#__codelineno-68-12"></a><span class="w">    </span><span class="n">tf</span><span class="o">-&gt;</span><span class="n">tf_regs</span><span class="p">.</span><span class="n">reg_r</span><span class="p">[</span><span class="n">MIPS_REG_A1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">uargv</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ol>
<h6 id="调度"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#调度">调度</a></h6>
<p>执行完proc_init后，已经创建好了两个内核线程idle和init，并且当前执行的线程为proc_init。当ucore的所有初始化工作完成后，ucore执行kern_init的最后一个函数cpu_idle函数。cpu_idle会调用schedule让出CPU。</p>
<p>schedule具体的实现我们可以不关心。我们只需要知道sched_class_enqueue(proc)将一个进程放入运行队列run queue。next = sched_class_pick_next()从rq中找到下一个执行的进程。</p>
<p>当选定需要执行的进程后，proc_run函数将该进程载入CPU执行。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#__codelineno-69-1"></a><span class="kt">void</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#__codelineno-69-2"></a><span class="nf">cpu_idle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#__codelineno-69-3"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#__codelineno-69-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#__codelineno-69-5"></a><span class="w">            </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#__codelineno-69-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#__codelineno-69-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#__codelineno-69-8"></a><span class="p">}</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#__codelineno-69-9"></a>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#__codelineno-69-10"></a><span class="kt">void</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#__codelineno-69-11"></a><span class="nf">schedule</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#__codelineno-69-12"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">intr_flag</span><span class="p">;</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#__codelineno-69-13"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#__codelineno-69-14"></a><span class="w">    </span><span class="n">local_intr_save</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#__codelineno-69-15"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#__codelineno-69-16"></a><span class="w">        </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">need_resched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#__codelineno-69-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">PROC_RUNNABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18" href="#__codelineno-69-18"></a><span class="w">            </span><span class="n">sched_class_enqueue</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19" href="#__codelineno-69-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20" href="#__codelineno-69-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sched_class_pick_next</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21" href="#__codelineno-69-21"></a><span class="w">            </span><span class="n">sched_class_dequeue</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-69-22"><a id="__codelineno-69-22" name="__codelineno-69-22" href="#__codelineno-69-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-23"><a id="__codelineno-69-23" name="__codelineno-69-23" href="#__codelineno-69-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-24"><a id="__codelineno-69-24" name="__codelineno-69-24" href="#__codelineno-69-24"></a><span class="w">            </span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idleproc</span><span class="p">;</span>
</span><span id="__span-69-25"><a id="__codelineno-69-25" name="__codelineno-69-25" href="#__codelineno-69-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-26"><a id="__codelineno-69-26" name="__codelineno-69-26" href="#__codelineno-69-26"></a><span class="w">        </span><span class="n">next</span><span class="o">-&gt;</span><span class="n">runs</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-69-27"><a id="__codelineno-69-27" name="__codelineno-69-27" href="#__codelineno-69-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">next</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-28"><a id="__codelineno-69-28" name="__codelineno-69-28" href="#__codelineno-69-28"></a><span class="w">            </span><span class="c1">//kprintf(&quot;########################\n&quot;);</span>
</span><span id="__span-69-29"><a id="__codelineno-69-29" name="__codelineno-69-29" href="#__codelineno-69-29"></a><span class="w">            </span><span class="c1">//kprintf(&quot;c %d TO %d\n&quot;, current-&gt;pid, next-&gt;pid);</span>
</span><span id="__span-69-30"><a id="__codelineno-69-30" name="__codelineno-69-30" href="#__codelineno-69-30"></a><span class="w">            </span><span class="c1">//print_trapframe(next-&gt;tf);</span>
</span><span id="__span-69-31"><a id="__codelineno-69-31" name="__codelineno-69-31" href="#__codelineno-69-31"></a><span class="w">            </span><span class="c1">//kprintf(&quot;@@@@@@@@@@@@@@@@@@@@@@@@\n&quot;);</span>
</span><span id="__span-69-32"><a id="__codelineno-69-32" name="__codelineno-69-32" href="#__codelineno-69-32"></a><span class="w">            </span><span class="n">proc_run</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
</span><span id="__span-69-33"><a id="__codelineno-69-33" name="__codelineno-69-33" href="#__codelineno-69-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-34"><a id="__codelineno-69-34" name="__codelineno-69-34" href="#__codelineno-69-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-69-35"><a id="__codelineno-69-35" name="__codelineno-69-35" href="#__codelineno-69-35"></a><span class="w">    </span><span class="n">local_intr_restore</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-69-36"><a id="__codelineno-69-36" name="__codelineno-69-36" href="#__codelineno-69-36"></a><span class="p">}</span>
</span><span id="__span-69-37"><a id="__codelineno-69-37" name="__codelineno-69-37" href="#__codelineno-69-37"></a>
</span><span id="__span-69-38"><a id="__codelineno-69-38" name="__codelineno-69-38" href="#__codelineno-69-38"></a><span class="kt">void</span>
</span><span id="__span-69-39"><a id="__codelineno-69-39" name="__codelineno-69-39" href="#__codelineno-69-39"></a><span class="nf">proc_run</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-40"><a id="__codelineno-69-40" name="__codelineno-69-40" href="#__codelineno-69-40"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-41"><a id="__codelineno-69-41" name="__codelineno-69-41" href="#__codelineno-69-41"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">intr_flag</span><span class="p">;</span>
</span><span id="__span-69-42"><a id="__codelineno-69-42" name="__codelineno-69-42" href="#__codelineno-69-42"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_struct</span><span class="w"> </span><span class="o">*</span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-69-43"><a id="__codelineno-69-43" name="__codelineno-69-43" href="#__codelineno-69-43"></a><span class="w">        </span><span class="n">local_intr_save</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-69-44"><a id="__codelineno-69-44" name="__codelineno-69-44" href="#__codelineno-69-44"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-69-45"><a id="__codelineno-69-45" name="__codelineno-69-45" href="#__codelineno-69-45"></a><span class="w">          </span><span class="c1">//panic(&quot;unimpl&quot;);</span>
</span><span id="__span-69-46"><a id="__codelineno-69-46" name="__codelineno-69-46" href="#__codelineno-69-46"></a><span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-69-47"><a id="__codelineno-69-47" name="__codelineno-69-47" href="#__codelineno-69-47"></a><span class="w">            </span><span class="c1">//load_sp(next-&gt;kstack + KSTACKSIZE);</span>
</span><span id="__span-69-48"><a id="__codelineno-69-48" name="__codelineno-69-48" href="#__codelineno-69-48"></a><span class="w">            </span><span class="n">lcr3</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">cr3</span><span class="p">);</span>
</span><span id="__span-69-49"><a id="__codelineno-69-49" name="__codelineno-69-49" href="#__codelineno-69-49"></a><span class="w">            </span><span class="n">tlb_invalidate_all</span><span class="p">();</span><span class="w">       </span><span class="c1">//标注一下这里的tlb清空，待优化</span>
</span><span id="__span-69-50"><a id="__codelineno-69-50" name="__codelineno-69-50" href="#__codelineno-69-50"></a><span class="w">            </span><span class="n">switch_to</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">));</span>
</span><span id="__span-69-51"><a id="__codelineno-69-51" name="__codelineno-69-51" href="#__codelineno-69-51"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-69-52"><a id="__codelineno-69-52" name="__codelineno-69-52" href="#__codelineno-69-52"></a><span class="w">        </span><span class="n">local_intr_restore</span><span class="p">(</span><span class="n">intr_flag</span><span class="p">);</span>
</span><span id="__span-69-53"><a id="__codelineno-69-53" name="__codelineno-69-53" href="#__codelineno-69-53"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-69-54"><a id="__codelineno-69-54" name="__codelineno-69-54" href="#__codelineno-69-54"></a><span class="p">}</span>
</span></code></pre></div>
<p>proc_run会调用switch_to，switch_to会：</p>
<ol>
<li>将当前的context存储在prev-&gt;context中。（注意，context只包含s0-s8, sp, gp, ra）</li>
<li>恢复next-&gt;context</li>
<li>执行<code>j ra</code></li>
</ol>
<h6 id="init进程执行过程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#init进程执行过程">init进程执行过程</a></h6>
<p>通过kernel_thread(init_main, NULL, 0)创建init进程后</p>
<ol>
<li>
<p>cpu_idle中（idle进程中），执行schedule()，此时只有idle和init两个进程，因此调度到init进程执行proc_run。</p>
</li>
<li>
<p>执行switch_to，kernel_thread设置了context中的sp, ra。执行jr ra后，跳转到forkret</p>
</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#__codelineno-70-1"></a><span class="c1">// forkret -- the first kernel entry point of a new thread/process</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#__codelineno-70-2"></a><span class="c1">// NOTE: the addr of forkret is setted in copy_thread function</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#__codelineno-70-3"></a><span class="c1">//       after switch_to, the current proc will execute here.</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#__codelineno-70-4"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#__codelineno-70-5"></a><span class="nf">forkret</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#__codelineno-70-6"></a><span class="w">    </span><span class="n">forkrets</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">tf</span><span class="p">);</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#__codelineno-70-7"></a><span class="p">}</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#__codelineno-70-8"></a>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#__codelineno-70-9"></a><span class="nl">forkrets</span><span class="p">:</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#__codelineno-70-10"></a><span class="w">  </span><span class="n">addiu</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">a0</span><span class="p">,</span><span class="w"> </span><span class="mi">-16</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#__codelineno-70-11"></a><span class="w">  </span><span class="n">b</span><span class="w"> </span><span class="n">exception_return</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#__codelineno-70-12"></a><span class="w">  </span><span class="n">nop</span>
</span></code></pre></div>
<ol>
<li>
<p>forkrets-&gt;exception_return从中断返回，弹出中断帧tf。CPU便会进入kernel_thread_entry，并以tf中指定的寄存器值执行</p>
</li>
<li>
<p>kernel_thread_entry跳转执行$a1即init_main</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#__codelineno-71-1"></a>//kern/proc/entry.S
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#__codelineno-71-2"></a>kernel_thread_entry:        # void kernel_thread(void)
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3" href="#__codelineno-71-3"></a>  addiu $sp, $sp, -16
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4" href="#__codelineno-71-4"></a>  jal $a1
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5" href="#__codelineno-71-5"></a>  nop
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6" href="#__codelineno-71-6"></a>  move $a0, $v0
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7" href="#__codelineno-71-7"></a>  la  $t0, do_exit
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8" href="#__codelineno-71-8"></a>  jal $t0 
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9" href="#__codelineno-71-9"></a>  nop
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10" href="#__codelineno-71-10"></a>  /* never here */
</span></code></pre></div>
<h6 id="user_main的执行过程"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#user_main的执行过程">user_main的执行过程</a></h6>
<ol>
<li>在init_main中，创建了user_main线程。然后init_main执行do_wait</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#__codelineno-72-1"></a><span class="c1">// init_main - the second kernel thread used to create user_main kernel threads</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2" href="#__codelineno-72-2"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3" href="#__codelineno-72-3"></a><span class="nf">init_main</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4" href="#__codelineno-72-4"></a><span class="w"> </span><span class="p">...</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5" href="#__codelineno-72-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel_thread</span><span class="p">(</span><span class="n">user_main</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6" href="#__codelineno-72-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7" href="#__codelineno-72-7"></a><span class="w">        </span><span class="n">panic</span><span class="p">(</span><span class="s">&quot;create user_main failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8" href="#__codelineno-72-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9" href="#__codelineno-72-9"></a>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10" href="#__codelineno-72-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">do_wait</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11" href="#__codelineno-72-11"></a><span class="w">        </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12" href="#__codelineno-72-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13" href="#__codelineno-72-13"></a>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14" href="#__codelineno-72-14"></a><span class="w">    </span><span class="n">fs_cleanup</span><span class="p">();</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15" href="#__codelineno-72-15"></a><span class="w">    </span><span class="n">kprintf</span><span class="p">(</span><span class="s">&quot;all user-mode processes have quit.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16" href="#__codelineno-72-16"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17" href="#__codelineno-72-17"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>do_wait的作用是等待指定的或者任意一个（传入的pid为0）子线程进入ZOMBIE状态，释放子进程的内核栈空间和PCB空间。否则，自己进入睡眠状态SLEEPING，然后调用schedule()。</li>
</ol>
<div class="language-c highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#__codelineno-73-1"></a><span class="c1">// do_wait - wait one OR any children with PROC_ZOMBIE state, and free memory space of kernel stack</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#__codelineno-73-2"></a><span class="c1">//         - proc struct of this child.</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#__codelineno-73-3"></a><span class="c1">// NOTE: only after do_wait function, all resources of the child proces are free.</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#__codelineno-73-4"></a><span class="kt">int</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#__codelineno-73-5"></a><span class="n">do_wait</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">code_store</span><span class="p">)</span>
</span></code></pre></div>
<ol>
<li>
<p>schedule调用到user_main线程。和init一样，执行到user_main函数。</p>
</li>
<li>
<p>user_main函数调用了kernel_execv函数，实质为一次SYS_exec系统调用。</p>
</li>
<li>
<p>最后重新分配内核和用户空间，加载了sh用户程序。user_main线程从内核线程变为用户线程。</p>
</li>
<li>
<p>用户进程链接脚本user.ld指定了ENTRY(_start)。_start在user/libs/initcode.S中定义。</p>
</li>
</ol>
<div class="language-text highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#__codelineno-74-1"></a>_start:
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#__codelineno-74-2"></a>    nop
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#__codelineno-74-3"></a>    la $gp, _gp
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#__codelineno-74-4"></a>    addiu $sp, $sp, -16
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#__codelineno-74-5"></a>    jal umain
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#__codelineno-74-6"></a>    nop
</span></code></pre></div>
<p>umain在user/libs/umain.c中定义</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#__codelineno-75-1"></a><span class="kt">void</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#__codelineno-75-2"></a><span class="nf">umain</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3" href="#__codelineno-75-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">;</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4" href="#__codelineno-75-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initfd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stdin:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_RDONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5" href="#__codelineno-75-5"></a><span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;open &lt;stdin&gt; failed: %e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6" href="#__codelineno-75-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7" href="#__codelineno-75-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initfd</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;stdout:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8" href="#__codelineno-75-8"></a><span class="w">        </span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;open &lt;stdout&gt; failed: %e.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">);</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9" href="#__codelineno-75-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10" href="#__codelineno-75-10"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11" href="#__codelineno-75-11"></a><span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12" href="#__codelineno-75-12"></a><span class="p">}</span>
</span></code></pre></div>
<h5 id="ide_init--fs_init"><a class="toclink" href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/#ide_init--fs_init">ide_init &amp; fs_init</a></h5>
    <nav class="md-post__action">
      <a href="../../%E8%AF%BE%E7%A8%8B/2021/04/06/2021-04-06-ucore-mips-%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-02-08 12:02:35">2021年2月8日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E6%8A%98%E8%85%BE/" class="md-meta__link">折腾</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 3 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="更新固态之旅"><a class="toclink" href="../../%E6%8A%98%E8%85%BE/2021/02/08/2021-02-08-%E6%9B%B4%E6%96%B0%E5%9B%BA%E6%80%81%E4%B9%8B%E6%97%85/">更新固态之旅</a></h2>
<p>我姐的电脑是15-16年买的，型号为Acer Aspire V15 Nitro Black Edition(暗影骑士2，精确型号为Aspire VN7-592G-58NG)，<a href="http://detail.zol.com.cn/notebook/index1102903.shtml">ZOL</a>上的商品信息</p>
<p>不得不说这台电脑确实是非常厉害了，有以下这些亮眼的地方。</p>
<ul>
<li>i5-6300HQ。HQ表示标压-四核。</li>
<li>NIVIDIA的GTX960M独立显卡。（当时的中端主流显卡）</li>
</ul>
<p>下面这些即使是现在也是完全够用的，特别是那个支持2x2 MU-MIMO的无线网卡。</p>
<ul>
<li>Realtek 8168/8111 <strong>千兆</strong>以太网卡。</li>
<li>Qualcommm Atheros NFA344A 无线网卡。（<strong>支持2x2 MU-MIMO</strong>，Wifi4, Wifi5）https://oemdrivers.com/network-qualcomm-atheros-qca61x4a-wireless</li>
<li>1个USB 2.0， <strong>2个</strong>USB 3.0，1个<strong>Thunderbolt 3</strong>接口。s</li>
</ul>
<p>而不仅限于此，这台电脑的扩展性是真的非常不错。</p>
<ul>
<li>2条内存条插槽。支持最大32G（原装了一条海力士的4GB DDR4 2133MHz 内存条）</li>
<li>一个m.2插槽，<strong>支持NVMe协议</strong>（PCIe Gen3x4，最高4GB/s）。</li>
</ul>
<p>下面是发现这台电脑支持NVMe协议的固态的曲折过程：</p>
<p>在阅读之前，需要以下知识：</p>
<ul>
<li>m.2接口（也叫NGFF(Next Generation Form Factor)）</li>
<li>NVMe</li>
</ul>

    <nav class="md-post__action">
      <a href="../../%E6%8A%98%E8%85%BE/2021/02/08/2021-02-08-%E6%9B%B4%E6%96%B0%E5%9B%BA%E6%80%81%E4%B9%8B%E6%97%85/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2021-01-01 00:00:00">2021年1月1日</time></li>
        
          <li class="md-meta__item">
            分类于
            
              <a href="../../category/%E9%98%85%E8%AF%BB/" class="md-meta__link">阅读</a></li>
        
        
          
          <li class="md-meta__item">
            
              需要 4 分钟阅读时间
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="linux内核设计与实现阅读"><a class="toclink" href="../../%E9%98%85%E8%AF%BB/2021/01/01/2021-01-01-linux%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB/">linux内核设计与实现阅读</a></h2>
<p>linux内核设计与实现（原书第3版）, Robert Love</p>
<ul>
<li>
<p>一个内核由：负责响应中断的中断服务程序，负责多个程序分享处理器时间的进程调度程序，负责管理进程地址空间的内存管理程序和网络、进程间通信等系统服务程序组成。</p>
</li>
<li>
<p>应用程序通过系统调用访问内核，内核运行于进程上下文中。（不同进程运行同样的内核代码，上下文不同，因此有不同效果）</p>
</li>
<li>
<p>对于中断来说，内核运行于中断上下文</p>
</li>
<li>
<p>单内核和微内核。linux汲取了微内核的优点：linux是模块化的，多线程的以及内核本身可调度的。</p>
</li>
<li>
<p>inline函数必须用static修饰，涉及到编译，因为inline的含义有点像宏。而如果不用static修饰，那么其他文件的函数也可以调用它，那么就会导致不得不建立一个符号表项。因此声明为static实现起来更简单。</p>
</li>
<li>
<p>内核使用的C语言用到了ISO99和GUN C扩展特性，其中几个用的比较广的GUN C扩展特性</p>
</li>
<li>内联函数</li>
<li>内联汇编</li>
</ul>

    <nav class="md-post__action">
      <a href="../../%E9%98%85%E8%AF%BB/2021/01/01/2021-01-01-linux%E5%86%85%E6%A0%B8%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E9%98%85%E8%AF%BB/">
        继续阅读
      </a>
    </nav>
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../2022/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 2022">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                2022
              </div>
            </div>
          </a>
        
        
          
          <a href="../2020/" class="md-footer__link md-footer__link--next" aria-label="下一页: 2020">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                2020
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/TheRainstorm" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.footer", "content.code.copy", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>